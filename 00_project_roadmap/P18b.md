# P18b: Similarity Search - Service & API

## 1. Objective

**What**: Build search service with validation and monitoring, plus REST API endpoint.

**Why**: The search service orchestrates query embedding, vector search, and filtering. The API exposes search to the chat pipeline and admin UI.

**Scope**:
- Included: Similarity search service, search metrics, search API endpoint, router wiring
- Excluded: Foundation (P18a), chat pipeline integration

**Dependencies**: P18a (config, repository, cache), P17 (embedding client)

---

## 2. Implementation Tasks

### Task 18b.1: Create Similarity Search Service

- [ ] Create search service with validation and monitoring (2 files, ~130 LOC)
  - **Tests**: `tests/unit/test_similarity_service.py`
    - `test_search_returns_results()` - returns similar QA pairs
    - `test_search_generates_query_embedding()` - embeds query text
    - `test_search_uses_cache()` - cache hit avoids API call
    - `test_search_respects_top_k()` - limits results
    - `test_search_applies_threshold()` - filters low scores
    - `test_search_threshold_filters_all()` - returns empty if none pass
    - `test_search_only_active_qa()` - excludes draft/archived
    - `test_search_filter_by_category()` - category filter works
    - `test_search_filter_by_tags()` - tag filter works
    - `test_search_empty_query_rejected()` - raises ValueError
    - `test_search_query_max_length_validated()` - rejects > 8000 chars
    - `test_search_no_embeddings()` - returns empty gracefully
  - **Files**: `backend/services/similarity_service.py`, `backend/services/__init__.py`
  - **Implementation**:
    ```python
    @dataclass
    class SearchResult:
        qa_pair_id: UUID
        question: str
        answer: str
        category: Optional[str]
        tags: List[str]
        status: QAStatus
        similarity_score: float
        created_at: datetime

    @dataclass
    class SearchMetrics:
        query_embedding_ms: float
        vector_search_ms: float
        total_ms: float
        result_count: int
        cache_hit: bool

    class SimilarityService:
        async def search(
            self,
            query: str,
            top_k: int = 5,
            threshold: Optional[float] = None,
            category: Optional[str] = None,
            tags: Optional[List[str]] = None
        ) -> Tuple[List[SearchResult], SearchMetrics]:
            """Search for QA pairs similar to query text."""
    ```

### Task 18b.2: Create Search API Endpoint

- [ ] Create REST endpoint with validation (2 files, ~90 LOC)
  - **Tests**: `tests/integration/test_api_search.py`
    - `test_search_returns_results()` - 200 with matches
    - `test_search_empty_results()` - 200 with empty list
    - `test_search_validates_query_not_empty()` - 422 on empty query
    - `test_search_validates_query_length()` - 422 on > 8000 chars
    - `test_search_validates_top_k()` - 422 on invalid top_k
    - `test_search_validates_threshold()` - 422 on out-of-range
    - `test_search_filter_category()` - category filter in request
    - `test_search_filter_tags()` - tags filter in request
    - `test_search_requires_auth()` - 401 without token
    - `test_search_response_includes_metrics()` - latency info returned
  - **Files**: `backend/api/routes/search.py`, `backend/schemas/search.py`
  - **Schemas**:
    ```python
    class SearchRequest(BaseModel):
        query: str = Field(..., min_length=1, max_length=8000)
        top_k: int = Field(default=5, ge=1, le=20)
        threshold: Optional[float] = Field(default=None, ge=0.0, le=1.0)
        category: Optional[str] = None
        tags: Optional[List[str]] = None

    class SearchResponse(BaseModel):
        results: List[SearchResultResponse]
        query: str
        total_results: int
        metrics: SearchMetricsResponse
    ```
  - **Endpoint**: `POST /qa/search`

### Task 18b.3: Wire Search Router

- [ ] Register search router with auth (2 files, ~20 LOC)
  - **Tests**: `tests/integration/test_api_search.py` (covered above)
  - **Files**: `backend/api/routes/__init__.py`, `backend/main.py`
  - **Implementation**:
    ```python
    @router.post(
        "/search",
        response_model=SearchResponse,
        summary="Search QA pairs",
        description="Find QA pairs semantically similar to query text.",
        responses={401: {"model": ErrorResponse}, 422: {"model": ErrorResponse}}
    )
    async def search_qa_pairs(request: SearchRequest, ...):
        ...
    ```

---

## 3. Success Criteria

- [ ] Search returns semantically similar QA pairs
- [ ] Results ordered by similarity (highest first)
- [ ] Results include similarity scores and metadata
- [ ] Threshold filters out low-confidence matches
- [ ] Query length validated (max 8000 chars)
- [ ] Search latency tracked and returned in response
- [ ] Search endpoint requires authentication
- [ ] All tests pass: `pytest tests/unit/test_similarity_service.py tests/integration/test_api_search.py -v`
- [ ] Coverage â‰¥80% for search service
