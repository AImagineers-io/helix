# P88: Improvement Plan for P85.md (Integration Wiring)

## What's Weak / Missing

- **No application lifecycle management**: Startup/shutdown hooks not defined. Services like Redis, DB connections, and background tasks need explicit startup verification and graceful shutdown handling.

- **Missing configuration validation gate**: No step to validate environment configuration before wiring begins. Invalid config will cause cryptic failures during dependency injection.

- **Health check aggregation absent**: Individual health checks exist but no composite `/health` endpoint that reports status of all dependencies (DB, Redis, LLM providers).

- **No circular dependency detection**: Task mentions "no circular dependency errors" as success criteria but provides no test or detection mechanism.

- **Redis connection wiring not mentioned**: Redis is critical for caching and conversation memory. Its connection setup, pool configuration, and failure handling are not in scope.

- **Logging configuration missing**: No structured logging setup, log levels, or correlation ID propagation for request tracing.

- **Environment-specific behavior undefined**: No handling for dev vs staging vs production configurations (debug mode, mock services, real LLM calls).

- **OpenAPI schema validation untested**: Success criteria mentions "accessible via /docs" but doesn't validate schema correctness or response model accuracy.

- **Task dependency notation ambiguous**: References like "P85.1" are unclear since tasks aren't numbered explicitly in the markdown.

## Why This Matters

Integration is the highest-risk phase. Components that work in isolation frequently fail when combined due to:
- Missing dependencies that were mocked in unit tests
- Configuration mismatches between services
- Lifecycle timing issues (service A calls service B before B is ready)
- Connection pool exhaustion under real load

Failing to validate integration properly means bugs surface in production, not in testing.

## Proposed Improvements

### Add: Lifecycle Management Task

```markdown
- [ ] Application lifecycle hooks (2 files, ~80 LOC)
  - Tests: tests/integration/test_app_lifecycle.py
  - Files: core/lifespan.py, api/main.py
  - Implement: startup verification (DB, Redis, LLM health), graceful shutdown
  - Verify: All connections closed on shutdown, no orphaned tasks
  - Depends on: Router registration complete
```

### Add: Configuration Validation Task

```markdown
- [ ] Configuration validation gate (2 files, ~60 LOC)
  - Tests: tests/integration/test_config_validation.py
  - Files: core/config.py, core/validators.py
  - Validate: All required env vars present, formats correct (URLs, API keys)
  - Fail fast: Application refuses to start with invalid config
  - Depends on: None (run first)
```

### Add: Composite Health Check Task

```markdown
- [ ] Composite health endpoint (2 files, ~70 LOC)
  - Tests: tests/integration/test_composite_health.py
  - Files: api/routes/health.py, core/health_checks.py
  - Report: DB connection, Redis connection, LLM provider status, pgvector availability
  - Format: JSON with per-component status and overall healthy/unhealthy
  - Depends on: Service DI complete
```

### Add: Redis Wiring Task

```markdown
- [ ] Redis connection wiring (2 files, ~50 LOC)
  - Tests: tests/integration/test_redis_wiring.py
  - Files: core/redis.py, core/dependencies.py
  - Configure: Connection pool size, timeout, reconnection strategy
  - Verify: Cache operations functional, memory operations functional
  - Depends on: Configuration validation
```

### Add: Logging Configuration Task

```markdown
- [ ] Structured logging setup (2 files, ~60 LOC)
  - Tests: tests/integration/test_logging_config.py
  - Files: core/logging.py, api/middleware/request_id.py
  - Implement: JSON logging, request correlation IDs, log levels per environment
  - Depends on: Configuration validation
```

### Modify: Clarify Task Dependencies

Replace ambiguous "P85.1" references with explicit task names:

```markdown
- Depends on: "Router registration" (not P85.1)
- Depends on: "Alembic migration generation" (not P85.4)
```

### Add: Success Criteria

```markdown
- [ ] Application starts successfully with valid config, fails fast with invalid
- [ ] Composite health endpoint reports all dependencies
- [ ] Shutdown completes within 10 seconds with no connection leaks
- [ ] All requests include correlation ID in logs
- [ ] Redis operations (cache set/get, memory store) function correctly
```

## Impact on Roadmap

1. **P86 (System Validation)** can now validate lifecycle behavior under failure conditions
2. **P87 (Launch Preparation)** has a working health endpoint to document and monitor
3. Configuration validation failure modes become testable error scenarios
4. Logging infrastructure enables meaningful troubleshooting documentation in P87
