# P49c: Chat Widget - Branding & Message Handling

## 1. Objective

**What**: Fetch branding from the existing Branding API and integrate with Chat API for message exchange.

**Why**: Server-driven branding enables same widget code for all clients without rebuilds. Chat API integration provides the actual chatbot functionality.

**Scope**:
- Included: Branding fetch, branding application, Chat API client, message state management
- Excluded: Message persistence (P49d), standalone page (P49d), backend endpoints (existing)

**Dependencies**: P49b (UI components), Existing Branding API (`/branding`), Existing Chat API (`/chat`)

---

## 2. Implementation Tasks

### Task 49c.1: Create Branding Service

- [ ] Fetch and cache branding configuration (2 files, ~80 LOC)
  - **Tests**: `frontend/tests/widget/services/BrandingService.test.ts`
    - `test_fetches_branding_on_init()` - calls /branding endpoint
    - `test_caches_branding_response()` - no duplicate fetches
    - `test_applies_primary_color_to_bubble()` - CSS variable set
    - `test_applies_bot_name_to_header()` - header text updated
    - `test_shows_logo_if_configured()` - logo rendered
    - `test_uses_defaults_on_fetch_error()` - graceful fallback
  - **Files**:
    - `frontend/src/widget/services/BrandingService.ts`
    - `frontend/src/widget/types/branding.ts`

### Task 49c.2: Create Chat API Client

- [ ] Send messages and handle responses (2 files, ~100 LOC)
  - **Tests**: `frontend/tests/widget/services/ChatClient.test.ts`
    - `test_sends_message_with_device_id()` - includes device identifier
    - `test_sends_conversation_id_if_exists()` - maintains conversation
    - `test_returns_bot_response()` - parses response correctly
    - `test_handles_network_error()` - graceful error handling
    - `test_handles_rate_limit()` - shows user-friendly message
    - `test_timeout_after_30_seconds()` - doesn't hang forever
  - **Files**:
    - `frontend/src/widget/services/ChatClient.ts`
    - `frontend/src/widget/types/chat.ts`
  - **Request**:
    ```typescript
    interface ChatRequest {
      message: string;
      device_id: string;
      conversation_id?: string;
    }
    ```

### Task 49c.3: Create Device ID Manager

- [ ] Generate and persist unique device identifier (1 file, ~50 LOC)
  - **Tests**: `frontend/tests/widget/services/DeviceManager.test.ts`
    - `test_generates_uuid_on_first_use()` - creates new ID
    - `test_persists_device_id_in_localstorage()` - survives reload
    - `test_reuses_existing_device_id()` - consistent identity
    - `test_handles_localstorage_unavailable()` - private browsing
  - **Files**:
    - `frontend/src/widget/services/DeviceManager.ts`

### Task 49c.4: Create Message State Manager

- [ ] Manage conversation state and optimistic updates (2 files, ~120 LOC)
  - **Tests**: `frontend/tests/widget/services/MessageState.test.ts`
    - `test_adds_user_message_immediately()` - optimistic UI
    - `test_shows_typing_indicator_while_waiting()` - loading state
    - `test_adds_bot_response_when_received()` - updates state
    - `test_marks_message_failed_on_error()` - error state
    - `test_tracks_conversation_id_from_response()` - maintains session
    - `test_notifies_listeners_on_change()` - observer pattern
  - **Files**:
    - `frontend/src/widget/state/MessageState.ts`
    - `frontend/src/widget/state/types.ts`

### Task 49c.5: Wire Components to Services

- [ ] Connect UI components to state and services (1 file, ~80 LOC)
  - **Tests**: `frontend/tests/widget/integration/widget-flow.test.ts`
    - `test_user_types_and_sends_message()` - end-to-end flow
    - `test_message_appears_in_list()` - state reflected in UI
    - `test_typing_indicator_shows_during_request()` - loading UX
    - `test_bot_response_displayed()` - complete round-trip
    - `test_error_message_shown_on_failure()` - error UX
  - **Files**:
    - `frontend/src/widget/core/WidgetController.ts`

---

## 3. Success Criteria

- [ ] Branding loads and applies on widget init
- [ ] Messages sent to Chat API with device_id
- [ ] Conversation maintained across messages
- [ ] Typing indicator visible during API call
- [ ] Errors displayed as user-friendly messages
- [ ] All tests pass: `npm test -- widget/services widget/integration`
