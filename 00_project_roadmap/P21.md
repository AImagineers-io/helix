# P21: P14 Knowledge Base Models Improvements

## 1. Objective

**What**: Enhance P14 models with additional indexes, constraints, audit fields, and model validation.

**Why**: P14 establishes core models. Production needs optimized queries, data integrity constraints, and audit trails for compliance.

**Scope**:
- Included: Composite indexes, unique constraints, audit fields, model-level validation, HNSW index tuning parameters
- Excluded: Full audit logging system, model versioning

**Dependencies**: P14 (Knowledge Base Models)

---

## 2. Implementation Tasks

### Task 21.1: Add Composite Indexes for Common Queries

- [ ] Optimize common query patterns (1 file, ~30 LOC)
  - **Tests**: `tests/unit/test_model_indexes.py`
    - `test_status_deleted_at_composite_index()` - index exists
    - `test_category_status_composite_index()` - index exists
    - `test_query_uses_composite_index()` - EXPLAIN shows index scan
  - **Files**: `backend/models/qa_pair.py`
  - **Implementation**:
    ```python
    # Add to QAPair model
    __table_args__ = (
        Index('ix_qa_pair_status_deleted', 'status', 'deleted_at'),
        Index('ix_qa_pair_category_status', 'category', 'status'),
        Index('ix_qa_pair_created_status', 'created_at', 'status'),
    )
    ```

### Task 21.2: Add Unique Constraints

- [ ] Prevent duplicate embeddings per QA pair (1 file, ~20 LOC)
  - **Tests**: `tests/unit/test_model_constraints.py`
    - `test_one_embedding_per_qa_pair()` - constraint enforced
    - `test_duplicate_embedding_raises()` - IntegrityError on duplicate
    - `test_constraint_allows_replacement()` - update works
  - **Files**: `backend/models/embedding.py`
  - **Implementation**:
    ```python
    # Add unique constraint
    __table_args__ = (
        UniqueConstraint('qa_pair_id', name='uq_embedding_qa_pair'),
    )
    ```

### Task 21.3: Add Audit Fields

- [ ] Track who created/modified records (2 files, ~40 LOC)
  - **Tests**: `tests/unit/test_audit_fields.py`
    - `test_created_by_stored()` - captures user ID
    - `test_updated_by_stored()` - captures modifier ID
    - `test_audit_fields_nullable()` - works for system operations
  - **Files**: `backend/models/mixins.py`, `backend/models/qa_pair.py`
  - **Implementation**:
    ```python
    class AuditMixin:
        created_by: Mapped[Optional[UUID]] = mapped_column(nullable=True)
        updated_by: Mapped[Optional[UUID]] = mapped_column(nullable=True)
    ```

### Task 21.4: HNSW Index Tuning Parameters

- [ ] Make HNSW parameters configurable (1 file, ~30 LOC)
  - **Tests**: `tests/unit/test_hnsw_config.py`
    - `test_default_m_parameter()` - defaults to 16
    - `test_default_ef_construction()` - defaults to 64
    - `test_env_override_m()` - reads from HNSW_M
    - `test_env_override_ef()` - reads from HNSW_EF_CONSTRUCTION
  - **Files**: `backend/config/hnsw.py`
  - **Implementation**:
    ```python
    @dataclass
    class HNSWConfig:
        m: int = int(os.getenv("HNSW_M", "16"))  # Max connections per node
        ef_construction: int = int(os.getenv("HNSW_EF_CONSTRUCTION", "64"))  # Build-time search width

    # In migration:
    CREATE INDEX ix_embedding_vector ON embedding
    USING hnsw (vector vector_cosine_ops)
    WITH (m = {config.m}, ef_construction = {config.ef_construction});
    ```

### Task 21.5: Model-Level Validation

- [ ] Add SQLAlchemy validators for data integrity (1 file, ~40 LOC)
  - **Tests**: `tests/unit/test_model_validation.py`
    - `test_question_not_empty_on_model()` - validates at model level
    - `test_answer_not_empty_on_model()` - validates at model level
    - `test_status_enum_validated()` - rejects invalid status
    - `test_tags_must_be_list()` - type validation
  - **Files**: `backend/models/qa_pair.py`
  - **Implementation**:
    ```python
    @validates('question')
    def validate_question(self, key, value):
        if not value or not value.strip():
            raise ValueError("Question cannot be empty")
        return value.strip()

    @validates('tags')
    def validate_tags(self, key, value):
        if value is not None and not isinstance(value, list):
            raise ValueError("Tags must be a list")
        return value or []
    ```

---

## 3. Success Criteria

- [ ] Composite indexes exist and are used by common queries
- [ ] Unique constraint prevents duplicate embeddings
- [ ] Audit fields track created_by/updated_by
- [ ] HNSW parameters configurable via environment
- [ ] Model-level validation catches invalid data before DB
- [ ] All constraints work with existing P14 tests
- [ ] All tests pass: `pytest tests/unit/test_model_indexes.py tests/unit/test_model_constraints.py tests/unit/test_audit_fields.py tests/unit/test_hnsw_config.py tests/unit/test_model_validation.py -v`
