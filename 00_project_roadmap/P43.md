# P43: Chat API

## 1. Objective

**What**: Build the public-facing POST /chat endpoint with conversation persistence, Redis-based memory, and graceful error handling.

**Why**: This is the core API that clients integrate with. It ties together the chat pipeline (P27), conversation management, and memory to deliver chatbot functionality. Without this endpoint, the pipeline has no public interface.

**Scope**:
- Included: Conversation model, Message model, Redis memory, /chat endpoint, request validation, response formatting, error handling
- Excluded: Messenger webhook integration (uses this endpoint internally), streaming responses (future)

**Dependencies**: P27e (Chat Pipeline complete), P15b (QA Service), P12 archived (Sanitization patterns)

---

## 2. Implementation Tasks

### Task 43.1: Conversation Model

- [ ] Create Conversation SQLAlchemy model (2 files, ~60 LOC)
  - **Tests**: `tests/unit/test_models_conversation.py`
    - `test_conversation_has_device_id()` - required field
    - `test_conversation_has_platform()` - web/messenger/api enum
    - `test_conversation_has_timestamps()` - created_at, last_activity
    - `test_conversation_inherits_base()` - has id, created_at, updated_at
  - **Files**: `backend/models/conversation.py`, `backend/models/__init__.py`

### Task 43.2: Message Model

- [ ] Create Message SQLAlchemy model (2 files, ~70 LOC)
  - **Tests**: `tests/unit/test_models_message.py`
    - `test_message_has_role()` - user/assistant enum
    - `test_message_has_content()` - required text field
    - `test_message_links_conversation()` - foreign key works
    - `test_message_has_metadata()` - JSON field for intent, language, cost
    - `test_message_cascade_delete()` - deletes with conversation
  - **Files**: `backend/models/message.py`, `backend/models/__init__.py`

### Task 43.3: Conversation Memory (Redis)

- [ ] Implement Redis-based short-term conversation memory (2 files, ~100 LOC)
  - **Tests**: `tests/unit/test_conversation_memory.py`
    - `test_memory_stores_recent_messages()` - stores last N messages
    - `test_memory_retrieves_history()` - returns ordered list
    - `test_memory_expires_after_ttl()` - 30 minute TTL
    - `test_memory_handles_redis_down()` - graceful fallback to empty
    - `test_memory_syncs_to_db()` - persist on conversation end
  - **Files**: `backend/services/conversation_memory.py`, `backend/services/__init__.py`
  - **Config**: `CONVERSATION_MEMORY_SIZE=10`, `CONVERSATION_MEMORY_TTL=1800`

### Task 43.4: Conversation Service

- [ ] Create service for conversation lifecycle (2 files, ~80 LOC)
  - **Tests**: `tests/unit/test_conversation_service.py`
    - `test_create_conversation()` - creates with device_id and platform
    - `test_get_or_create_conversation()` - finds existing or creates
    - `test_add_message()` - appends message to conversation
    - `test_update_last_activity()` - updates timestamp on activity
  - **Files**: `backend/services/conversation_service.py`
  - **Depends on**: Task 43.1, Task 43.2

### Task 43.5: Chat Request Schema

- [ ] Define request/response schemas with validation (1 file, ~60 LOC)
  - **Tests**: `tests/unit/test_chat_schemas.py`
    - `test_request_requires_message()` - message is required
    - `test_request_requires_device_id()` - device_id is required
    - `test_request_conversation_id_optional()` - can continue existing
    - `test_request_validates_message_length()` - max 10,000 chars
    - `test_response_includes_message()` - response has answer
    - `test_response_includes_conversation_id()` - for continuity
    - `test_response_includes_metadata()` - sources, timing optional
  - **Files**: `backend/schemas/chat.py`

### Task 43.6: Chat Endpoint

- [ ] Create POST /chat endpoint (2 files, ~120 LOC)
  - **Tests**: `tests/integration/test_chat_endpoint.py`
    - `test_chat_returns_response()` - happy path
    - `test_chat_creates_conversation()` - new conversation
    - `test_chat_continues_conversation()` - existing conversation_id
    - `test_chat_validates_input()` - rejects invalid request
    - `test_chat_sanitizes_message()` - XSS/injection blocked
    - `test_chat_respects_rate_limit()` - 60 req/min per device
  - **Files**: `backend/api/routers/chat.py`, `backend/api/__init__.py`
  - **Depends on**: Task 43.3, Task 43.4, Task 43.5

### Task 43.7: Error Handling

- [ ] Implement graceful error responses (1 file, ~50 LOC)
  - **Tests**: `tests/integration/test_chat_errors.py`
    - `test_timeout_returns_friendly_message()` - "I'm taking longer..."
    - `test_llm_failure_returns_friendly_message()` - "I'm having trouble..."
    - `test_rate_limit_returns_retry_after()` - 429 with header
    - `test_internal_errors_logged()` - full error logged server-side
    - `test_user_never_sees_stack_trace()` - clean error to client
  - **Files**: `backend/api/routers/chat.py` (extend)
  - **Depends on**: Task 43.6

### Task 43.8: Database Migration

- [ ] Create migration for Conversation and Message tables (1 file, ~60 LOC)
  - **Tests**: `tests/integration/test_migrations.py`
    - `test_conversation_table_created()` - table exists
    - `test_message_table_created()` - table exists
    - `test_message_conversation_fk()` - foreign key works
    - `test_indexes_created()` - device_id, conversation_id indexed
  - **Files**: `backend/alembic/versions/xxxx_create_chat_tables.py`
  - **Depends on**: Task 43.1, Task 43.2

---

## 3. Success Criteria

- [ ] POST /chat accepts `{message, device_id, conversation_id?}` and returns response
- [ ] New conversations created automatically when no conversation_id provided
- [ ] Existing conversations continued when valid conversation_id provided
- [ ] Conversation history loaded from Redis memory for pipeline context
- [ ] Messages persisted to database for audit trail
- [ ] Rate limiting enforced: 60 requests/minute per device_id
- [ ] Input sanitized: XSS, injection patterns blocked
- [ ] Message length validated: max 10,000 characters
- [ ] Errors return user-friendly messages, never stack traces
- [ ] All tests pass: `pytest tests/unit/test_*conversation*.py tests/unit/test_*chat*.py tests/integration/test_chat*.py -v`
- [ ] Coverage â‰¥80% for new code
