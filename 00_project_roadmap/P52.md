# P49d: Chat Widget - Persistence & Standalone Page

## 1. Objective

**What**: Store conversation history in localStorage and create a full-page chat interface at `/widget/standalone`.

**Why**: Persistence prevents users from losing context on page navigation. Standalone page enables QR codes, kiosk displays, and direct links.

**Scope**:
- Included: LocalStorage persistence, history loading, standalone HTML page, mobile-responsive layout
- Excluded: Backend configuration endpoint (P49e), widget tests (P49e)

**Dependencies**: P49c (message state, chat client)

---

## 2. Implementation Tasks

### Task 49d.1: Create Persistence Service

- [ ] Store and retrieve conversation history (1 file, ~80 LOC)
  - **Tests**: `frontend/tests/widget/services/PersistenceService.test.ts`
    - `test_saves_messages_to_localstorage()` - serializes state
    - `test_loads_messages_on_init()` - restores conversation
    - `test_limits_stored_messages_to_50()` - prevents bloat
    - `test_handles_localstorage_full()` - graceful degradation
    - `test_handles_localstorage_unavailable()` - private browsing
    - `test_clears_history_on_demand()` - privacy feature
  - **Files**:
    - `frontend/src/widget/services/PersistenceService.ts`
  - **Storage Key**: `helix_chat_{tenant_id}`
  - **Schema**:
    ```typescript
    interface StoredState {
      messages: Message[];
      conversation_id: string | null;
      last_updated: number;
    }
    ```

### Task 49d.2: Integrate Persistence with Message State

- [ ] Load history on init, save on message change (1 file, ~40 LOC)
  - **Tests**: `frontend/tests/widget/integration/persistence-flow.test.ts`
    - `test_loads_existing_conversation_on_init()` - restores history
    - `test_saves_after_each_message()` - auto-persist
    - `test_displays_loaded_messages_in_ui()` - shows history
    - `test_continues_existing_conversation_id()` - maintains session
  - **Files**:
    - `frontend/src/widget/state/MessageState.ts` (extend)

### Task 49d.3: Create Standalone HTML Page

- [ ] Full-page chat interface served by backend (3 files, ~150 LOC)
  - **Tests**: `backend/tests/integration/test_widget_standalone.py`
    - `test_standalone_page_returns_html()` - 200 with HTML content
    - `test_standalone_includes_widget_script()` - widget.js embedded
    - `test_standalone_auto_initializes()` - no manual init needed
    - `test_standalone_mobile_responsive()` - viewport meta tag
  - **Files**:
    - `backend/api/routers/widget.py`
    - `backend/templates/widget_standalone.html`
    - `backend/api/main.py` (register router)
  - **Endpoint**: `GET /widget/standalone`

### Task 49d.4: Create Standalone Layout Styles

- [ ] Full-viewport chat layout for standalone mode (1 file, ~60 LOC)
  - **Tests**: `frontend/tests/widget/standalone.test.ts`
    - `test_standalone_mode_uses_full_viewport()` - 100vh layout
    - `test_standalone_hides_bubble()` - no toggle needed
    - `test_standalone_window_always_open()` - expanded state
    - `test_standalone_responsive_breakpoints()` - mobile-first
  - **Files**:
    - `frontend/src/widget/styles/standalone.ts`
  - **Init Option**: `HelixChat.init({ mode: 'standalone' })`

### Task 49d.5: Add Clear History Feature

- [ ] Allow users to clear conversation history (2 files, ~50 LOC)
  - **Tests**: `frontend/tests/widget/components/ClearHistoryButton.test.ts`
    - `test_clear_button_in_header_menu()` - accessible location
    - `test_clear_confirms_before_delete()` - prevents accidents
    - `test_clear_removes_all_messages()` - UI cleared
    - `test_clear_deletes_localstorage()` - persistence cleared
    - `test_clear_resets_conversation_id()` - new session
  - **Files**:
    - `frontend/src/widget/components/HeaderMenu.ts`
    - `frontend/src/widget/components/ClearHistoryButton.ts`

---

## 3. Success Criteria

- [ ] Conversation survives page refresh
- [ ] History limited to last 50 messages
- [ ] `/widget/standalone` serves full-page chat
- [ ] Standalone page mobile-responsive
- [ ] Clear history removes all stored data
- [ ] All tests pass: `npm test -- persistence && python helix.py test integration`
