# P7: Improvement Plan for P1.md

## What's Weak / Missing

- **No prompt type enumeration**: What types exist? (system_prompt, greeting, rejection, clarification). Undefined = inconsistent implementations.
- **Missing cache invalidation**: When a prompt is published, cached responses using old prompt are stale. No strategy defined.
- **No concurrency handling**: Two admins edit same prompt simultaneously. Last write wins? Optimistic locking? Silent conflict?
- **Missing prompt validation**: No length limits, no template variable validation (e.g., `{user_name}` must be valid).
- **No fallback behavior**: If DB prompt not found, what happens? Crash? Hardcoded fallback? Not defined.
- **Missing audit logging**: Who changed which prompt when? Critical for debugging production issues.
- **P2 preview mode has no backend**: P2 expects preview endpoint but P1 doesn't define it.
- **Task dependency error**: P1.7 depends on P1.6, but P1.6 depends on P1.3 (correct). However, task numbering doesn't match description order.

---

## Why This Matters

Prompt management is the core value proposition for white-labeling. Weak implementation here means:
- Production outages when prompts are misconfigured
- Support burden when admins can't debug issues
- Data corruption from concurrent edits
- Performance degradation from uncached prompt loads

---

## Proposed Improvements

### Add new task: P1.0 - Define Prompt Type Enum

- [ ] Create PromptType enum with known types (1 file, ~30 LOC)
  - Tests: tests/unit/test_prompt_types.py
  - Files: database/models.py (enum), core/constants.py
  - Types: SYSTEM_PROMPT, GREETING, FAREWELL, REJECTION, CLARIFICATION, HANDOFF
  - PromptTemplate.type field must be one of these
  - Depends on: None (new first task)

### Add new task: P1.2a - Prompt Validation Service

- [ ] Add validation for prompt content (1 file, ~60 LOC)
  - Tests: tests/unit/test_prompt_validation.py
  - Files: services/prompt_validator.py
  - Validate: max length (10,000 chars), valid template variables, no empty content
  - Returns validation errors before save
  - Depends on: P1.2

### Add new task: P1.3a - Optimistic Locking

- [ ] Add version field for concurrent edit detection (2 files, ~40 LOC)
  - Tests: tests/integration/test_prompt_concurrency.py
  - Files: database/models.py (add `edit_version`), api/routers/prompts.py
  - PUT request must include current version
  - 409 Conflict if version mismatch
  - Depends on: P1.3

### Add new task: P1.5a - Preview Endpoint

- [ ] Add prompt preview endpoint for P2 UI (1 file, ~50 LOC)
  - Tests: tests/integration/test_prompt_preview.py
  - Files: api/routers/prompts.py
  - POST /prompts/{id}/preview with sample context
  - Returns rendered prompt with variables substituted
  - Depends on: P1.5

### Add new task: P1.7a - Prompt Cache with Invalidation

- [ ] Cache active prompts with invalidation on publish (1 file, ~60 LOC)
  - Tests: tests/integration/test_prompt_cache.py
  - Files: services/prompt_service.py (extend)
  - Redis cache: `prompt:{type}` â†’ active version content
  - On publish: invalidate cache key
  - TTL: 1 hour (fallback if invalidation fails)
  - Depends on: P1.7

### Add new task: P1.8 - Audit Logging

- [ ] Log all prompt changes with user/timestamp (2 files, ~50 LOC)
  - Tests: tests/integration/test_prompt_audit.py
  - Files: database/models.py (PromptAuditLog), services/prompt_service.py
  - Log: prompt_id, action (create/update/publish/rollback), admin_key_hash, timestamp
  - Queryable via API for debugging
  - Depends on: P1.4

### Modify P1.7 - Add Fallback Behavior

- [ ] Define fallback when prompt not in DB
  - If DB prompt missing: log warning, use hardcoded default from constants
  - Never crash chat pipeline due to missing prompt
  - Add fallback test: test_prompt_fallback_on_missing.py

### Add to Success Criteria

- [ ] PromptTemplate.type must be valid enum value
- [ ] Concurrent edits return 409 Conflict
- [ ] Preview endpoint returns rendered prompt
- [ ] Active prompts cached in Redis
- [ ] Cache invalidated on publish (verify via test)
- [ ] Audit log records all changes
- [ ] Missing prompt uses fallback (never crashes)

---

## Impact on Roadmap

- **P2**: Preview mode now has backend endpoint (P1.5a)
- **P2**: Can show optimistic locking conflicts in UI
- **P3**: Audit log could be shown in dashboard (future enhancement)
- **P4**: Prompt type enum ensures consistent migration

Task numbering should be adjusted. Recommend renumbering tasks sequentially after adding new ones.
