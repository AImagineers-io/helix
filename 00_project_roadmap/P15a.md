# P15a: QA Service - Foundation

## 1. Objective

**What**: Build foundation utilities for QA service: exception hierarchy, input sanitization, and transaction handling.

**Why**: These utilities are prerequisites for the QA repository and service. Exceptions provide consistent error handling, sanitization ensures data quality, transactions ensure data integrity.

**Scope**:
- Included: Exception hierarchy, input sanitization utilities, transaction context manager
- Excluded: Repository (P15b), Service (P15b), API endpoints (P16)

**Dependencies**: P14 (QAPair model)

---

## 2. Implementation Tasks

### Task 15a.1: Create Exception Hierarchy

- [ ] Define QA service exceptions (1 file, ~50 LOC)
  - **Tests**: `tests/unit/test_exceptions.py`
    - `test_qa_not_found_has_id()` - stores missing ID
    - `test_validation_error_has_field()` - stores field name
    - `test_status_transition_has_from_to()` - stores both states
  - **Files**: `backend/exceptions/qa.py`
  - **Implementation**:
    ```python
    class QAServiceError(Exception):
        """Base exception for QA service."""

    class QAPairNotFoundError(QAServiceError):
        def __init__(self, qa_pair_id: UUID):
            self.qa_pair_id = qa_pair_id
            super().__init__(f"QA pair not found: {qa_pair_id}")

    class QAValidationError(QAServiceError):
        def __init__(self, field: str, message: str):
            self.field = field
            super().__init__(f"{field}: {message}")

    class InvalidStatusTransitionError(QAServiceError):
        def __init__(self, from_status: QAStatus, to_status: QAStatus):
            self.from_status = from_status
            self.to_status = to_status
            super().__init__(f"Cannot transition from {from_status} to {to_status}")
    ```

### Task 15a.2: Create Input Sanitization Utilities

- [ ] Create text sanitization module (1 file, ~50 LOC)
  - **Tests**: `tests/unit/test_sanitization.py`
    - `test_strips_leading_trailing_whitespace()` - " foo " → "foo"
    - `test_normalizes_internal_whitespace()` - "a  b" → "a b"
    - `test_strips_html_tags()` - "<b>foo</b>" → "foo"
    - `test_preserves_newlines_in_answer()` - multiline answers ok
    - `test_empty_after_sanitize_raises()` - "   " → validation error
  - **Files**: `backend/utils/sanitize.py`
  - **Implementation**:
    ```python
    def sanitize_question(text: str) -> str:
        """Sanitize question text: strip, normalize whitespace, remove HTML."""

    def sanitize_answer(text: str) -> str:
        """Sanitize answer text: strip, preserve newlines, remove HTML."""

    def validate_length(text: str, field: str, max_length: int) -> None:
        """Raise QAValidationError if text exceeds max_length."""
    ```

### Task 15a.3: Create Transaction Context Manager

- [ ] Implement unit of work pattern (1 file, ~40 LOC)
  - **Tests**: `tests/unit/test_transactions.py`
    - `test_transaction_commits_on_success()` - changes persisted
    - `test_transaction_rollbacks_on_error()` - changes reverted
    - `test_nested_transactions_use_savepoints()` - subtransactions work
  - **Files**: `backend/db/transaction.py`
  - **Implementation**:
    ```python
    @contextmanager
    def transaction(session: Session):
        try:
            yield session
            session.commit()
        except Exception:
            session.rollback()
            raise
    ```

---

## 3. Success Criteria

- [ ] Exception hierarchy captures context (ID, field, from/to status)
- [ ] Sanitization strips whitespace and HTML
- [ ] Sanitization preserves newlines in answers
- [ ] Validation rejects empty/too-long text
- [ ] Transaction commits on success, rollbacks on error
- [ ] Nested transactions use savepoints
- [ ] All tests pass: `pytest tests/unit/test_exceptions.py tests/unit/test_sanitization.py tests/unit/test_transactions.py -v`
