# P45: Messenger Integration - Core Webhook

## 1. Objective

**What**: Facebook Messenger webhook endpoint with verification and signature validation.

**Why**: Facebook requires a verified webhook to send messages. This is the handshake that proves we own the endpoint.

**Scope**:
- Included: GET verification, POST signature validation, event parsing
- Excluded: Message processing, response sending, async handling (P46)

---

## 2. Implementation Tasks

### Task 45.1: Messenger Schemas (2 files, ~80 LOC)

Define Pydantic models for Facebook webhook payloads.

- Tests: `tests/unit/test_messenger_schemas.py`
  - `test_webhook_entry_parses_correctly()`
  - `test_messaging_event_extracts_sender_psid()`
  - `test_message_payload_extracts_text()`
  - `test_attachment_payload_parses()`
  - `test_postback_event_parses()`
- Files: `api/schemas/messenger.py`

### Task 45.2: Event Parser Service (2 files, ~100 LOC)

Service to parse Facebook webhook payload and extract message events.

- Tests: `tests/unit/test_messenger_event_parser.py`
  - `test_parse_text_message()`
  - `test_parse_ignores_read_receipts()`
  - `test_parse_ignores_delivery_confirmations()`
  - `test_parse_multiple_entries()`
  - `test_parse_attachment_returns_type()`
  - `test_parse_empty_payload_returns_empty()`
- Files: `services/messenger_event_parser.py`
- Depends on: Task 45.1

### Task 45.3: Webhook Verification Endpoint (2 files, ~60 LOC)

GET endpoint for Facebook webhook verification challenge.

- Tests: `tests/integration/test_messenger_webhook_verification.py`
  - `test_verification_returns_challenge_on_valid_token()`
  - `test_verification_returns_403_on_invalid_token()`
  - `test_verification_returns_400_on_missing_params()`
- Files: `api/routers/messenger.py`

### Task 45.4: Signature Validation Middleware (2 files, ~70 LOC)

Validate X-Hub-Signature-256 header on POST requests using existing `webhook_security.py`.

- Tests: `tests/integration/test_messenger_signature_validation.py`
  - `test_valid_signature_allows_request()`
  - `test_invalid_signature_returns_403()`
  - `test_missing_signature_returns_403()`
  - `test_empty_payload_with_valid_signature()`
- Files: `api/routers/messenger.py` (extend), `api/dependencies/messenger.py`
- Depends on: `core/webhook_security.py` (existing)

### Task 45.5: Webhook POST Endpoint (2 files, ~80 LOC)

POST endpoint to receive Facebook messages and parse events.

- Tests: `tests/integration/test_messenger_webhook_post.py`
  - `test_webhook_returns_200_immediately()`
  - `test_webhook_parses_message_events()`
  - `test_webhook_ignores_non_message_events()`
  - `test_webhook_handles_malformed_payload()`
- Files: `api/routers/messenger.py` (extend)
- Depends on: Task 45.2, Task 45.4

### Task 45.6: Router Registration (1 file, ~20 LOC)

Register messenger router with feature flag check.

- Tests: `tests/integration/test_messenger_feature_flag.py`
  - `test_messenger_enabled_routes_available()`
  - `test_messenger_disabled_routes_404()`
- Files: `api/main.py` (extend)
- Depends on: Task 45.5

---

## 3. Success Criteria

- [ ] GET `/messenger/webhook` returns hub.challenge on valid token
- [ ] GET `/messenger/webhook` returns 403 on invalid token
- [ ] POST `/messenger/webhook` validates X-Hub-Signature-256
- [ ] POST `/messenger/webhook` returns 200 immediately
- [ ] Event parser extracts sender PSID and message text
- [ ] Read receipts and delivery confirmations are ignored
- [ ] Feature flag disables routes when ENABLE_MESSENGER=false
- [ ] Unit test coverage ≥80% for new code
- [ ] Integration tests pass

---

## Build Order

```
45.1 Schemas
  └──▶ 45.2 Event Parser
        └──▶ 45.3 Verification Endpoint
              └──▶ 45.4 Signature Middleware
                    └──▶ 45.5 Webhook POST
                          └──▶ 45.6 Router Registration
```
