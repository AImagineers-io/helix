# P19b: Integration Tests - Test Suites & CI

## 1. Objective

**What**: Write integration tests for all Knowledge Base flows, plus security tests, performance baselines, and CI pipeline.

**Why**: Integration tests verify components work together. Security tests catch vulnerabilities. CI ensures tests run on every change.

**Scope**:
- Included: CRUD flow tests, embedding flow tests, search flow tests, E2E test, error scenarios, security tests, performance baselines, CI pipeline
- Excluded: Test infrastructure (P19a), E2E browser tests, load tests

**Dependencies**: P19a (test infrastructure), P13-P18 (all Knowledge Base components)

---

## 2. Implementation Tasks

### Task 19b.1: Write QA CRUD Integration Tests

- [ ] Full API flow tests for QA management (1 file, ~150 LOC)
  - **Tests**: `tests/integration/test_qa_crud_flow.py`
    - `test_full_qa_lifecycle()` - create → list → get → update → status → delete
    - `test_pagination_flow()` - create 25, page through
    - `test_filtering_flow()` - status + category + search filters
    - `test_concurrent_creates()` - parallel creates don't conflict
    - `test_soft_delete_excludes_from_all_queries()`

### Task 19b.2: Write Embedding Integration Tests

- [ ] Full flow from QA creation to embedding storage (1 file, ~120 LOC)
  - **Tests**: `tests/integration/test_embedding_flow.py`
    - `test_embedding_generated_on_qa_create()` - verify vector stored
    - `test_embedding_regenerated_on_qa_update()` - vector changes
    - `test_batch_embedding_generation()` - 10 pairs processed
    - `test_embedding_failure_sets_status()` - FAILED status stored
    - `test_embedding_retry_works()` - failed → retry → success

### Task 19b.3: Write Similarity Search Integration Tests

- [ ] Full search flow with real pgvector (1 file, ~150 LOC)
  - **Tests**: `tests/integration/test_search_flow.py`
    - `test_search_finds_similar_qa()` - semantic match works
    - `test_search_ranks_by_relevance()` - ordering correct
    - `test_search_threshold_filtering()` - low scores excluded
    - `test_search_category_filtering()` - category filter works
    - `test_search_excludes_non_active()` - DRAFT/ARCHIVED excluded
    - `test_search_excludes_deleted()` - soft-deleted excluded
    - `test_search_cache_hit()` - second query uses cache

### Task 19b.4: Write Full E2E Knowledge Base Test

- [ ] Complete flow simulating real usage (1 file, ~100 LOC)
  - **Tests**: `tests/integration/test_knowledge_base_e2e.py`
    - `test_complete_knowledge_base_workflow()`:
      1. Admin creates QA pair via API
      2. System generates embedding (sync in test)
      3. Admin activates QA pair
      4. User searches for related question
      5. System returns QA pair with similarity score
      6. Admin archives QA pair
      7. User search no longer returns it

### Task 19b.5: Write Error Scenario Tests

- [ ] Edge cases and error handling (1 file, ~100 LOC)
  - **Tests**: `tests/integration/test_knowledge_base_errors.py`
    - `test_search_empty_knowledge_base()` - 200 with empty
    - `test_invalid_status_transition_api()` - 400 with details
    - `test_get_deleted_qa_pair()` - 404
    - `test_search_with_invalid_token()` - 401
    - `test_embedding_api_timeout()` - QA created, embedding FAILED
    - `test_query_too_long()` - 422 with message

### Task 19b.6: Write Security Tests

- [ ] Security-focused test suite (1 file, ~100 LOC)
  - **Tests**: `tests/security/test_knowledge_base.py`
    - `test_sql_injection_in_search_query()` - query sanitized
    - `test_sql_injection_in_category_filter()` - filter sanitized
    - `test_xss_in_question_answer()` - HTML stripped
    - `test_auth_bypass_without_token()` - 401
    - `test_auth_bypass_invalid_token()` - 401
    - `test_auth_bypass_expired_token()` - 401
  - **Markers**: `@pytest.mark.security`

### Task 19b.7: Write Performance Baseline Tests

- [ ] Define performance benchmarks (1 file, ~80 LOC)
  - **Tests**: `tests/performance/test_baselines.py`
    - `test_search_latency_under_500ms()` - with 1000 QA pairs
    - `test_list_qa_under_100ms()` - pagination performance
    - `test_create_qa_under_200ms()` - creation + embedding trigger
  - **Markers**: `@pytest.mark.performance` (skip in regular CI)

### Task 19b.8: Create CI Pipeline

- [ ] Create GitHub Actions workflow (1 file, ~100 LOC)
  - **Files**: `.github/workflows/test-knowledge-base.yml`
  - **Jobs**:
    - `unit-tests`: Run unit tests with coverage
    - `integration-tests`: Run with PostgreSQL + pgvector + Redis
    - `security-tests`: Run security test suite

---

## 3. Success Criteria

- [ ] All integration tests pass with PostgreSQL + pgvector + Redis
- [ ] Full workflow test completes: create → embed → activate → search
- [ ] Soft delete properly excludes from all queries
- [ ] Error scenarios return appropriate HTTP codes
- [ ] Security tests pass (no injection vulnerabilities)
- [ ] Performance baselines documented
- [ ] CI pipeline runs on every push/PR
- [ ] Overall test coverage ≥80% for P13-P18 code
- [ ] No flaky tests (async operations deterministic)
