# Improvement Plan for P49d.md

## What's Weak / Missing

- No data migration strategy for storage schema changes - breaks on updates
- Missing encryption for stored messages - privacy concern in shared devices
- No storage quota monitoring - silent failures when quota exceeded
- Missing TTL/expiry for stored conversations - stale data accumulates
- No sync mechanism for schema migrations - inconsistent client state
- Missing PWA capabilities for standalone - no install, no offline
- No deep linking for standalone page - can't link to specific conversation
- Missing SEO considerations for standalone - poor discoverability
- No export conversation feature - users can't save their history
- Missing storage versioning - can't evolve schema safely

## Why This Matters

Without schema versioning, any storage format change breaks existing users. Unencrypted messages on shared/public computers expose private conversations. Missing PWA support means standalone can't be "installed" or work offline. No export means users lose history when clearing browser.

## Proposed Improvements

### Task 57.1: Implement Storage Versioning and Migration

- [ ] Add schema version with migration support (2 files, ~100 LOC)
  - **Tests**: `frontend/tests/widget/storage-migration.test.ts`
    - `test_storage_includes_version()` - version field present
    - `test_migrates_v1_to_v2()` - handles schema change
    - `test_skips_migration_if_current()` - no-op for same version
    - `test_handles_corrupt_data()` - resets on parse failure
    - `test_migrates_sequentially()` - v1 -> v2 -> v3
  - **Files**:
    - `frontend/src/widget/storage/StorageVersioning.ts`
    - `frontend/src/widget/storage/migrations/index.ts`
  - **Schema**:
    ```typescript
    interface VersionedStorage {
      version: number;
      data: StoredState;
    }
    ```

### Task 57.2: Add Optional Message Encryption

- [ ] Encrypt stored messages with user-provided key (2 files, ~90 LOC)
  - **Tests**: `frontend/tests/widget/storage-encryption.test.ts`
    - `test_encrypts_when_key_provided()` - AES-GCM encryption
    - `test_decrypts_on_load()` - transparent decryption
    - `test_plaintext_when_no_key()` - default behavior
    - `test_wrong_key_returns_empty()` - fails safely
    - `test_uses_web_crypto_api()` - secure implementation
  - **Files**:
    - `frontend/src/widget/storage/StorageEncryption.ts`
    - `frontend/src/widget/services/CryptoService.ts`
  - **Config**: `HelixChat.init({ encryptionKey: 'user-secret' })`

### Task 57.3: Add Storage Quota Management

- [ ] Monitor and handle storage limits (1 file, ~60 LOC)
  - **Tests**: `frontend/tests/widget/storage-quota.test.ts`
    - `test_estimates_storage_usage()` - navigator.storage.estimate
    - `test_warns_at_80_percent()` - proactive warning
    - `test_evicts_oldest_on_quota()` - FIFO eviction
    - `test_calculates_message_size()` - accurate estimation
  - **Files**:
    - `frontend/src/widget/storage/QuotaManager.ts`

### Task 57.4: Add Conversation TTL and Cleanup

- [ ] Expire old conversations automatically (1 file, ~50 LOC)
  - **Tests**: `frontend/tests/widget/storage-ttl.test.ts`
    - `test_default_ttl_30_days()` - default expiry
    - `test_configurable_ttl()` - custom retention
    - `test_cleans_expired_on_init()` - automatic cleanup
    - `test_touch_updates_expiry()` - activity extends TTL
  - **Files**:
    - `frontend/src/widget/storage/TtlManager.ts`
  - **Config**: `HelixChat.init({ historyTtlDays: 7 })`

### Task 57.5: Add PWA Support for Standalone

- [ ] Make standalone page installable (4 files, ~120 LOC)
  - **Tests**: `frontend/tests/widget/pwa.test.ts`
    - `test_manifest_present()` - manifest.json linked
    - `test_service_worker_registered()` - SW active
    - `test_offline_page_available()` - cached shell
    - `test_install_prompt_shown()` - beforeinstallprompt
  - **Files**:
    - `backend/static/widget/manifest.json`
    - `backend/static/widget/sw.js`
    - `backend/templates/widget_standalone.html` (extend)
    - `frontend/src/widget/pwa/InstallPrompt.ts`
  - **Backend Endpoint**: `GET /widget/manifest.json`

### Task 57.6: Add Conversation Export

- [ ] Allow users to download conversation (2 files, ~70 LOC)
  - **Tests**: `frontend/tests/widget/export.test.ts`
    - `test_export_as_text()` - plain text format
    - `test_export_as_json()` - structured format
    - `test_export_triggers_download()` - file download
    - `test_export_includes_metadata()` - timestamps, etc.
  - **Files**:
    - `frontend/src/widget/services/ExportService.ts`
    - `frontend/src/widget/components/ExportButton.ts`
  - **Formats**: Text, JSON

### Task 57.7: Add Deep Linking for Standalone

- [ ] Support URL parameters for standalone (1 file, ~40 LOC)
  - **Tests**: `backend/tests/integration/test_standalone_deeplink.py`
    - `test_welcome_param_shows_message()` - ?welcome=Hello
    - `test_theme_param_applies()` - ?theme=dark
    - `test_invalid_params_ignored()` - graceful handling
  - **Files**:
    - `backend/api/routers/widget.py` (extend)
  - **URL**: `/widget/standalone?theme=dark&welcome=Hello`

---

## Impact on Roadmap

- P49c (Message State) must call migration on load from Task 57.1
- P49c (Persistence) must integrate with QuotaManager and TtlManager
- P49e (Config) must expose encryption and TTL options
- P49e (E2E Tests) must test PWA installation flow
- Standalone page deployment must include service worker setup
