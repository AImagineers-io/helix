# P49e: Chat Widget - Configuration & Integration Tests

## 1. Objective

**What**: Create widget configuration endpoint and comprehensive integration tests for the complete widget system.

**Why**: Server-driven configuration enables behavioral changes without widget rebuilds. Integration tests verify the complete system works end-to-end.

**Scope**:
- Included: Widget config endpoint, environment configuration, browser integration tests, E2E tests
- Excluded: Widget JS bundle (P49a), UI components (P49b), services (P49c)

**Dependencies**: P49d (all widget features complete)

---

## 2. Implementation Tasks

### Task 49e.1: Create Widget Configuration Endpoint

- [ ] Return widget-specific configuration (2 files, ~80 LOC)
  - **Tests**: `backend/tests/integration/test_widget_config.py`
    - `test_config_returns_200()` - endpoint accessible
    - `test_config_includes_welcome_message()` - from prompt
    - `test_config_includes_placeholder()` - input placeholder text
    - `test_config_includes_position_default()` - default position
    - `test_config_caches_response()` - Cache-Control header
    - `test_config_combined_with_branding()` - single request option
  - **Files**:
    - `backend/api/routers/widget.py` (extend)
    - `backend/schemas/widget.py`
  - **Endpoint**: `GET /widget/config`
  - **Response**:
    ```python
    class WidgetConfig(BaseModel):
        enabled: bool
        welcome_message: str
        input_placeholder: str
        position: Literal['bottom-right', 'bottom-left']
    ```

### Task 49e.2: Add Widget Environment Configuration

- [ ] Environment variables for widget settings (2 files, ~60 LOC)
  - **Tests**: `backend/tests/unit/test_widget_config.py`
    - `test_enable_widget_default_true()` - enabled by default
    - `test_enable_widget_configurable()` - can be disabled
    - `test_position_default_bottom_right()` - sensible default
    - `test_placeholder_default()` - default placeholder text
  - **Files**:
    - `backend/core/config.py` (extend)
    - `.env.example` (add widget vars)
  - **Variables**:
    - `ENABLE_WIDGET=true`
    - `WIDGET_POSITION=bottom-right`
    - `WIDGET_INPUT_PLACEHOLDER=Type your message...`

### Task 49e.3: Create Widget Integration Tests

- [ ] Test widget with mocked API responses (1 file, ~100 LOC)
  - **Tests**: `frontend/tests/widget/integration/api-integration.test.ts`
    - `test_widget_fetches_config_on_init()` - config request made
    - `test_widget_fetches_branding_on_init()` - branding request made
    - `test_widget_sends_message_to_chat_api()` - chat request made
    - `test_widget_handles_api_unavailable()` - offline mode
    - `test_widget_retries_failed_config()` - resilience
  - **Files**:
    - `frontend/tests/widget/integration/api-integration.test.ts`
  - **Tools**: MSW (Mock Service Worker) for API mocking

### Task 49e.4: Create E2E Browser Tests

- [ ] Full browser tests with Playwright (1 file, ~150 LOC)
  - **Tests**: `frontend/tests/e2e/widget.spec.ts`
    - `test_widget_loads_on_page()` - script tag works
    - `test_bubble_opens_window()` - click interaction
    - `test_send_message_flow()` - complete round-trip
    - `test_message_persists_across_reload()` - persistence works
    - `test_standalone_page_works()` - /widget/standalone
    - `test_widget_mobile_responsive()` - mobile viewport
    - `test_widget_keyboard_navigation()` - accessibility
  - **Files**:
    - `frontend/tests/e2e/widget.spec.ts`
  - **Setup**: Test page with widget script, mock backend

### Task 49e.5: Add Widget Feature Flag

- [ ] Allow disabling widget via config (2 files, ~40 LOC)
  - **Tests**: `backend/tests/integration/test_widget_disabled.py`
    - `test_standalone_returns_404_when_disabled()` - feature off
    - `test_config_returns_enabled_false()` - flag exposed
    - `test_widget_js_still_serves()` - JS available (for upgrades)
  - **Files**:
    - `backend/api/routers/widget.py` (extend)
    - `backend/core/config.py` (extend)

---

## 3. Success Criteria

- [ ] `/widget/config` returns configuration JSON
- [ ] Widget respects ENABLE_WIDGET flag
- [ ] Configuration cached (1 hour TTL)
- [ ] All unit tests pass: `python helix.py test unit`
- [ ] All integration tests pass: `python helix.py test integration`
- [ ] E2E tests pass: `npm run test:e2e -- widget`
- [ ] Bundle size verified < 50KB gzipped
- [ ] Widget works in Chrome, Firefox, Safari
