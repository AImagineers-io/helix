# P46: Messenger Integration - Message Processing

## 1. Objective

**What**: Process Messenger messages through chat API and send responses back to users.

**Why**: The webhook receives messages but doesn't respond. This phase connects Messenger to the chat pipeline and sends responses via Facebook's Send API.

**Scope**:
- Included: Message handler, Send API client, typing indicators, async processing
- Excluded: Webhook verification, signature validation (P45)

**Depends on**: P45 (Webhook), P44 (Chat API)

---

## 2. Implementation Tasks

### Task 46.1: Facebook Send API Client (2 files, ~120 LOC)

HTTP client for Facebook's Send API with typing indicators.

- Tests: `tests/unit/test_facebook_send_api.py`
  - `test_send_text_message()`
  - `test_send_typing_on()`
  - `test_send_typing_off()`
  - `test_send_handles_api_error()`
  - `test_send_handles_rate_limit()`
  - `test_send_handles_user_blocked_bot()`
- Files: `services/facebook_send_api.py`

### Task 46.2: Messenger Handler Service (2 files, ~100 LOC)

Transform Messenger message to chat API format, call chat endpoint, transform response.

- Tests: `tests/unit/test_messenger_handler.py`
  - `test_handler_maps_psid_to_device_id()`
  - `test_handler_calls_chat_api()`
  - `test_handler_includes_platform_metadata()`
  - `test_handler_extracts_response_message()`
  - `test_handler_handles_chat_api_error()`
- Files: `services/messenger_handler.py`
- Depends on: P44 Chat API

### Task 46.3: Async Message Processor (2 files, ~80 LOC)

Background task to process messages asynchronously. Returns 200 to Facebook immediately.

- Tests: `tests/integration/test_messenger_async_processing.py`
  - `test_webhook_returns_before_processing_completes()`
  - `test_background_task_sends_response()`
  - `test_background_task_logs_errors()`
  - `test_processing_respects_timeout()`
- Files: `services/messenger_processor.py`
- Depends on: Task 46.1, Task 46.2

### Task 46.4: Integrate Processor with Webhook (1 file, ~40 LOC)

Wire async processor into webhook POST endpoint.

- Tests: `tests/integration/test_messenger_e2e.py`
  - `test_message_received_to_response_sent()`
  - `test_typing_indicator_sent_before_response()`
  - `test_error_sends_fallback_message()`
- Files: `api/routers/messenger.py` (extend)
- Depends on: P45.5, Task 46.3

### Task 46.5: Error Handling and Logging (2 files, ~60 LOC)

Structured logging for Messenger events and graceful error handling.

- Tests: `tests/unit/test_messenger_error_handling.py`
  - `test_invalid_psid_logged()`
  - `test_send_api_error_logged()`
  - `test_chat_api_error_sends_fallback()`
  - `test_fallback_message_sent_on_timeout()`
- Files: `services/messenger_processor.py` (extend), `services/facebook_send_api.py` (extend)
- Depends on: Task 46.3

### Task 46.6: Integration Test Suite (1 file, ~150 LOC)

Comprehensive integration tests with mocked Facebook API.

- Tests: `tests/integration/test_messenger_integration.py`
  - `test_full_flow_text_message()`
  - `test_full_flow_with_conversation_history()`
  - `test_concurrent_messages_same_user()`
  - `test_messages_from_different_users()`
  - `test_attachment_message_handled()`
  - `test_feature_flag_disabled()`
- Files: `tests/integration/test_messenger_integration.py`
- Depends on: All previous tasks

---

## 3. Success Criteria

- [ ] Messages processed through chat pipeline
- [ ] Responses sent back to Messenger users
- [ ] Typing indicator shown during processing
- [ ] 200 returned to Facebook within 20 seconds
- [ ] PSID used as device_id for conversation tracking
- [ ] Platform="messenger" included in conversation metadata
- [ ] Send API errors handled gracefully
- [ ] Fallback message sent on processing errors
- [ ] Unit test coverage ≥80% for new code
- [ ] All integration tests pass

---

## Build Order

```
46.1 Send API Client
  └──▶ 46.2 Messenger Handler
        └──▶ 46.3 Async Processor
              └──▶ 46.4 Webhook Integration
                    └──▶ 46.5 Error Handling
                          └──▶ 46.6 Integration Tests
```

---

## Configuration

| Setting | Environment Variable | Notes |
|---------|---------------------|-------|
| Enable/Disable | ENABLE_MESSENGER | Feature flag |
| Verify Token | FB_VERIFY_TOKEN | For webhook verification |
| Page Access Token | FB_PAGE_ACCESS_TOKEN | For Send API |
| App Secret | FB_APP_SECRET | For signature validation |

---

## API Endpoints

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/messenger/webhook` | GET | Facebook verification |
| `/messenger/webhook` | POST | Incoming messages |
