# P80: Improvement Plan for P74.md

## What's Weak / Missing

### Transaction Safety Gaps
- No transaction boundary specification for cost recording
- Missing guidance on what happens if LLM call succeeds but cost recording fails
- No rollback strategy for partial failures

### Query Performance Gaps
- No pagination for `sum_by_provider()` and `sum_by_model()`
- Missing cursor-based pagination for large date ranges
- No caching strategy for expensive aggregation queries
- No read replica routing for analytics queries

### Error Handling Gaps
- No specification for repository error handling patterns
- Missing retry logic for transient database errors
- No circuit breaker for database overload protection

### Concurrency Gaps
- No handling for race conditions in cost recording
- Missing optimistic locking or idempotency keys
- No consideration of duplicate cost records from retried LLM calls

### Baseline Establishment
- "Update" implies existing code but no baseline documented
- Unclear which mock methods should be deprecated vs. removed
- No migration path from placeholder data

## Why This Matters

Cost tracking is financial data - inaccuracies directly impact billing and budget decisions. Without transaction safety, LLM costs may be incurred but not recorded, causing accounting discrepancies. Without pagination, analytics queries will timeout as data grows. Race conditions cause duplicate cost records, inflating reported costs.

## Proposed Improvements

### 1. Define Transaction Boundaries

Add to Task 5 (Cost tracking integration):
```python
# Cost recording MUST be in same transaction as LLM response caching
# If cost record fails, the entire transaction fails
# Use "best effort" pattern only for non-critical paths

async def record_cost_with_response(
    response: LLMResponse,
    cost_record: CostRecordCreate
) -> None:
    async with db.transaction():
        await cache_response(response)
        await cost_repository.create(cost_record)
```

Add success criterion:
- [ ] Cost recording failure causes response to NOT be cached (prevents silent cost leakage)

### 2. Add Pagination to Aggregation Queries

Modify Task 1 (CostRecordRepository):
```python
# Add paginated variants
async def sum_by_provider(
    start_date: datetime,
    end_date: datetime,
    page_size: int = 1000
) -> AsyncIterator[ProviderCostSummary]:
    """Stream results to avoid memory exhaustion on large ranges"""
```

Add success criterion:
- [ ] All aggregation queries support streaming for ranges > 30 days

### 3. Add Caching Layer

Add new task:
- [ ] Analytics cache layer (2 files, ~60 LOC)
  - Tests: tests/unit/test_analytics_cache.py
  - Files: services/analytics_cache.py, core/cache.py
  - Cache strategy: 5-minute TTL for summary data, invalidate on new cost record
  - Methods: get_cached_summary(), invalidate_summary()

Add success criterion:
- [ ] Repeated summary queries within 5 minutes hit cache (no database query)

### 4. Add Idempotency Keys

Modify Task 5:
```python
# CostRecord must include idempotency_key
# Format: {conversation_id}:{message_id}:{timestamp_ms}
# Unique constraint prevents duplicate recording from retried requests
```

Add to CostRecordRepository:
```python
async def create_if_not_exists(
    record: CostRecordCreate,
    idempotency_key: str
) -> tuple[CostRecord, bool]:
    """Returns (record, was_created)"""
```

Add success criterion:
- [ ] Duplicate cost record attempts with same idempotency_key are rejected (no duplicate costs)

### 5. Add Error Handling Patterns

Add new task:
- [ ] Repository error handling (1 file, ~40 LOC)
  - Tests: tests/unit/test_repository_errors.py
  - Files: repositories/base.py
  - Patterns: Retry with exponential backoff for transient errors, immediate fail for constraint violations
  - Max retries: 3, base delay: 100ms

Add success criterion:
- [ ] Transient database errors retry automatically (up to 3 times)
- [ ] Constraint violations raise immediately without retry

### 6. Document Baseline and Migration

Add to section 1 (Objective):
```markdown
**Baseline**: AnalyticsService currently returns:
- _get_cost_summary(): Hardcoded $0.00 values
- _get_conversation_stats(): Estimates from cache only

**Migration**:
- Keep placeholder methods as fallback during rollout
- Add feature flag: ANALYTICS_USE_REAL_DATA (default: false)
- Remove placeholders in P85 after dashboard validation
```

### 7. Add Performance Targets

Add success criteria:
- [ ] GET /analytics/summary responds < 500ms for 30-day range
- [ ] Cost breakdown query explains with index scan (no seq scan)
- [ ] Memory usage for summary query < 10MB regardless of data size

## Impact on Roadmap

- **P73** must add idempotency_key column to CostRecord model
- **P77** aggregation must respect cache invalidation
- **P78** dashboard must handle loading states for cached vs. fresh data
- Add P85: "Remove Analytics Placeholders" - cleanup task after dashboard validation
