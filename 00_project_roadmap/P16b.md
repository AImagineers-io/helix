# P16b: QA API - Routes & Auth

## 1. Objective

**What**: Implement QA CRUD routes with authentication and query optimization.

**Why**: REST endpoints enable admin UI to manage the knowledge base. Authentication ensures only authorized users can modify data.

**Scope**:
- Included: List/Create routes, Get/Update/Delete routes, Status change route, N+1 optimization, Auth wiring
- Excluded: Schemas (P16a), Exception handlers (P16a)

**Dependencies**: P16a (schemas, exception handlers), P15 (QA service), P12 (authentication)

---

## 2. Implementation Tasks

### Task 16b.1: Create QA Router - List and Create

- [ ] Create QA router with list/create endpoints (2 files, ~100 LOC)
  - **Tests**: `tests/integration/test_api_qa.py`
    - `test_list_qa_pairs_empty()` - returns empty list, 200
    - `test_list_qa_pairs_with_data()` - returns items, pagination
    - `test_list_qa_pairs_filter_status()` - filters work
    - `test_list_qa_pairs_filter_search()` - text search works
    - `test_list_qa_pairs_pagination()` - page/page_size params work
    - `test_create_qa_pair()` - creates and returns 201
    - `test_create_qa_pair_invalid()` - returns 422 on validation error
  - **Files**: `backend/api/routes/qa.py`, `backend/api/routes/__init__.py`
  - **Implementation**:
    ```python
    router = APIRouter(prefix="/qa", tags=["Knowledge Base"])

    @router.get("/pairs", response_model=QAListResponse)
    async def list_qa_pairs(params: QAListParams = Depends(), ...):
        ...

    @router.post("/pairs", response_model=QAResponse, status_code=201)
    async def create_qa_pair(request: QACreateRequest, ...):
        ...
    ```

### Task 16b.2: Add Get, Update, Delete Endpoints

- [ ] Add single-item endpoints (1 file, ~80 LOC)
  - **Tests**: `tests/integration/test_api_qa.py`
    - `test_get_qa_pair()` - returns single item, 200
    - `test_get_qa_pair_not_found()` - returns 404
    - `test_update_qa_pair()` - updates and returns 200
    - `test_update_qa_pair_partial()` - partial update works
    - `test_delete_qa_pair()` - soft deletes, returns 204
    - `test_deleted_pair_not_in_list()` - deleted excluded from list
  - **Files**: `backend/api/routes/qa.py`
  - **Endpoints**:
    - `GET /qa/pairs/{id}` - Get single QA pair
    - `PUT /qa/pairs/{id}` - Update QA pair
    - `DELETE /qa/pairs/{id}` - Soft delete QA pair

### Task 16b.3: Add Status Change Endpoint

- [ ] Add status transition endpoint (1 file, ~40 LOC)
  - **Tests**: `tests/integration/test_api_qa.py`
    - `test_change_status_success()` - valid transition returns 200
    - `test_change_status_invalid_transition()` - invalid returns 400
    - `test_change_status_not_found()` - missing ID returns 404
  - **Files**: `backend/api/routes/qa.py`
  - **Endpoint**: `POST /qa/pairs/{id}/status`

### Task 16b.4: Optimize has_embedding Query

- [ ] Use subquery to prevent N+1 queries (1 file, ~30 LOC)
  - **Tests**: `tests/integration/test_api_qa.py`
    - `test_list_qa_single_query()` - verified via query count
  - **Files**: `backend/repositories/qa_repository.py`
  - **Implementation**:
    ```python
    has_embedding = exists(
        select(Embedding).where(Embedding.qa_pair_id == QAPair.id)
    ).label('has_embedding')

    query = select(QAPair, has_embedding).where(QAPair.active())
    ```

### Task 16b.5: Wire Router with Auth

- [ ] Register QA router with authentication (2 files, ~30 LOC)
  - **Tests**: `tests/integration/test_api_qa.py`
    - `test_requires_bearer_token()` - 401 without Authorization
    - `test_requires_valid_jwt()` - 401 with invalid token
    - `test_requires_admin_role()` - 403 without admin permission
  - **Files**: `backend/api/routes/__init__.py`, `backend/main.py`
  - **Implementation**:
    ```python
    from backend.api.auth import require_admin

    @router.get("/pairs", dependencies=[Depends(require_admin)])
    ```

---

## 3. Success Criteria

- [ ] All CRUD endpoints work correctly
- [ ] Status change validates workflow
- [ ] No N+1 queries for has_embedding
- [ ] All endpoints require authentication
- [ ] OpenAPI docs generated with summaries
- [ ] All tests pass: `pytest tests/integration/test_api_qa.py -v`
