# P22: P15 QA Service Improvements

## 1. Objective

**What**: Enhance P15 QA service with additional validation, bulk operations, change history, and service-level metrics.

**Why**: P15 provides core CRUD. Production needs bulk import for initial data load, change tracking for debugging, and metrics for monitoring.

**Scope**:
- Included: Bulk create/update, change history tracking, service metrics, enhanced validation rules, idempotency support
- Excluded: Full event sourcing, external change data capture

**Dependencies**: P15 (QA Service)

---

## 2. Implementation Tasks

### Task 22.1: Bulk Operations

- [ ] Add bulk create and update methods (1 file, ~60 LOC)
  - **Tests**: `tests/unit/test_qa_service_bulk.py`
    - `test_bulk_create_multiple()` - creates 100 pairs efficiently
    - `test_bulk_create_validates_all()` - all-or-nothing validation
    - `test_bulk_create_returns_ids()` - returns created IDs
    - `test_bulk_update_multiple()` - updates batch efficiently
    - `test_bulk_partial_failure_rollback()` - transaction rollback
  - **Files**: `backend/services/qa_service.py`
  - **Implementation**:
    ```python
    @dataclass
    class BulkCreateResult:
        created_ids: List[UUID]
        total: int
        errors: List[str]

    def bulk_create(self, items: List[QACreateInput]) -> BulkCreateResult:
        """Create multiple QA pairs in single transaction."""

    def bulk_update(self, updates: List[QAUpdateInput]) -> BulkUpdateResult:
        """Update multiple QA pairs in single transaction."""
    ```

### Task 22.2: Change History Tracking

- [ ] Track changes to QA pairs for debugging (2 files, ~80 LOC)
  - **Tests**: `tests/unit/test_qa_history.py`
    - `test_create_records_history()` - initial creation logged
    - `test_update_records_diff()` - changed fields captured
    - `test_status_change_recorded()` - workflow transitions logged
    - `test_delete_recorded()` - soft delete logged
    - `test_history_includes_user()` - who made change
  - **Files**: `backend/models/qa_history.py`, `backend/services/qa_service.py`
  - **Implementation**:
    ```python
    class QAHistory(BaseModel):
        __tablename__ = "qa_history"

        qa_pair_id: Mapped[UUID] = mapped_column(ForeignKey("qa_pair.id"))
        action: Mapped[str]  # "created", "updated", "status_changed", "deleted"
        changed_fields: Mapped[dict] = mapped_column(JSON)
        old_values: Mapped[dict] = mapped_column(JSON)
        new_values: Mapped[dict] = mapped_column(JSON)
        changed_by: Mapped[Optional[UUID]]
    ```

### Task 22.3: Service Metrics

- [ ] Add metrics collection for monitoring (1 file, ~50 LOC)
  - **Tests**: `tests/unit/test_qa_metrics.py`
    - `test_tracks_create_count()` - increments on create
    - `test_tracks_update_count()` - increments on update
    - `test_tracks_delete_count()` - increments on delete
    - `test_tracks_operation_latency()` - measures duration
    - `test_metrics_reset()` - can reset for testing
  - **Files**: `backend/services/qa_service.py`
  - **Implementation**:
    ```python
    @dataclass
    class QAServiceMetrics:
        creates: int = 0
        updates: int = 0
        deletes: int = 0
        status_changes: int = 0
        avg_create_ms: float = 0.0
        avg_update_ms: float = 0.0

    class QAService:
        def get_metrics(self) -> QAServiceMetrics:
            """Return service operation metrics."""
    ```

### Task 22.4: Enhanced Validation Rules

- [ ] Add configurable validation rules (1 file, ~40 LOC)
  - **Tests**: `tests/unit/test_qa_validation_rules.py`
    - `test_min_question_length_configurable()` - env override
    - `test_max_tags_configurable()` - limits tag count
    - `test_category_whitelist()` - optional allowed categories
    - `test_profanity_filter()` - optional content filter
  - **Files**: `backend/config/qa_validation.py`
  - **Implementation**:
    ```python
    @dataclass
    class QAValidationConfig:
        min_question_length: int = int(os.getenv("QA_MIN_QUESTION_LEN", "10"))
        max_question_length: int = int(os.getenv("QA_MAX_QUESTION_LEN", "10000"))
        max_answer_length: int = int(os.getenv("QA_MAX_ANSWER_LEN", "50000"))
        max_tags: int = int(os.getenv("QA_MAX_TAGS", "10"))
        allowed_categories: Optional[List[str]] = None  # None = any
    ```

### Task 22.5: Idempotency Support

- [ ] Add idempotency keys for safe retries (1 file, ~40 LOC)
  - **Tests**: `tests/unit/test_qa_idempotency.py`
    - `test_idempotency_key_prevents_duplicate()` - same key returns same result
    - `test_different_keys_create_separate()` - unique keys create unique records
    - `test_idempotency_key_expires()` - keys expire after TTL
    - `test_idempotency_stored_in_redis()` - uses cache
  - **Files**: `backend/services/qa_service.py`
  - **Implementation**:
    ```python
    async def create_idempotent(
        self,
        idempotency_key: str,
        question: str,
        answer: str,
        **kwargs
    ) -> Tuple[QAPair, bool]:  # (result, was_cached)
        """Create with idempotency key for safe retries."""
    ```

---

## 3. Success Criteria

- [ ] Bulk create handles 100+ items efficiently
- [ ] Change history captures all modifications with diffs
- [ ] Service metrics track operation counts and latency
- [ ] Validation rules configurable via environment
- [ ] Idempotency keys prevent duplicate creates
- [ ] All operations remain atomic (all-or-nothing)
- [ ] All tests pass: `pytest tests/unit/test_qa_service_bulk.py tests/unit/test_qa_history.py tests/unit/test_qa_metrics.py tests/unit/test_qa_validation_rules.py tests/unit/test_qa_idempotency.py -v`
