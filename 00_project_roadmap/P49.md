# P49a: Chat Widget - Core JavaScript Bundle

## 1. Objective

**What**: Create a lightweight, self-contained JavaScript bundle that clients embed on their websites with a single script tag.

**Why**: Maximum simplicity for client integration. One line of HTML, no npm install, no build process, no framework requirements. Works on any website.

**Scope**:
- Included: Build configuration, module structure, initialization API, IIFE bundle
- Excluded: UI components (P49b), branding fetch (P49c), message handling (P49c)

**Dependencies**: None (foundational phase)

---

## 2. Implementation Tasks

### Task 49a.1: Create Widget Build Configuration

- [ ] Set up Vite build for IIFE bundle (3 files, ~80 LOC)
  - **Tests**: `frontend/tests/widget/widget-build.test.ts`
    - `test_bundle_output_is_iife()` - single self-executing function
    - `test_bundle_under_50kb()` - gzipped size < 50KB
    - `test_no_external_dependencies()` - no import statements in output
    - `test_bundle_defines_helix_global()` - window.HelixChat exists
  - **Files**:
    - `frontend/vite.widget.config.ts`
    - `frontend/src/widget/index.ts`
    - `frontend/package.json` (add build:widget script)

### Task 49a.2: Create Widget Module Structure

- [ ] Create core widget module with isolated scope (2 files, ~100 LOC)
  - **Tests**: `frontend/tests/widget/widget-core.test.ts`
    - `test_widget_does_not_pollute_global_scope()` - only HelixChat exposed
    - `test_widget_css_is_scoped()` - no global style conflicts
    - `test_widget_handles_missing_container()` - graceful error
    - `test_widget_prevents_double_init()` - idempotent initialization
  - **Files**:
    - `frontend/src/widget/core/WidgetCore.ts`
    - `frontend/src/widget/core/ScopedStyles.ts`

### Task 49a.3: Create Widget Initialization API

- [ ] Create init function with configuration options (2 files, ~120 LOC)
  - **Tests**: `frontend/tests/widget/widget-init.test.ts`
    - `test_init_with_minimal_config()` - tenant_id only required
    - `test_init_with_custom_position()` - bottom-left, bottom-right
    - `test_init_via_data_attributes()` - script tag data-* config
    - `test_init_validates_api_url()` - rejects invalid URLs
    - `test_init_returns_widget_instance()` - controllable instance
    - `test_destroy_removes_widget()` - clean unmount
  - **Files**:
    - `frontend/src/widget/api/init.ts`
    - `frontend/src/widget/types/config.ts`
  - **API**:
    ```typescript
    interface WidgetConfig {
      apiUrl: string;           // Required: Helix API base URL
      position?: 'bottom-right' | 'bottom-left';  // Default: bottom-right
      zIndex?: number;          // Default: 9999
    }

    HelixChat.init(config: WidgetConfig): WidgetInstance
    HelixChat.destroy(): void
    ```

---

## 3. Success Criteria

- [ ] `npm run build:widget` produces single JS file
- [ ] Bundle size < 50KB gzipped
- [ ] No external runtime dependencies
- [ ] `window.HelixChat.init()` works in browser
- [ ] Widget does not conflict with host page styles/scripts
- [ ] All tests pass: `npm test -- widget`
