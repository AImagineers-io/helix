# P27b: Chat Pipeline - Language Processors

## 1. Objective

**What**: Build language detection and translation processors that enable multi-language support.

**Why**: Helix serves international users. Language detection identifies the user's language. Translation converts non-English to English for processing, then back to user's language for response. The RAG system and LLM work best with English content.

**Scope**:
- Included: Language detection processor (langdetect), translation processor (Google Translate API)
- Excluded: Pipeline architecture (P27a), other processors (P27c-P27d)

**Dependencies**: P27a (Pipeline Architecture & Context)

---

## 2. Implementation Tasks

### Task 27b.1: Create Language Detection Processor

- [ ] Detect user's language using langdetect library (1 file, ~60 LOC)
  - **Tests**: `tests/unit/test_language_detection_processor.py`
    - `test_detects_english()` - "Hello, how are you?" → "en"
    - `test_detects_tagalog()` - "Magandang umaga!" → "tl"
    - `test_detects_spanish()` - "¿Cómo estás?" → "es"
    - `test_detects_french()` - "Bonjour, comment ça va?" → "fr"
    - `test_short_message_defaults_to_primary()` - "Hi" → config primary
    - `test_mixed_language_detects_dominant()` - handles mixed text
    - `test_detection_failure_defaults_to_primary()` - graceful fallback
    - `test_stores_detected_language_in_context()` - context updated
    - `test_processor_is_optional()` - failure doesn't halt pipeline
  - **Files**: `backend/pipeline/processors/language_detection.py`
  - **Implementation**:
    ```python
    class LanguageDetectionProcessor(Processor):
        name = "language_detection"
        is_optional = True

        def __init__(self, primary_language: str = "en", min_confidence: float = 0.5):
            self._primary_language = primary_language
            self._min_confidence = min_confidence

        async def process(self, context: PipelineContext) -> PipelineContext:
            """Detect language and update context."""

        def _detect(self, text: str) -> Tuple[str, float]:
            """Return (language_code, confidence) or default."""
    ```

### Task 27b.2: Create Translation Service

- [ ] Wrap Google Translate API with caching (1 file, ~80 LOC)
  - **Tests**: `tests/unit/test_translation_service.py`
    - `test_translates_to_english()` - "Bonjour" → "Hello"
    - `test_translates_from_english()` - "Hello" → "Bonjour" (fr)
    - `test_skips_same_language()` - "Hello" en→en returns original
    - `test_caches_common_translations()` - repeated calls use cache
    - `test_handles_api_failure()` - returns original on error
    - `test_respects_rate_limits()` - exponential backoff
    - `test_tracks_translation_cost()` - character count tracked
  - **Files**: `backend/services/translation_service.py`
  - **Implementation**:
    ```python
    class TranslationService:
        def __init__(self, api_key: str, cache: Optional[Redis] = None):
            self._client = translate.Client(credentials=...)
            self._cache = cache

        async def translate(
            self, text: str, source_lang: str, target_lang: str
        ) -> TranslationResult:
            """Translate text between languages."""

    @dataclass
    class TranslationResult:
        original_text: str
        translated_text: str
        source_language: str
        target_language: str
        was_cached: bool
        character_count: int
    ```

### Task 27b.3: Create Translation Processor

- [ ] Translate inbound messages to English (1 file, ~70 LOC)
  - **Tests**: `tests/unit/test_translation_processor.py`
    - `test_skips_if_already_english()` - no API call for English
    - `test_translates_non_english_to_english()` - uses service
    - `test_stores_original_and_translated()` - both in context
    - `test_handles_translation_failure()` - uses original on error
    - `test_processor_is_optional()` - failure doesn't halt pipeline
    - `test_tracks_translation_cost()` - cost metadata captured
  - **Files**: `backend/pipeline/processors/translation.py`
  - **Implementation**:
    ```python
    class TranslationProcessor(Processor):
        name = "translation"
        is_optional = True

        def __init__(self, translation_service: TranslationService):
            self._translation_service = translation_service

        async def process(self, context: PipelineContext) -> PipelineContext:
            """Translate non-English messages to English."""

        def should_skip(self, context: PipelineContext) -> bool:
            """Skip if message already in English."""
            return context.detected_language == "en"
    ```

### Task 27b.4: Create Response Translation Processor

- [ ] Translate final response back to user's language (1 file, ~50 LOC)
  - **Tests**: `tests/unit/test_response_translation_processor.py`
    - `test_skips_if_user_language_english()` - no translation needed
    - `test_translates_response_to_user_language()` - uses service
    - `test_preserves_markdown_formatting()` - formatting intact
    - `test_handles_translation_failure()` - returns English on error
  - **Files**: `backend/pipeline/processors/response_translation.py`
  - **Implementation**:
    ```python
    class ResponseTranslationProcessor(Processor):
        name = "response_translation"
        is_optional = True

        def __init__(self, translation_service: TranslationService):
            self._translation_service = translation_service

        async def process(self, context: PipelineContext) -> PipelineContext:
            """Translate response to user's detected language."""

        def should_skip(self, context: PipelineContext) -> bool:
            return context.detected_language in ("en", None)
    ```

---

## 3. Success Criteria

- [ ] Language detection works for English, Tagalog, Spanish, French
- [ ] Short messages default to configured primary language
- [ ] Detection failures gracefully fall back to primary language
- [ ] Translation service caches common translations
- [ ] Translation skips same-language requests
- [ ] API failures return original text (no error to user)
- [ ] Response translation preserves markdown formatting
- [ ] Character counts tracked for cost monitoring
- [ ] All tests pass: `pytest tests/unit/test_language_detection_processor.py tests/unit/test_translation_*.py -v`
- [ ] Coverage ≥80% for language processors
