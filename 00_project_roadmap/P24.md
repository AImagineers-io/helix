# P24: P17 Embedding Service Improvements

## 1. Objective

**What**: Enhance P17 embedding service with queue-based processing, circuit breaker pattern, embedding comparison, and detailed cost analytics.

**Why**: P17 provides basic embedding generation. Production needs resilience against OpenAI outages, queue-based processing for large batches, and cost visibility for budgeting.

**Scope**:
- Included: Background job queue, circuit breaker, embedding comparison tools, cost analytics dashboard data, model migration support
- Excluded: Multi-model support, embedding fine-tuning, self-hosted models

**Dependencies**: P17 (Embedding Service)

---

## 2. Implementation Tasks

### Task 24.1: Background Job Queue

- [ ] Queue embedding jobs for async processing (2 files, ~80 LOC)
  - **Tests**: `tests/unit/test_embedding_queue.py`
    - `test_job_queued_on_create()` - embedding job added to queue
    - `test_job_processed_async()` - worker processes job
    - `test_job_retry_on_failure()` - failed jobs retried
    - `test_job_dead_letter_after_max_retries()` - moves to DLQ
    - `test_queue_priority()` - high priority jobs first
  - **Files**: `backend/services/embedding_queue.py`, `backend/workers/embedding_worker.py`
  - **Implementation**:
    ```python
    class EmbeddingJob(BaseModel):
        qa_pair_id: UUID
        priority: int = 0  # Higher = more urgent
        attempts: int = 0
        max_attempts: int = 3

    class EmbeddingQueue:
        async def enqueue(self, job: EmbeddingJob) -> str:
            """Add job to Redis queue, return job ID."""

        async def process_next(self) -> Optional[EmbeddingJob]:
            """Get and process next job from queue."""
    ```

### Task 24.2: Circuit Breaker Pattern

- [ ] Add circuit breaker for OpenAI API (1 file, ~60 LOC)
  - **Tests**: `tests/unit/test_embedding_circuit_breaker.py`
    - `test_circuit_closed_allows_requests()` - normal operation
    - `test_circuit_opens_after_failures()` - stops after N failures
    - `test_circuit_half_open_after_timeout()` - allows probe request
    - `test_circuit_closes_on_success()` - recovers after success
    - `test_circuit_state_in_redis()` - survives restarts
  - **Files**: `backend/clients/circuit_breaker.py`
  - **Implementation**:
    ```python
    class CircuitBreaker:
        def __init__(
            self,
            redis: Redis,
            failure_threshold: int = 5,
            recovery_timeout: int = 60
        ):
            ...

        async def call(self, func, *args, **kwargs):
            """Execute function with circuit breaker protection."""

        @property
        def state(self) -> str:  # "closed", "open", "half_open"
            ...
    ```

### Task 24.3: Embedding Comparison Tools

- [ ] Compare embeddings for debugging (1 file, ~50 LOC)
  - **Tests**: `tests/unit/test_embedding_compare.py`
    - `test_cosine_similarity_calculation()` - correct similarity
    - `test_compare_qa_pairs()` - similarity between two QA pairs
    - `test_find_near_duplicates()` - identifies similar content
    - `test_embedding_drift_detection()` - detects model changes
  - **Files**: `backend/services/embedding_compare.py`
  - **Implementation**:
    ```python
    def cosine_similarity(vec1: List[float], vec2: List[float]) -> float:
        """Calculate cosine similarity between two vectors."""

    async def find_near_duplicates(
        threshold: float = 0.95,
        limit: int = 100
    ) -> List[Tuple[UUID, UUID, float]]:
        """Find QA pairs with very similar embeddings."""

    async def detect_embedding_drift(
        sample_size: int = 100
    ) -> DriftReport:
        """Compare current vs stored embeddings to detect model changes."""
    ```

### Task 24.4: Cost Analytics

- [ ] Detailed cost tracking and reporting (2 files, ~70 LOC)
  - **Tests**: `tests/unit/test_embedding_cost_analytics.py`
    - `test_daily_cost_aggregation()` - sum by day
    - `test_weekly_cost_aggregation()` - sum by week
    - `test_cost_by_category()` - breakdown by QA category
    - `test_cost_projection()` - estimate future costs
    - `test_cost_alerts()` - warning when threshold exceeded
  - **Files**: `backend/services/embedding_cost_analytics.py`, `backend/schemas/cost.py`
  - **Implementation**:
    ```python
    @dataclass
    class CostReport:
        period_start: datetime
        period_end: datetime
        total_tokens: int
        total_cost_usd: float
        by_day: Dict[str, float]
        by_category: Dict[str, float]
        projected_monthly: float

    async def get_cost_report(
        start_date: date,
        end_date: date
    ) -> CostReport:
        """Generate cost report for date range."""

    async def check_cost_alerts() -> List[CostAlert]:
        """Check if any cost thresholds exceeded."""
    ```

### Task 24.5: Model Migration Support

- [ ] Support transitioning between embedding models (1 file, ~50 LOC)
  - **Tests**: `tests/unit/test_embedding_migration.py`
    - `test_identify_old_model_embeddings()` - finds outdated
    - `test_batch_regenerate_embeddings()` - re-embeds with new model
    - `test_migration_preserves_qa_pairs()` - no data loss
    - `test_migration_progress_tracking()` - shows percentage done
    - `test_rollback_on_failure()` - can revert
  - **Files**: `backend/services/embedding_migration.py`
  - **Implementation**:
    ```python
    @dataclass
    class MigrationProgress:
        total: int
        completed: int
        failed: int
        percentage: float

    async def migrate_embeddings(
        from_model: str,
        to_model: str,
        batch_size: int = 100
    ) -> AsyncIterator[MigrationProgress]:
        """Migrate embeddings from one model to another."""
    ```

---

## 3. Success Criteria

- [ ] Embedding jobs processed via background queue
- [ ] Failed jobs retry with exponential backoff
- [ ] Circuit breaker prevents cascading failures
- [ ] Near-duplicate detection identifies similar content
- [ ] Cost reports show daily/weekly/category breakdown
- [ ] Cost alerts trigger when thresholds exceeded
- [ ] Model migration supports zero-downtime transitions
- [ ] All tests pass: `pytest tests/unit/test_embedding_queue.py tests/unit/test_embedding_circuit_breaker.py tests/unit/test_embedding_compare.py tests/unit/test_embedding_cost_analytics.py tests/unit/test_embedding_migration.py -v`
