# Improvement Plan for P49a.md

## What's Weak / Missing

- No error boundary or crash recovery strategy - widget failures will break silently
- Missing Content Security Policy (CSP) considerations for enterprise clients with strict policies
- No specification for Shadow DOM usage to achieve true style isolation
- Missing bundle versioning and cache-busting strategy - updates may not reach users
- No load timing specification (defer vs async vs inline)
- Missing handling for pre-existing `window.HelixChat` conflicts
- No specification for multiple widget instances on the same page
- Missing performance budget breakdown (parse time, execution time, not just file size)
- No specification for source maps in production (debugging support)
- Missing fallback behavior when JavaScript is disabled

## Why This Matters

Without these specifications, the widget will fail unpredictably in enterprise environments with strict CSP, create debugging nightmares in production, and cause style bleeding on complex host pages. Cache-busting gaps mean users stay on broken versions indefinitely.

## Proposed Improvements

### Task 54.1: Define Shadow DOM Isolation Strategy

- [ ] Implement Shadow DOM encapsulation (2 files, ~60 LOC)
  - **Tests**: `frontend/tests/widget/shadow-dom.test.ts`
    - `test_widget_renders_in_shadow_root()` - encapsulated DOM
    - `test_host_page_styles_do_not_leak_in()` - isolation verified
    - `test_widget_styles_do_not_leak_out()` - no global pollution
    - `test_shadow_dom_fallback_for_old_browsers()` - graceful degradation
  - **Files**:
    - `frontend/src/widget/core/ShadowContainer.ts`
    - `frontend/src/widget/core/WidgetCore.ts` (extend)

### Task 54.2: Add Error Boundary and Recovery

- [ ] Implement widget-level error handling (2 files, ~80 LOC)
  - **Tests**: `frontend/tests/widget/error-boundary.test.ts`
    - `test_catches_render_errors()` - prevents page crash
    - `test_shows_fallback_ui_on_error()` - user sees message
    - `test_logs_error_to_console()` - debugging support
    - `test_reports_error_to_backend()` - observability
    - `test_recovery_button_reinitializes()` - user can retry
  - **Files**:
    - `frontend/src/widget/core/ErrorBoundary.ts`
    - `frontend/src/widget/components/ErrorFallback.ts`

### Task 54.3: Add Bundle Versioning Strategy

- [ ] Implement version-aware loading (3 files, ~50 LOC)
  - **Tests**: `frontend/tests/widget/versioning.test.ts`
    - `test_bundle_includes_version_in_name()` - widget.v1.2.3.js
    - `test_version_exposed_on_global()` - HelixChat.version
    - `test_init_logs_version()` - debugging support
  - **Files**:
    - `frontend/vite.widget.config.ts` (extend)
    - `frontend/src/widget/version.ts`
    - `backend/api/routers/widget.py` (serve versioned bundle)

### Task 54.4: Add CSP Compliance Mode

- [ ] Support strict Content Security Policy environments (1 file, ~40 LOC)
  - **Tests**: `frontend/tests/widget/csp-compliance.test.ts`
    - `test_no_inline_styles_in_strict_mode()` - uses classes only
    - `test_no_eval_usage()` - CSP-safe code
    - `test_nonce_support_for_styles()` - configurable nonce
  - **Files**:
    - `frontend/src/widget/core/CspMode.ts`
  - **Config**: `HelixChat.init({ cspMode: 'strict', styleNonce: 'abc123' })`

### Task 54.5: Handle Multiple Instances and Conflicts

- [ ] Support multiple widgets and conflict resolution (1 file, ~60 LOC)
  - **Tests**: `frontend/tests/widget/multi-instance.test.ts`
    - `test_detects_existing_helix_global()` - warns on conflict
    - `test_noconflict_mode_available()` - HelixChat.noConflict()
    - `test_multiple_instances_independent()` - isolated state
    - `test_destroy_removes_single_instance()` - clean cleanup
  - **Files**:
    - `frontend/src/widget/api/multiInstance.ts`

---

## Impact on Roadmap

- P49b (UI Components) must use Shadow DOM container from Task 54.1
- P49c (Services) must integrate with error reporting from Task 54.2
- All downstream phases must respect CSP mode when generating styles
- Bundle versioning affects deployment process documentation
