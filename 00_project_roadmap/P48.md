# P48: Improvement Plan for P46.md

## What's Weak / Missing

- **No conversation history loading**: Task 46.2 maps PSID to device_id, but doesn't address how existing conversation context is loaded. Users returning after 5 minutes will appear as new conversations.

- **Async processing lacks queue strategy**: Uses FastAPI BackgroundTasks, but architecture doc mentions Redis queue for "longer-running tasks". No decision on which approach applies here or when to escalate.

- **Missing Messenger-specific response formatting**: Facebook Messenger has specific limits (2000 char max, no markdown rendering in some clients). No mention of truncation or format conversion.

- **Attachment handling gap**: Task 45.2 parses attachments, Task 46.6 tests attachment handling, but no Task 46.x implements actual attachment processing logic. Test exists with no implementation to test.

- **No quick replies / button support**: Messenger supports rich response types (quick replies, buttons, templates). Entire feature surface ignored.

- **No retry logic for Send API**: Tests exist for rate limiting and user-blocked scenarios, but no retry strategy defined. Single failures will leave users without responses.

- **Timeout not configurable**: "200 returned within 20 seconds" is hardcoded assumption. Different deployments may need different thresholds.

- **Error handling task (46.5) is a bolt-on**: Error handling added as final task means other tasks implemented without error handling in mind. Should be woven in earlier.

- **Missing observability events**: Architecture defines `message_received`, `intent_classified`, `response_generated`, `response_sent` events. None emitted in P46.

- **No graceful shutdown handling**: What happens to in-flight background tasks when service restarts? Messages could be lost.

- **V1/V2 safety not addressed**: Architecture doc emphasizes "V1 is PRODUCTION - Never modify without approval" but P46 doesn't reference this or clarify implementation target.

- **Missing circuit breaker for Send API**: If Facebook's Send API is down, we'll keep hammering it and fill up background task queue.

---

## Why This Matters

1. **Broken conversations**: Without history loading, returning users restart conversations. This degrades chatbot quality and frustrates users.

2. **Lost messages on restart**: No graceful shutdown means deployments during peak hours could silently drop user messages.

3. **Response truncation**: Messages over 2000 chars will be rejected by Facebook with no fallback, leaving users without responses.

4. **Unbounded retries**: Without circuit breaker, Send API failures cascade into queue buildup, memory exhaustion, and total service failure.

5. **Test-implementation mismatch**: Attachment handling test in 46.6 has no corresponding implementation task - test will fail or be skipped.

6. **Silent failures**: No observability means we can't measure success rate, latency distribution, or identify failing patterns.

---

## Proposed Improvements

### 48.1: Add Conversation Context Loading

Expand Task 46.2 to include:

- Tests:
  - `test_handler_loads_existing_conversation_by_psid()`
  - `test_handler_creates_new_conversation_if_none_exists()`
  - `test_handler_includes_recent_history_in_context()`
  - `test_handler_respects_conversation_ttl()`
- Implementation: Query Redis conversation memory by PSID, include last N messages in chat API call

### 48.2: Define Queue Escalation Strategy

Add decision section to P46:

| Message Type | Processing Strategy |
|--------------|---------------------|
| Text message < 200 chars | BackgroundTasks (fast path) |
| Text message >= 200 chars | BackgroundTasks with timeout |
| Attachment | Redis queue (slow path) |
| Multiple concurrent from same user | Redis queue (serialization) |

Add to Task 46.3:
- `test_long_message_uses_background_task()`
- `test_attachment_queued_for_async_processing()`

### 48.3: Add Response Formatter for Messenger

Insert new Task 46.2a (after 46.2):

**Task 46.2a: Messenger Response Formatter (~70 LOC)**
- Tests: `tests/unit/test_messenger_formatter.py`
  - `test_truncates_response_to_2000_chars()`
  - `test_truncation_preserves_sentence_boundary()`
  - `test_strips_markdown_from_response()`
  - `test_adds_ellipsis_when_truncated()`
  - `test_splits_long_response_into_multiple_messages()`
- Files: `services/messenger_formatter.py`

### 48.4: Add Attachment Processing Task

Insert new Task 46.2b (after 46.2a):

**Task 46.2b: Attachment Handler (~80 LOC)**
- Tests: `tests/unit/test_messenger_attachment_handler.py`
  - `test_image_attachment_acknowledged()`
  - `test_file_attachment_returns_unsupported_message()`
  - `test_audio_attachment_returns_unsupported_message()`
  - `test_location_attachment_ignored()`
- Files: `services/messenger_attachment_handler.py`
- Note: V1 scope is acknowledgment only. Full processing deferred to future phase.

### 48.5: Add Retry Logic with Circuit Breaker

Expand Task 46.1 to include:

- Tests:
  - `test_send_retries_on_transient_error()`
  - `test_send_stops_after_3_retries()`
  - `test_circuit_breaker_opens_after_5_failures()`
  - `test_circuit_breaker_allows_probe_after_cooldown()`
  - `test_circuit_open_returns_cached_fallback()`
- Implementation: Exponential backoff (1s, 2s, 4s), circuit breaker with 30s cooldown

### 48.6: Add Timeout Configuration

Add to Configuration table:

| Setting | Environment Variable | Default | Notes |
|---------|---------------------|---------|-------|
| Processing Timeout | `MESSENGER_PROCESSING_TIMEOUT_MS` | 15000 | Max time before returning 200 |
| Send API Timeout | `MESSENGER_SEND_TIMEOUT_MS` | 5000 | Timeout for Send API calls |
| Retry Count | `MESSENGER_MAX_RETRIES` | 3 | Max retry attempts |

Add to Task 46.3:
- `test_processing_timeout_configurable()`
- `test_send_timeout_configurable()`

### 48.7: Integrate Error Handling Early

Restructure build order to integrate error handling from the start:

**Remove Task 46.5 as standalone. Distribute into:**
- Task 46.1: Add error logging to Send API client
- Task 46.2: Add error handling to handler service
- Task 46.3: Add error handling to async processor

This ensures error handling is tested incrementally, not bolted on.

### 48.8: Add Observability Events

Insert new Task 46.4a (after 46.4):

**Task 46.4a: Messenger Observability (~60 LOC)**
- Tests: `tests/integration/test_messenger_observability.py`
  - `test_message_received_event_emitted()`
  - `test_response_sent_event_emitted()`
  - `test_send_api_error_event_emitted()`
  - `test_processing_latency_recorded()`
- Files: `services/messenger_processor.py` (extend)
- Emit events to existing observability service with:
  - `event_type`: message_received, response_sent, send_failed
  - `latency_ms`: processing time
  - `platform`: "messenger"
  - `psid`: (hashed for privacy)

### 48.9: Add Graceful Shutdown Handler

Insert new Task 46.5a (after 46.4a):

**Task 46.5a: Graceful Shutdown (~50 LOC)**
- Tests: `tests/integration/test_messenger_shutdown.py`
  - `test_shutdown_waits_for_inflight_messages()`
  - `test_shutdown_timeout_forces_exit()`
  - `test_queued_messages_persisted_to_redis()`
- Files: `services/messenger_processor.py` (extend)
- Implementation: Register FastAPI shutdown hook, wait up to 10s for in-flight tasks

### 48.10: Add V2 Safety Assertion

Add explicit statement to P46 Scope section:

> This phase extends the **V2 webhook** implemented in P45. All routing uses `/messenger/v2/webhook`. The V1 webhook (`/messenger/webhook`) is not modified.

Add to Task 46.4:
- `test_processor_only_wired_to_v2_endpoint()`

---

## Impact on Roadmap

| Affected Phase | Impact |
|----------------|--------|
| P46 | +4 tasks (46.2a Formatter, 46.2b Attachments, 46.4a Observability, 46.5a Shutdown), restructured error handling |
| P45 | Can assume P46 handles its own error logging (reduced scope) |
| Future Phases | Rich response types (buttons, templates) deferred to P49+ |
| Timeline | +2-3 days due to new tasks, partially offset by cleaner structure |
| Risk Profile | Significantly reduced - circuit breaker prevents cascade failures |

### Revised Build Order

```
46.1 Send API Client (with retry + circuit breaker)
  ├──▶ 46.2 Messenger Handler (with conversation loading)
  │     ├──▶ 46.2a Response Formatter
  │     └──▶ 46.2b Attachment Handler
  │           └──▶ 46.3 Async Processor (with error handling)
  │                 └──▶ 46.4 Webhook Integration
  │                       └──▶ 46.4a Observability
  │                             └──▶ 46.5a Graceful Shutdown
  │                                   └──▶ 46.6 Integration Tests
```

### New Success Criteria for P46

Add:
- [ ] Returning users have conversation context loaded
- [ ] Responses truncated to 2000 chars with ellipsis
- [ ] Attachment messages receive acknowledgment
- [ ] Circuit breaker prevents Send API cascade failures
- [ ] Observability events emitted for all message flows
- [ ] In-flight messages completed on graceful shutdown
- [ ] Processing timeout configurable via environment

### Future Phase Placeholder

Create P49 placeholder for rich Messenger features:
- Quick replies
- Button templates
- Generic templates
- Persistent menu
- Get Started button
