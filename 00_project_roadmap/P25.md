# P25: P18 Similarity Search Improvements

## 1. Objective

**What**: Enhance P18 similarity search with result re-ranking, hybrid search, search analytics, and personalization hooks.

**Why**: P18 provides basic vector search. Production RAG needs result quality improvements through re-ranking, analytics for optimization, and hybrid search for keyword precision.

**Scope**:
- Included: Cross-encoder re-ranking, hybrid search (vector + keyword), search analytics, result explanation, A/B testing hooks
- Excluded: Learning to rank, personalized embeddings, real-time retraining

**Dependencies**: P18 (Similarity Search)

---

## 2. Implementation Tasks

### Task 25.1: Cross-Encoder Re-ranking

- [ ] Re-rank results with cross-encoder for quality (2 files, ~70 LOC)
  - **Tests**: `tests/unit/test_search_rerank.py`
    - `test_rerank_improves_relevance()` - better ordering after rerank
    - `test_rerank_preserves_top_k()` - returns requested count
    - `test_rerank_handles_empty()` - graceful with no results
    - `test_rerank_optional()` - can disable via parameter
    - `test_rerank_latency_tracked()` - metrics include rerank time
  - **Files**: `backend/services/search_reranker.py`, `backend/services/similarity_service.py`
  - **Implementation**:
    ```python
    class SearchReranker:
        async def rerank(
            self,
            query: str,
            results: List[SearchResult],
            top_k: int
        ) -> List[SearchResult]:
            """Re-rank results using cross-encoder model."""

    # In SimilarityService:
    async def search(
        self,
        query: str,
        top_k: int = 5,
        rerank: bool = True,  # Enable re-ranking by default
        ...
    ) -> Tuple[List[SearchResult], SearchMetrics]:
    ```

### Task 25.2: Hybrid Search (Vector + Keyword)

- [ ] Combine vector and keyword search (2 files, ~80 LOC)
  - **Tests**: `tests/unit/test_hybrid_search.py`
    - `test_hybrid_combines_scores()` - RRF fusion works
    - `test_hybrid_keyword_boost()` - exact matches ranked higher
    - `test_hybrid_vector_only_fallback()` - works without keyword matches
    - `test_hybrid_weights_configurable()` - alpha parameter works
    - `test_hybrid_handles_special_chars()` - SQL injection safe
  - **Files**: `backend/services/hybrid_search.py`, `backend/repositories/similarity_repository.py`
  - **Implementation**:
    ```python
    class HybridSearchService:
        async def search(
            self,
            query: str,
            top_k: int = 5,
            vector_weight: float = 0.7,
            keyword_weight: float = 0.3
        ) -> List[SearchResult]:
            """Combine vector similarity with keyword matching."""

    # Reciprocal Rank Fusion for score combination
    def rrf_fusion(
        vector_results: List[SearchResult],
        keyword_results: List[SearchResult],
        k: int = 60
    ) -> List[SearchResult]:
        """Fuse two result lists using RRF."""
    ```

### Task 25.3: Search Analytics

- [ ] Track search patterns for optimization (2 files, ~60 LOC)
  - **Tests**: `tests/unit/test_search_analytics.py`
    - `test_query_logged()` - search queries stored
    - `test_result_clicks_tracked()` - click-through recorded
    - `test_no_results_queries_flagged()` - identifies gaps
    - `test_popular_queries_ranked()` - frequency analysis
    - `test_analytics_anonymized()` - no PII in logs
  - **Files**: `backend/services/search_analytics.py`, `backend/models/search_log.py`
  - **Implementation**:
    ```python
    class SearchLog(BaseModel):
        __tablename__ = "search_log"

        query_hash: Mapped[str]  # Hashed for privacy
        result_count: int
        top_score: Optional[float]
        latency_ms: float
        clicked_result_id: Optional[UUID]
        timestamp: Mapped[datetime]

    async def get_search_insights(days: int = 30) -> SearchInsights:
        """Analyze search patterns for optimization."""

    @dataclass
    class SearchInsights:
        total_searches: int
        avg_results: float
        zero_result_rate: float
        popular_terms: List[Tuple[str, int]]
        avg_latency_ms: float
    ```

### Task 25.4: Result Explanation

- [ ] Explain why results matched (1 file, ~50 LOC)
  - **Tests**: `tests/unit/test_search_explain.py`
    - `test_explanation_includes_score()` - similarity score present
    - `test_explanation_includes_matching_terms()` - keyword overlap
    - `test_explanation_includes_category_match()` - filter contribution
    - `test_explanation_human_readable()` - clear text format
  - **Files**: `backend/services/search_explainer.py`
  - **Implementation**:
    ```python
    @dataclass
    class SearchExplanation:
        similarity_score: float
        matching_keywords: List[str]
        category_boost: float
        rerank_adjustment: float
        explanation_text: str  # "Matched 85% similar, keywords: [x, y]"

    def explain_result(
        query: str,
        result: SearchResult,
        search_params: dict
    ) -> SearchExplanation:
        """Generate human-readable explanation for result ranking."""
    ```

### Task 25.5: A/B Testing Hooks

- [ ] Support search algorithm experiments (1 file, ~40 LOC)
  - **Tests**: `tests/unit/test_search_ab.py`
    - `test_ab_variant_assignment()` - consistent user assignment
    - `test_ab_metrics_tracked_separately()` - per-variant metrics
    - `test_ab_control_vs_treatment()` - different algorithms
    - `test_ab_percentage_split()` - configurable traffic split
  - **Files**: `backend/services/search_ab.py`
  - **Implementation**:
    ```python
    class SearchABTest:
        def __init__(
            self,
            experiment_id: str,
            control_weight: float = 0.5
        ):
            ...

        def get_variant(self, user_id: str) -> str:
            """Deterministically assign user to variant."""

        async def track_outcome(
            self,
            user_id: str,
            variant: str,
            clicked: bool
        ):
            """Track experiment outcomes."""
    ```

---

## 3. Success Criteria

- [ ] Cross-encoder re-ranking improves result relevance
- [ ] Hybrid search combines vector and keyword scores
- [ ] Search analytics identify zero-result queries
- [ ] Result explanations clarify ranking decisions
- [ ] A/B testing hooks enable algorithm experiments
- [ ] All features optional and configurable
- [ ] Search latency remains < 500ms with re-ranking
- [ ] All tests pass: `pytest tests/unit/test_search_rerank.py tests/unit/test_hybrid_search.py tests/unit/test_search_analytics.py tests/unit/test_search_explain.py tests/unit/test_search_ab.py -v`
