# P18a: Similarity Search - Foundation

## 1. Objective

**What**: Build search foundation: configuration, similarity repository, and query embedding cache.

**Why**: These components are prerequisites for the search service. Configuration centralizes settings, repository handles pgvector queries, cache reduces API costs.

**Scope**:
- Included: Search configuration, similarity repository with pgvector, query embedding cache
- Excluded: Search service (P18b), API endpoint (P18b)

**Dependencies**: P14 (Embedding model), P17 (Embedding client for query embedding)

---

## 2. Implementation Tasks

### Task 18a.1: Create Search Configuration

- [ ] Centralize search configuration (1 file, ~30 LOC)
  - **Tests**: `tests/unit/test_search_config.py`
    - `test_default_threshold_configurable()` - reads from env
    - `test_threshold_bounds_validated()` - 0.0-1.0 enforced
    - `test_max_query_length_configurable()` - reads from env
  - **Files**: `backend/config/search.py`
  - **Implementation**:
    ```python
    @dataclass
    class SearchConfig:
        default_threshold: float = float(os.getenv("SEARCH_DEFAULT_THRESHOLD", "0.7"))
        min_threshold: float = 0.3  # Below this is noise
        max_threshold: float = 1.0
        max_query_length: int = int(os.getenv("SEARCH_MAX_QUERY_LENGTH", "8000"))
        cache_ttl_seconds: int = int(os.getenv("SEARCH_CACHE_TTL", "3600"))
    ```

### Task 18a.2: Create Similarity Repository

- [ ] Create database layer for pgvector similarity queries (2 files, ~100 LOC)
  - **Tests**: `tests/unit/test_similarity_repository.py`
    - `test_find_similar_returns_results()` - returns QA pairs with scores
    - `test_find_similar_orders_by_similarity()` - highest similarity first
    - `test_find_similar_respects_limit()` - returns max K results
    - `test_find_similar_excludes_deleted()` - soft-deleted not returned
    - `test_find_similar_filters_by_status()` - only ACTIVE by default
    - `test_find_similar_filters_by_category()` - category filter works
    - `test_find_similar_filters_by_tags()` - tag filter works
    - `test_find_similar_empty_database()` - returns empty list
  - **Files**: `backend/repositories/similarity_repository.py`, `backend/repositories/__init__.py`
  - **Implementation**:
    ```python
    @dataclass
    class SimilarityResult:
        qa_pair: QAPair
        similarity_score: float  # 0.0 to 1.0

    class SimilarityRepository:
        def find_similar(
            self,
            query_vector: List[float],
            limit: int = 5,
            status: QAStatus = QAStatus.ACTIVE,
            category: Optional[str] = None,
            tags: Optional[List[str]] = None
        ) -> List[SimilarityResult]:
            """Find QA pairs similar to query vector using cosine similarity."""
    ```
  - **SQL**:
    ```sql
    SELECT qa_pair.*, 1 - (embedding.vector <=> :query_vector) AS similarity
    FROM embedding
    JOIN qa_pair ON qa_pair.id = embedding.qa_pair_id
    WHERE qa_pair.status = 'active'
      AND qa_pair.deleted_at IS NULL
    ORDER BY embedding.vector <=> :query_vector
    LIMIT :top_k
    ```

### Task 18a.3: Add Query Embedding Cache

- [ ] Cache query embeddings in Redis (1 file, ~70 LOC)
  - **Tests**: `tests/unit/test_search_cache.py`
    - `test_cache_hit_returns_cached_embedding()` - no API call on hit
    - `test_cache_miss_generates_and_stores()` - API call on miss
    - `test_cache_expires_after_ttl()` - embeddings expire
    - `test_cache_key_includes_model_version()` - different models separate
  - **Files**: `backend/services/query_cache.py`
  - **Implementation**:
    ```python
    class QueryEmbeddingCache:
        def __init__(self, redis: Redis, config: SearchConfig, model_version: str):
            ...

        async def get_or_generate(
            self,
            query: str,
            generator: Callable[[str], Awaitable[List[float]]]
        ) -> Tuple[List[float], bool]:  # (embedding, cache_hit)
            cache_key = f"query_embedding:{self.model_version}:{hash(query)}"
            cached = await self.redis.get(cache_key)
            if cached:
                return json.loads(cached), True
            embedding = await generator(query)
            await self.redis.setex(cache_key, self.config.cache_ttl_seconds, json.dumps(embedding))
            return embedding, False
    ```

---

## 3. Success Criteria

- [ ] Configuration loads threshold and query length from env
- [ ] Repository returns results ordered by similarity
- [ ] Repository filters by status, category, tags
- [ ] Repository excludes soft-deleted QA pairs
- [ ] Cache reduces API calls for repeated queries
- [ ] Cache keys include model version
- [ ] All tests pass: `pytest tests/unit/test_search_config.py tests/unit/test_similarity_repository.py tests/unit/test_search_cache.py -v`
