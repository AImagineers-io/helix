# P28c: Improvement Plan for P27c.md

## What's Weak / Missing

- **Profanity/injection pattern storage undefined**: `_load_profanity_list()` referenced but no specification of where data lives (file, DB, env).
- **No Unicode/homoglyph bypass protection**: Profanity detection uses simple string matching. Trivially bypassed with lookalike characters.
- **Audit log storage missing**: "logs flagged messages" mentioned but no data model or storage mechanism for audit trail.
- **Escalation flag not in context**: P27a's PipelineContext doesn't have `escalation_requested` field that P27c references.
- **LLM intent classification cost unbounded**: Can call LLM for every ambiguous message. No rate limit or caching.
- **Canned responses not language-aware**: User receives English "Hello!" even if they wrote in Tagalog.
- **Missing feedback intent handler**: IntentType has FEEDBACK but CannedResponses has no feedback response.
- **Pattern update requires redeploy**: No mechanism to update moderation patterns or canned responses at runtime.
- **ModerationResult confidence unused**: Confidence score returned but no decision logic uses it.

---

## Why This Matters

Moderation is a safety-critical component. Bypassable profanity filters expose the system to abuse. Missing audit logs mean no visibility into blocked content for compliance. Unbounded LLM calls for intent classification can cost more than the actual responses. Language-unaware canned responses break the multi-language promise of Helix.

---

## Proposed Improvements

### Task 28c.1: Define Pattern Storage and Loading

- [ ] Create pattern repository with hot-reload capability (2 files, ~80 LOC)
  - **Tests**: `tests/unit/test_pattern_repository.py`
    - `test_loads_profanity_from_database()`
    - `test_loads_injection_patterns_from_database()`
    - `test_caches_patterns_with_ttl()`
    - `test_hot_reload_picks_up_changes()`
  - **Files**: `backend/repositories/pattern_repository.py`, `backend/models/moderation_pattern.py`
  - **Implementation**:
    ```python
    class ModerationPattern(Base):
        id: UUID
        pattern_type: str  # "profanity", "injection", "spam"
        pattern: str
        is_regex: bool
        severity: str  # "low", "medium", "high"
        is_active: bool

    class PatternRepository:
        def __init__(self, session: Session, cache: Redis, ttl_seconds: int = 300):
            ...
        def get_patterns(self, pattern_type: str) -> List[ModerationPattern]:
            ...
    ```

### Task 28c.2: Add Unicode Normalization and Homoglyph Detection

- [ ] Normalize text before moderation checks (1 file modification, ~40 LOC)
  - **Tests**: `tests/unit/test_moderation_service.py`
    - `test_detects_homoglyph_bypass()` - "fÃ¼ck" with special u
    - `test_detects_zero_width_characters()`
    - `test_normalizes_unicode_before_check()`
  - **Files**: `backend/services/moderation_service.py`
  - **Implementation**:
    ```python
    import unicodedata
    from confusables import normalize  # pip install confusables

    def _normalize_text(self, text: str) -> str:
        # Remove zero-width chars
        text = re.sub(r'[\u200b-\u200f\u2060\ufeff]', '', text)
        # Normalize Unicode
        text = unicodedata.normalize('NFKC', text)
        # Normalize confusables/homoglyphs
        text = normalize(text)
        return text.lower()
    ```

### Task 28c.3: Create Moderation Audit Log

- [ ] Store flagged messages for review (2 files, ~60 LOC)
  - **Tests**: `tests/unit/test_moderation_audit.py`
    - `test_flagged_message_creates_audit_record()`
    - `test_audit_includes_reason_and_context()`
    - `test_audit_retention_policy_enforced()`
  - **Files**: `backend/models/moderation_audit.py`, `backend/repositories/moderation_audit_repository.py`
  - **Implementation**:
    ```python
    class ModerationAuditLog(Base):
        id: UUID
        conversation_id: Optional[UUID]
        device_id: str
        original_message: str
        normalized_message: str
        reason: str
        confidence: float
        created_at: datetime
    ```

### Task 28c.4: Add Intent Classification Cost Control

- [ ] Cache intent results and rate limit LLM calls (1 file modification, ~35 LOC)
  - **Tests**: `tests/unit/test_intent_service.py`
    - `test_caches_intent_for_similar_messages()`
    - `test_rate_limits_llm_calls()`
    - `test_falls_back_to_question_when_rate_limited()`
  - **Files**: `backend/services/intent_service.py`
  - **Implementation**:
    ```python
    class IntentService:
        def __init__(self, ..., llm_calls_per_minute: int = 10):
            self._intent_cache = {}  # Simple LRU
            self._llm_rate_limiter = RateLimiter(llm_calls_per_minute)

        def classify(self, text: str) -> IntentResult:
            cache_key = self._normalize_for_cache(text)
            if cache_key in self._intent_cache:
                return self._intent_cache[cache_key]
            ...
    ```

### Task 28c.5: Make Canned Responses Language-Aware

- [ ] Store canned responses per language (1 file modification, ~40 LOC)
  - **Tests**: `tests/unit/test_canned_responses.py`
    - `test_returns_response_in_user_language()`
    - `test_falls_back_to_english_if_unavailable()`
    - `test_loads_multilingual_responses()`
  - **Files**: `backend/pipeline/processors/canned_responses.py`
  - **Implementation**:
    ```python
    @dataclass
    class CannedResponses:
        responses: Dict[str, Dict[str, List[str]]]  # {lang: {intent: [responses]}}

        def get(self, intent: IntentType, language: str = "en") -> Optional[str]:
            lang_responses = self.responses.get(language, self.responses.get("en", {}))
            intent_responses = lang_responses.get(intent.value, [])
            return random.choice(intent_responses) if intent_responses else None
    ```

### Task 28c.6: Add Feedback Intent Handler

- [ ] Handle feedback intent with acknowledgment (1 file modification, ~15 LOC)
  - **Tests**: `tests/unit/test_canned_responses.py`
    - `test_has_positive_feedback_responses()`
    - `test_has_negative_feedback_responses()`
  - **Files**: `backend/pipeline/processors/canned_responses.py`
  - **Implementation**:
    ```python
    responses = {
        "en": {
            "feedback": [
                "Thank you for your feedback!",
                "I appreciate you letting me know.",
            ]
        }
    }
    ```

---

## Impact on Roadmap

- **P27a**: PipelineContext must include `escalation_requested` field (covered in P28a).
- **P27b**: Canned response selection now depends on detected language.
- **P27e**: Integration tests must verify audit logging and language-aware responses.
- **Admin Dashboard**: Future phase needs UI for managing moderation patterns.
- **Database migrations**: New tables for ModerationPattern and ModerationAuditLog.
