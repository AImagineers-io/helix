# P73: Analytics Data Models

## 1. Objective

**What**: Create CostRecord and ObservabilityEvent database models for tracking per-request costs and pipeline events.

**Why**: DailyAggregate exists but lacks per-request granularity. Cost tracking needs provider/model breakdown. Observability requires event tracing for debugging.

**Scope**:
- Included: CostRecord model, ObservabilityEvent model, migrations
- Excluded: Service layer, API endpoints, aggregation jobs

## 2. Implementation Tasks

- [ ] CostRecord model (2 files, ~80 LOC)
  - Tests: tests/unit/test_cost_record_model.py
  - Files: database/models.py, alembic/versions/xxx_add_cost_record.py
  - Fields: id, conversation_id (nullable), message_id (nullable), provider, model, input_tokens, output_tokens, cost, timestamp

- [ ] ObservabilityEvent model (2 files, ~60 LOC)
  - Tests: tests/unit/test_observability_event_model.py
  - Files: database/models.py, alembic/versions/xxx_add_observability_event.py
  - Depends on: P73.1
  - Fields: id, conversation_id, event_type, payload (JSON), duration_ms, timestamp, correlation_id

- [ ] Conversation model stub (2 files, ~40 LOC)
  - Tests: tests/unit/test_conversation_model.py
  - Files: database/models.py, alembic/versions/xxx_add_conversation.py
  - Depends on: P73.1
  - Fields: id, device_id, platform, created_at (required for FK relationships)

- [ ] Message model stub (2 files, ~50 LOC)
  - Tests: tests/unit/test_message_model.py
  - Files: database/models.py, alembic/versions/xxx_add_message.py
  - Depends on: P73.3
  - Fields: id, conversation_id (FK), role, content, created_at

## 3. Success Criteria

- [ ] All model unit tests pass
- [ ] Migrations apply cleanly on fresh database
- [ ] Migrations rollback cleanly
- [ ] Models support required queries (by conversation, by date range, by provider)
- [ ] Index exists on cost_records.timestamp, cost_records.provider
- [ ] Index exists on observability_events.conversation_id, observability_events.event_type
