# P44: Improvement Plan for P43.md

## What's Weak / Missing

- **No Repository Layer**: P43 jumps from models directly to services. The codebase uses repository pattern (P15a has QARepository). ConversationRepository and MessageRepository are missing.
- **Enums Not Defined**: Platform (web/messenger/api) and MessageRole (user/assistant) enums mentioned but no task creates them.
- **No Pipeline Integration Task**: Endpoint must wire into P27 pipeline but no explicit task shows how `PipelineOrchestrator` is instantiated and called.
- **Sequencing Error**: Task 43.8 (Migration) depends on 43.1/43.2 but should run BEFORE 43.4 (Service) since integration tests need real tables.
- **Invalid conversation_id Handling**: No test or decision for what happens when conversation_id doesn't exist (404? Create new? Ignore?).
- **Redis Fallback Incomplete**: "Graceful fallback to empty" loses context. Should fall back to DB query for recent messages.
- **No Concurrency Handling**: Multiple simultaneous requests on same conversation can cause race conditions in message ordering.
- **device_id Not Validated**: No format validation, length limit, or sanitization for device_id field.
- **Memory-Service Relationship Undefined**: Does ConversationService use ConversationMemory internally or are they called separately by the endpoint?
- **Missing E2E Integration Test**: No test exercises full path: /chat → pipeline → LLM mock → response.

---

## Why This Matters

Without the repository layer, the service violates the architecture pattern established in P15a. This creates inconsistency and makes future refactoring harder.

Missing enum definitions will cause import errors at runtime. The sequencing error means Task 43.4 tests will fail because tables don't exist yet.

Invalid conversation_id returning 500 instead of 404 is a poor API contract. Redis-only memory with empty fallback means users lose conversation context on Redis blip - unacceptable UX.

Race conditions on concurrent requests cause message ordering bugs that are hard to reproduce and debug in production.

---

## Proposed Improvements

### Task 44.1: Add Conversation Enums

- [ ] Create Platform and MessageRole enums (1 file, ~20 LOC)
  - **Tests**: `tests/unit/test_conversation_enums.py`
    - `test_platform_has_web()` - Platform.WEB exists
    - `test_platform_has_messenger()` - Platform.MESSENGER exists
    - `test_platform_has_api()` - Platform.API exists
    - `test_message_role_has_user()` - MessageRole.USER exists
    - `test_message_role_has_assistant()` - MessageRole.ASSISTANT exists
  - **Files**: `backend/models/enums.py` (extend existing)
  - **Insert before**: Task 43.1

### Task 44.2: Add Conversation Repository

- [ ] Create repository with active query patterns (2 files, ~80 LOC)
  - **Tests**: `tests/unit/test_conversation_repository.py`
    - `test_create_conversation()` - inserts and returns
    - `test_get_by_id()` - retrieves by UUID
    - `test_get_by_id_not_found()` - returns None for missing
    - `test_get_by_device_id()` - finds by device_id
    - `test_get_active_for_device()` - finds recent conversation within TTL
    - `test_update_last_activity()` - touches timestamp
  - **Files**: `backend/repositories/conversation_repository.py`, `backend/repositories/__init__.py`
  - **Insert after**: Task 43.1, before Task 43.4

### Task 44.3: Add Message Repository

- [ ] Create repository for message persistence (1 file, ~60 LOC)
  - **Tests**: `tests/unit/test_message_repository.py`
    - `test_create_message()` - inserts with conversation_id
    - `test_get_recent_messages()` - returns last N ordered by timestamp
    - `test_get_messages_for_conversation()` - all messages for conversation
    - `test_bulk_create()` - insert multiple messages (for sync)
  - **Files**: `backend/repositories/message_repository.py`
  - **Insert after**: Task 43.2, before Task 43.4

### Task 44.4: Fix Migration Sequencing

- [ ] Move migration to run before service tasks
  - **Change**: Task 43.8 must complete before Task 43.4 starts
  - **Rationale**: Service integration tests require tables to exist
  - **New order**: 43.1 → 43.2 → 43.8 → 44.2 → 44.3 → 43.3 → 43.4 → 43.5 → 43.6 → 43.7

### Task 44.5: Add Redis-to-DB Fallback

- [ ] Extend conversation memory with DB fallback (1 file modification, ~40 LOC)
  - **Tests**: `tests/unit/test_conversation_memory.py` (extend)
    - `test_memory_falls_back_to_db_on_redis_miss()` - queries MessageRepository
    - `test_memory_falls_back_to_db_on_redis_down()` - graceful degradation
    - `test_memory_caches_db_result_in_redis()` - repopulates cache
  - **Files**: `backend/services/conversation_memory.py` (extend)
  - **Depends on**: Task 44.3

### Task 44.6: Add Conversation ID Validation

- [ ] Validate conversation_id exists and belongs to device (1 file modification, ~30 LOC)
  - **Tests**: `tests/integration/test_chat_endpoint.py` (extend)
    - `test_invalid_conversation_id_returns_404()` - UUID not found
    - `test_malformed_conversation_id_returns_400()` - not valid UUID
    - `test_conversation_id_wrong_device_returns_404()` - device mismatch
  - **Files**: `backend/api/routers/chat.py` (extend)
  - **Depends on**: Task 43.6

### Task 44.7: Add Pipeline Integration

- [ ] Wire endpoint to PipelineOrchestrator (1 file modification, ~50 LOC)
  - **Tests**: `tests/integration/test_chat_pipeline_integration.py`
    - `test_endpoint_invokes_pipeline()` - pipeline.process() called
    - `test_endpoint_passes_context_correctly()` - message, device_id, history
    - `test_endpoint_returns_pipeline_response()` - final_response used
    - `test_endpoint_handles_pipeline_error()` - graceful on pipeline failure
  - **Files**: `backend/api/routers/chat.py` (extend)
  - **Depends on**: Task 43.6, P27e

### Task 44.8: Add device_id Validation

- [ ] Validate device_id format and sanitize (1 file modification, ~25 LOC)
  - **Tests**: `tests/unit/test_chat_schemas.py` (extend)
    - `test_device_id_max_length()` - max 255 characters
    - `test_device_id_sanitized()` - strips dangerous characters
    - `test_device_id_rejects_empty()` - cannot be blank
    - `test_device_id_rejects_whitespace_only()` - must have content
  - **Files**: `backend/schemas/chat.py` (extend)

### Task 44.9: Add Concurrency Guard

- [ ] Prevent race conditions on same conversation (1 file, ~40 LOC)
  - **Tests**: `tests/integration/test_chat_concurrency.py`
    - `test_concurrent_requests_ordered()` - messages have correct sequence
    - `test_lock_prevents_interleaving()` - Redis lock acquired per conversation
    - `test_lock_timeout_releases()` - doesn't deadlock on crash
  - **Files**: `backend/services/conversation_lock.py`
  - **Implementation**: Redis-based distributed lock with conversation_id key
  - **Depends on**: Task 43.6

---

## Impact on Roadmap

### Modified Task Order for P43

```
44.1 Enums
  └──▶ 43.1 Conversation Model
        └──▶ 43.2 Message Model
              └──▶ 43.8 Migration (MOVED UP)
                    └──▶ 44.2 Conversation Repository
                          └──▶ 44.3 Message Repository
                                └──▶ 43.3 Conversation Memory
                                      └──▶ 44.5 DB Fallback
                                            └──▶ 43.4 Conversation Service
                                                  └──▶ 43.5 Chat Schema + 44.8 device_id validation
                                                        └──▶ 43.6 Chat Endpoint
                                                              └──▶ 44.6 conversation_id validation
                                                                    └──▶ 44.7 Pipeline Integration
                                                                          └──▶ 44.9 Concurrency Guard
                                                                                └──▶ 43.7 Error Handling
```

### Downstream Effects

- **P45+ (if any)**: Must import from `repositories/` not directly from services for data access
- **Messenger webhook**: When it uses /chat internally, benefits from conversation_id validation
- **Analytics**: Can query MessageRepository directly for conversation metrics

### LOC Impact

Original P43: ~600 LOC
Additional from P44: ~345 LOC
New total: ~945 LOC (still reasonable for single phase)
