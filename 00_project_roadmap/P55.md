# Improvement Plan for P49b.md

## What's Weak / Missing

- No dark mode or theming system - branding colors may clash with dark host pages
- Missing RTL (right-to-left) language support - Arabic, Hebrew users excluded
- No animation performance targets - janky animations on low-end devices
- Missing component lifecycle and cleanup - memory leaks on destroy
- No reduced motion support - accessibility violation (WCAG 2.1)
- Missing high contrast mode support - accessibility gap
- No viewport edge handling - bubble clips off screen at edges
- Missing focus visible styles - keyboard users can't see focus
- No component rendering strategy specified (DOM manipulation approach)
- Missing z-index collision handling with host page

## Why This Matters

Accessibility gaps expose clients to legal liability (ADA, WCAG compliance). RTL exclusion loses Middle Eastern markets. Memory leaks degrade host page performance over time. Animation jank damages brand perception.

## Proposed Improvements

### Task 55.1: Implement Theming System with Dark Mode

- [ ] Create theme provider with light/dark/system modes (3 files, ~120 LOC)
  - **Tests**: `frontend/tests/widget/theming.test.ts`
    - `test_applies_light_theme_by_default()` - default state
    - `test_applies_dark_theme_when_configured()` - explicit dark
    - `test_detects_system_preference()` - prefers-color-scheme
    - `test_theme_switch_updates_all_components()` - reactive
    - `test_branding_colors_adjust_for_contrast()` - readable text
  - **Files**:
    - `frontend/src/widget/theme/ThemeProvider.ts`
    - `frontend/src/widget/theme/lightTheme.ts`
    - `frontend/src/widget/theme/darkTheme.ts`

### Task 55.2: Add RTL Language Support

- [ ] Support right-to-left text direction (2 files, ~80 LOC)
  - **Tests**: `frontend/tests/widget/rtl.test.ts`
    - `test_detects_rtl_from_language()` - Arabic, Hebrew, Farsi
    - `test_message_alignment_flips_in_rtl()` - user right, bot left
    - `test_input_direction_matches_language()` - typing direction
    - `test_bubble_position_respects_rtl()` - mirrors position
    - `test_animations_flip_in_rtl()` - slide direction correct
  - **Files**:
    - `frontend/src/widget/core/DirectionProvider.ts`
    - `frontend/src/widget/styles/rtl.ts`

### Task 55.3: Add Accessibility Enhancements

- [ ] Implement reduced motion and high contrast support (2 files, ~70 LOC)
  - **Tests**: `frontend/tests/widget/a11y.test.ts`
    - `test_respects_prefers_reduced_motion()` - no animations
    - `test_high_contrast_mode_borders()` - visible boundaries
    - `test_focus_visible_ring_on_keyboard()` - focus indicator
    - `test_focus_not_visible_on_mouse()` - clean mouse UX
    - `test_minimum_touch_target_size()` - 44x44px minimum
  - **Files**:
    - `frontend/src/widget/styles/a11y.ts`
    - `frontend/src/widget/core/MotionProvider.ts`

### Task 55.4: Add Component Lifecycle Management

- [ ] Implement proper component cleanup (2 files, ~90 LOC)
  - **Tests**: `frontend/tests/widget/lifecycle.test.ts`
    - `test_component_removes_event_listeners()` - no leaks
    - `test_component_clears_timers()` - no orphan timers
    - `test_component_removes_dom_nodes()` - clean DOM
    - `test_destroy_called_on_all_children()` - recursive cleanup
    - `test_memory_stable_after_reinit()` - no growth
  - **Files**:
    - `frontend/src/widget/core/Component.ts` (base class)
    - `frontend/src/widget/core/LifecycleManager.ts`

### Task 55.5: Add Viewport Edge Handling

- [ ] Prevent widget clipping at screen edges (1 file, ~50 LOC)
  - **Tests**: `frontend/tests/widget/viewport.test.ts`
    - `test_bubble_stays_within_viewport()` - no overflow
    - `test_window_repositions_near_edge()` - smart placement
    - `test_handles_viewport_resize()` - responsive adjustment
    - `test_handles_virtual_keyboard()` - mobile input focus
  - **Files**:
    - `frontend/src/widget/core/ViewportManager.ts`

### Task 55.6: Define Animation Performance Budget

- [ ] Set and enforce 60fps animation targets (1 file, ~40 LOC)
  - **Tests**: `frontend/tests/widget/animation-perf.test.ts`
    - `test_animations_use_transform_only()` - GPU accelerated
    - `test_animations_use_will_change()` - compositor hints
    - `test_no_layout_thrashing()` - batched reads/writes
  - **Files**:
    - `frontend/src/widget/styles/animations.ts`
  - **Constraints**:
    - Only animate: transform, opacity
    - Max animation duration: 300ms
    - Use requestAnimationFrame for JS animations

---

## Impact on Roadmap

- P49c (Branding) must integrate with ThemeProvider from Task 55.1
- P49c (Message State) must provide language code for RTL detection
- All component files in P49b must extend base Component class from Task 55.4
- P49e (E2E Tests) must include RTL and accessibility test scenarios
