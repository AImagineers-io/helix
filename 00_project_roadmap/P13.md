# P13: Database Setup (pgvector)

## 1. Objective

**What**: Enable PostgreSQL's pgvector extension for vector storage and similarity search operations.

**Why**: Helix is a RAG chatbot. RAG requires similarity search over embeddings. Standard PostgreSQL cannot perform vector operations. pgvector adds cosine similarity, L2 distance, and inner product operations needed for semantic search.

**Scope**:
- Included: pgvector extension migration, vector utility module, SQLite fallback for unit tests, pre-flight database checks
- Excluded: QA/Embedding models (P14), services (P15+), API endpoints (P16+)

**Dependencies**: None (foundational phase)

---

## 2. Implementation Tasks

### Task 13.1: Add pgvector Dependencies

- [ ] Create vector requirements file (2 files, ~15 LOC)
  - **Tests**: `tests/unit/test_imports.py`
    - `test_pgvector_package_importable()` - package imports without error
  - **Files**: `backend/requirements-vector.txt`, `backend/requirements.txt`
  - **Content**:
    ```
    pgvector>=0.2.0,<0.3.0
    # Requires PostgreSQL pgvector extension >= 0.5.0
    ```
  - **Behavior**: Main requirements.txt includes this file

### Task 13.2: Pre-flight Database Check

- [ ] Create database capability checker (1 file, ~50 LOC)
  - **Tests**: `tests/unit/test_db_preflight.py`
    - `test_check_postgresql_connection()` - verifies connection
    - `test_check_pgvector_extension_exists()` - extension installed
    - `test_check_pgvector_version()` - meets minimum version
    - `test_preflight_returns_report()` - structured result
  - **Files**: `backend/db/preflight.py`
  - **Implementation**:
    ```python
    def check_database_capabilities(engine) -> PreflightReport:
        """Returns structured report of database capabilities."""

    @dataclass
    class PreflightReport:
        is_postgresql: bool
        has_pgvector: bool
        pgvector_version: Optional[str]
        can_create_vector_columns: bool
        errors: List[str]
    ```

### Task 13.3: Vector Support Utility Module

- [ ] Create vector support detection and SQLite fallback (1 file, ~60 LOC)
  - **Tests**: `tests/unit/test_vector_support.py`
    - `test_detects_postgresql_with_pgvector()` - returns True for PostgreSQL with extension
    - `test_detects_sqlite_no_vector()` - returns False for SQLite
    - `test_get_vector_column_type_postgresql()` - returns pgvector Vector type
    - `test_get_vector_column_type_sqlite()` - returns JSON fallback type
    - `test_qa_pair_model_loads_on_sqlite()` - works without vector
    - `test_embedding_model_uses_json_on_sqlite()` - graceful fallback
  - **Files**: `backend/db/vector.py`
  - **Implementation**:
    ```python
    def has_vector_support(engine) -> bool:
        """Check if database supports vectors."""

    def get_vector_column_type(dimensions: int):
        """Return Vector type for PostgreSQL, JSON for SQLite."""
        if _is_postgresql():
            from pgvector.sqlalchemy import Vector
            return Vector(dimensions)
        return JSON  # Fallback: store as list

    # Pytest marker for tests requiring pgvector
    requires_pgvector = pytest.mark.skipif(
        not has_vector_support(engine),
        reason="Requires PostgreSQL with pgvector"
    )
    ```

### Task 13.4: pgvector Migration

- [ ] Create Alembic migration with safety guards (1 file, ~50 LOC)
  - **Tests**: `tests/integration/test_migrations.py`
    - `test_pgvector_migration_applies_cleanly()` - migration runs without error
    - `test_pgvector_extension_enabled()` - extension exists after migration
    - `test_migration_idempotent()` - running twice doesn't fail
    - `test_migration_skips_on_sqlite()` - no error on SQLite
    - `test_downgrade_warns_if_embeddings_exist()` - logs warning
  - **Files**: `backend/alembic/versions/xxxx_enable_pgvector.py`
  - **Implementation**:
    - Execute `CREATE EXTENSION IF NOT EXISTS vector`
    - Log pgvector version after creation
    - Downgrade: Count embeddings, warn if > 0, then drop extension
    - Skip gracefully if not PostgreSQL

---

## 3. Success Criteria

- [ ] `python -c "from pgvector.sqlalchemy import Vector"` succeeds
- [ ] Pre-flight check reports accurate database capabilities
- [ ] Migration applies on PostgreSQL 15+ with pgvector extension installed
- [ ] Migration skips cleanly on SQLite (no error, logged warning)
- [ ] `has_vector_support()` returns correct boolean for each database type
- [ ] `get_vector_column_type()` returns Vector on PostgreSQL, JSON on SQLite
- [ ] Unit tests run with SQLite without pgvector errors
- [ ] All tests pass: `pytest tests/unit/test_vector_support.py tests/unit/test_db_preflight.py tests/integration/test_migrations.py -v`
- [ ] Coverage â‰¥80% for `backend/db/vector.py`, `backend/db/preflight.py`

---

## 4. Technical Notes

**PostgreSQL Setup** (db01 already has this):
```sql
CREATE EXTENSION IF NOT EXISTS vector;
```

**Vector Dimensions**: 1536 (OpenAI text-embedding-3-small)

**Test Strategy**:
- Unit tests use SQLite (fast, no pgvector) with JSON fallback
- Integration tests require PostgreSQL with pgvector
- Use `@pytest.mark.requires_pgvector` for pgvector-specific tests
