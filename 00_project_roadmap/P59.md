# P59: Import Job Model & Foundation

## 1. Objective

**What**: Create database model for tracking import jobs and foundation utilities for the import system.

**Why**: Imports can be large (1000+ QA pairs) and slow (embedding generation). Job tracking provides progress indication, error reporting, and ability to investigate failed imports. A solid foundation enables consistent error handling and progress tracking across all parsers.

**Scope**:
- Included: ImportJob model, ImportJobStatus enum, import exception hierarchy, progress tracking schema
- Excluded: Parsers (P60), validation (P61), batch processing (P62), API endpoints (P63)

**Dependencies**: P14 (QAPair model), P15a (base exceptions)

---

## 2. Implementation Tasks

### Task 59.1: Create Import Exceptions

- [ ] Define import service exception hierarchy (1 file, ~60 LOC)
  - **Tests**: `tests/unit/test_import_exceptions.py`
    - `test_parse_error_has_line_number()` - stores row context
    - `test_validation_error_has_field()` - stores field and value
    - `test_duplicate_error_has_existing_id()` - stores matching pair ID
    - `test_import_job_not_found_has_id()` - stores job ID
  - **Files**: `backend/exceptions/import_job.py`
  - **Implementation**:
    ```python
    class ImportError(Exception):
        """Base exception for import system."""

    class ParseError(ImportError):
        def __init__(self, line_number: int, message: str, raw_data: str = None):
            self.line_number = line_number
            self.raw_data = raw_data

    class ImportValidationError(ImportError):
        def __init__(self, row: int, field: str, message: str):
            self.row = row
            self.field = field

    class DuplicateDetectedError(ImportError):
        def __init__(self, row: int, existing_id: UUID, similarity: float):
            self.row = row
            self.existing_id = existing_id
            self.similarity = similarity

    class ImportJobNotFoundError(ImportError):
        def __init__(self, job_id: UUID):
            self.job_id = job_id
    ```

### Task 59.2: Create Import Status Enum

- [ ] Define import job status enum (1 file, ~20 LOC)
  - **Tests**: `tests/unit/test_import_models.py`
    - `test_import_status_has_pending()` - ImportJobStatus.PENDING
    - `test_import_status_has_processing()` - ImportJobStatus.PROCESSING
    - `test_import_status_has_completed()` - ImportJobStatus.COMPLETED
    - `test_import_status_has_failed()` - ImportJobStatus.FAILED
    - `test_import_status_has_cancelled()` - ImportJobStatus.CANCELLED
  - **Files**: `backend/models/enums.py` (extend)
  - **Values**: `PENDING`, `PROCESSING`, `COMPLETED`, `FAILED`, `CANCELLED`

### Task 59.3: Create ImportJob Model

- [ ] Create ImportJob SQLAlchemy model (2 files, ~80 LOC)
  - **Tests**: `tests/unit/test_import_models.py`
    - `test_import_job_create()` - model instantiates
    - `test_import_job_defaults()` - status PENDING, counters zero
    - `test_import_job_tracks_total_rows()` - total_rows field
    - `test_import_job_tracks_processed_rows()` - processed_rows field
    - `test_import_job_tracks_success_count()` - success_count field
    - `test_import_job_tracks_error_count()` - error_count field
    - `test_import_job_stores_source_type()` - csv/json/text
    - `test_import_job_stores_filename()` - original filename
    - `test_import_job_stores_errors_json()` - error details list
    - `test_import_job_has_timestamps()` - started_at, completed_at
  - **Files**: `backend/models/import_job.py`, `backend/models/__init__.py`
  - **Implementation**:
    ```python
    class ImportJob(BaseModel):
        __tablename__ = "import_job"

        status: Mapped[ImportJobStatus] = mapped_column(default=ImportJobStatus.PENDING)
        source_type: Mapped[str] = mapped_column(String(20))  # csv, json, text
        filename: Mapped[str] = mapped_column(String(255))
        total_rows: Mapped[int] = mapped_column(default=0)
        processed_rows: Mapped[int] = mapped_column(default=0)
        success_count: Mapped[int] = mapped_column(default=0)
        error_count: Mapped[int] = mapped_column(default=0)
        errors: Mapped[list] = mapped_column(JSON, default=list)
        started_at: Mapped[Optional[datetime]] = mapped_column(nullable=True)
        completed_at: Mapped[Optional[datetime]] = mapped_column(nullable=True)
    ```

### Task 59.4: Create ImportJob Repository

- [ ] Create data access for ImportJob model (2 files, ~70 LOC)
  - **Tests**: `tests/unit/test_import_repository.py`
    - `test_create_import_job()` - inserts and returns job
    - `test_get_by_id()` - retrieves by UUID
    - `test_get_by_id_not_found()` - returns None
    - `test_update_progress()` - updates counters
    - `test_update_status()` - transitions status
    - `test_list_by_status()` - filters by status
    - `test_add_error()` - appends to errors JSON
  - **Files**: `backend/repositories/import_repository.py`
  - **Implementation**:
    ```python
    class ImportJobRepository:
        def create(self, job: ImportJob) -> ImportJob
        def get_by_id(self, job_id: UUID) -> Optional[ImportJob]
        def update_progress(self, job_id: UUID, processed: int, success: int, errors: int)
        def update_status(self, job_id: UUID, status: ImportJobStatus)
        def add_error(self, job_id: UUID, error: dict)
        def list_by_status(self, status: ImportJobStatus, limit: int) -> List[ImportJob]
    ```

### Task 59.5: Database Migration for ImportJob

- [ ] Create Alembic migration for import_job table (1 file, ~40 LOC)
  - **Tests**: `tests/integration/test_migrations.py`
    - `test_import_job_table_created()` - table exists
    - `test_import_job_indexes_created()` - status index exists
  - **Files**: `backend/alembic/versions/xxxx_create_import_job.py`
  - **Indexes**: `ix_import_job_status`

---

## 3. Success Criteria

- [ ] ImportJob model tracks all progress fields
- [ ] Status enum covers full lifecycle
- [ ] Repository supports CRUD and progress updates
- [ ] Errors stored as structured JSON array
- [ ] Migration applies cleanly
- [ ] All tests pass: `pytest tests/unit/test_import_*.py -v`
- [ ] Coverage â‰¥80% for import models and repository
