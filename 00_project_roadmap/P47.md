# P47: Improvement Plan for P45.md

## What's Weak / Missing

- **No environment variable documentation in phase scope**: FB_VERIFY_TOKEN, FB_APP_SECRET are implied but not explicitly listed as prerequisites. Team could start implementation without knowing what secrets to provision.

- **Missing error response schemas**: Tasks 45.3 and 45.4 test for 403/400 responses but no Pydantic schema defines the error payload structure. Frontend/monitoring cannot reliably parse error responses.

- **Signature validation edge cases omitted**:
  - No test for missing/unconfigured FB_APP_SECRET (startup validation)
  - No test for signature algorithm mismatch (SHA256 vs SHA1)
  - No replay attack protection (timestamp validation)

- **No observability integration**: Architecture doc specifies `message_received` event type, but P45 has zero structured logging or event emission. Webhook activity will be invisible to monitoring.

- **Build order is artificially sequential**: Tasks 45.3 (Verification Endpoint), 45.4 (Signature Middleware), and 45.6 (Router Registration) have no code dependencies on each other. Current build order adds unnecessary serialization.

- **Missing idempotency handling**: Facebook retries webhook requests on timeout/error. Without deduplication, duplicate messages will be processed and sent to users.

- **No explicit timeout validation test**: Success criteria states POST must return 200, but no test validates the endpoint meets Facebook's 20-second requirement under load.

- **V1/V2 versioning unclear**: Architecture doc shows `/messenger/webhook` (V1) vs `/messenger/v2/webhook` (V2) with V1 marked PRODUCTION. P45 doesn't clarify which version is being implemented or how the two will coexist.

- **No rate limiting consideration**: Architecture specifies 60 req/min per device, but no mention of rate limiting on the webhook endpoint itself.

- **Missing health check for Messenger subsystem**: No way to verify Messenger integration is properly configured before traffic arrives.

---

## Why This Matters

1. **Deployment risk**: Missing environment variable documentation means deployments will fail in staging/production when secrets aren't provisioned. This causes last-minute scrambling.

2. **Silent failures**: Without observability, webhook failures are invisible. Facebook will silently stop sending messages after repeated failures, and we won't know until users complain.

3. **Duplicate messages**: Facebook's retry behavior means users will receive duplicate responses. This erodes trust and inflates LLM costs.

4. **Velocity loss**: Sequential build order when parallel work is possible extends delivery timeline unnecessarily.

5. **Production incident risk**: V1/V2 confusion could lead to accidentally modifying the production webhook, breaking live chatbot.

---

## Proposed Improvements

### 47.1: Add Environment Variable Prerequisites

Add a Configuration section at the top of P45 listing all required environment variables:

| Variable | Required | Description |
|----------|----------|-------------|
| `ENABLE_MESSENGER` | Yes | Feature flag to enable/disable Messenger routes |
| `FB_VERIFY_TOKEN` | Yes | Webhook verification token (must match Facebook App settings) |
| `FB_APP_SECRET` | Yes | App secret for signature validation |

Add startup validation test to Task 45.4:
- `test_startup_fails_if_fb_app_secret_missing()`

### 47.2: Define Error Response Schema

Add to Task 45.1:
- Create `WebhookErrorResponse` schema with `error: str`, `code: str` fields
- Add tests:
  - `test_error_response_schema_validates()`
  - `test_error_response_includes_code()`

### 47.3: Expand Signature Validation Test Coverage

Add to Task 45.4:
- `test_signature_sha1_rejected()` - Only SHA256 accepted
- `test_missing_app_secret_returns_500()` - Config error, not user error
- `test_signature_with_empty_body()` - Edge case

### 47.4: Add Observability Integration Task

Insert new Task 45.4a (after 45.4):

**Task 45.4a: Webhook Observability Events (~50 LOC)**
- Tests: `tests/integration/test_messenger_observability.py`
  - `test_verification_attempt_logged()`
  - `test_signature_failure_logged_with_details()`
  - `test_message_received_event_emitted()`
  - `test_invalid_payload_logged()`
- Files: `api/routers/messenger.py` (extend), emit to existing observability service

### 47.5: Add Message Deduplication

Insert new Task 45.5a (after 45.5):

**Task 45.5a: Message Deduplication (~60 LOC)**
- Tests: `tests/integration/test_messenger_deduplication.py`
  - `test_duplicate_message_id_ignored()`
  - `test_different_message_ids_processed()`
  - `test_dedup_cache_expires_after_5_minutes()`
- Files: `services/messenger_dedup.py`
- Implementation: Redis-based message ID cache with 5-minute TTL

### 47.6: Revise Build Order for Parallelization

Update Build Order to:

```
45.1 Schemas
  └──▶ 45.2 Event Parser
        ├──▶ 45.3 Verification Endpoint ─────┐
        ├──▶ 45.4 Signature Middleware ─────┼──▶ 45.5 Webhook POST
        └──▶ 45.4a Observability ───────────┘         │
                                                      └──▶ 45.5a Deduplication
                                                            └──▶ 45.6 Router Registration
```

Tasks 45.3, 45.4, and 45.4a can be developed in parallel after 45.2.

### 47.7: Clarify V2 Implementation

Add explicit statement to P45 Objective section:

> This phase implements the **V2 webhook** (`/messenger/v2/webhook`). The existing V1 webhook (`/messenger/webhook`) remains untouched per safety rules. After P46 stabilizes, Facebook App configuration will be updated to point to V2.

Add to Task 45.6:
- `test_v1_webhook_routes_unchanged()` - Regression test ensuring V1 still works
- `test_v2_routes_independent_of_v1()`

### 47.8: Add Messenger Health Check

Add to Task 45.6:

**Health Check Sub-task**
- Tests:
  - `test_messenger_health_check_returns_config_status()`
  - `test_messenger_health_check_fails_if_secrets_missing()`
- Endpoint: `GET /messenger/health` returning:
  ```json
  {
    "enabled": true,
    "verify_token_configured": true,
    "app_secret_configured": true
  }
  ```

---

## Impact on Roadmap

| Affected Phase | Impact |
|----------------|--------|
| P45 | +2 tasks (45.4a Observability, 45.5a Deduplication), expanded test coverage |
| P46 | Can assume deduplication is handled upstream, simplifies processor |
| Timeline | Net neutral - parallelization offsets new tasks |
| Risk Profile | Significantly reduced - observability and idempotency prevent silent failures |

### Dependency Changes

- P46 Task 46.3 (Async Processor) can now rely on deduplication being handled in P45
- Remove deduplication concerns from P46 scope

### New Success Criteria for P45

Add:
- [ ] Webhook events logged with structured format
- [ ] Duplicate message IDs deduplicated within 5-minute window
- [ ] V2 webhook path used (`/messenger/v2/webhook`)
- [ ] V1 webhook regression test passes
- [ ] Health check endpoint validates configuration
