# P71: Improvement Plan for P64.md

## Target Phase

P64: Admin UI Integration

---

## What's Weak / Missing

- **Client-side preview parsing duplicates backend logic**: Maintaining two parser implementations creates drift risk
- **No accessibility (a11y) requirements**: Dropzone, progress bar, modals may be unusable for screen readers
- **Missing loading states**: No skeleton screens or spinners during initial data fetch
- **No error boundaries**: Component crash takes down entire page
- **Polling interval hardcoded**: 2-second interval not adjustable; wasteful for slow imports, laggy for fast ones
- **No WebSocket option**: Polling is inefficient; real-time updates require WebSocket or SSE
- **Missing keyboard navigation**: Dropzone requires mouse; power users can't tab-navigate
- **No responsive design requirements**: Mobile/tablet admin users unsupported
- **File type detection by extension only**: User renames .exe to .csv, uploads successfully
- **No confirmation for large imports**: User accidentally imports 10k rows without warning
- **Missing import template downloads**: New users don't know expected format
- **No drag-and-drop visual feedback**: No indication that dropzone is active during drag
- **State machine not explicitly defined**: Implicit transitions lead to edge case bugs

---

## Why This Matters

- **Maintenance burden**: Two parsers (frontend preview + backend) means bugs fixed in one but not other
- **Accessibility compliance**: Public sector clients may require WCAG compliance
- **Poor UX on errors**: Component crash without error boundary shows blank page, no recovery path
- **Bandwidth waste**: Polling every 2 seconds for 5-minute import = 150 unnecessary requests
- **User confusion**: No template means trial-and-error format discovery

---

## Proposed Improvements

### 1. Replace Client-Side Preview with Server-Side Validation

Remove client-side parsing; use server-side preview endpoint:

```typescript
// New API endpoint (add to P63)
// POST /qa/import/preview - returns parsed preview without importing

// frontend/src/services/ImportApi.ts
export const importApi = {
  // ...existing methods

  preview: async (file: File): Promise<PreviewResponse> => {
    const formData = new FormData();
    formData.append('file', file);
    const response = await fetch('/api/qa/import/preview', {
      method: 'POST',
      body: formData,
    });
    return response.json();
  },
};

interface PreviewResponse {
  rows: ParsedQA[];          // First 10 rows
  totalRows: number;
  validationWarnings: string[];
  duplicateWarnings: DuplicateMatch[];
  estimatedTime: string;     // "~2 minutes"
}
```

Update Task 64.3 to use server preview instead of client parsing.

### 2. Add Accessibility Requirements

```typescript
// ImportDropzone.tsx
<div
  role="button"
  tabIndex={0}
  aria-label="Drop zone for file upload. Press Enter or Space to open file browser."
  aria-describedby="dropzone-instructions"
  onKeyDown={(e) => {
    if (e.key === 'Enter' || e.key === ' ') {
      fileInputRef.current?.click();
    }
  }}
  onDragEnter={handleDragEnter}
  onDragLeave={handleDragLeave}
  onDrop={handleDrop}
>
  <input
    type="file"
    ref={fileInputRef}
    aria-hidden="true"
    // ...
  />
  <p id="dropzone-instructions" className="visually-hidden">
    Accepted formats: CSV, JSON, TXT, XLSX. Maximum size: 10MB.
  </p>
</div>

// ImportProgress.tsx
<div
  role="progressbar"
  aria-valuenow={percentComplete}
  aria-valuemin={0}
  aria-valuemax={100}
  aria-label={`Import progress: ${percentComplete}% complete, ${processedRows} of ${totalRows} rows`}
>
  <div className="progress-bar" style={{ width: `${percentComplete}%` }} />
</div>
```

Add tests:
- `test_dropzone_accessible_by_keyboard()`
- `test_progress_bar_has_aria_attributes()`
- `test_modal_traps_focus()`

### 3. Add Loading States

```typescript
// ImportPage.tsx
const [pageState, setPageState] = useState<
  'loading' | 'idle' | 'file_selected' | 'uploading' | 'processing' | 'complete' | 'error'
>('loading');

useEffect(() => {
  // Check for any active imports on page load
  importApi.getActiveJobs().then(jobs => {
    if (jobs.length > 0) {
      setActiveJob(jobs[0]);
      setPageState('processing');
    } else {
      setPageState('idle');
    }
  });
}, []);

// Skeleton during loading
if (pageState === 'loading') {
  return <ImportPageSkeleton />;
}
```

### 4. Add Error Boundaries

```typescript
// frontend/src/components/ErrorBoundary.tsx
class ImportErrorBoundary extends React.Component<Props, State> {
  state = { hasError: false, error: null };

  static getDerivedStateFromError(error: Error) {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
    console.error('Import component error:', error, errorInfo);
    // Send to error tracking service
  }

  render() {
    if (this.state.hasError) {
      return (
        <div className="error-fallback">
          <h2>Something went wrong</h2>
          <p>The import interface encountered an error.</p>
          <button onClick={() => this.setState({ hasError: false })}>
            Try Again
          </button>
        </div>
      );
    }
    return this.props.children;
  }
}

// Wrap import page
<ImportErrorBoundary>
  <ImportPage />
</ImportErrorBoundary>
```

### 5. Add Adaptive Polling with SSE Option

```typescript
// frontend/src/hooks/useImportStatus.ts
export function useImportStatus(jobId: string, useSSE: boolean = true) {
  const [status, setStatus] = useState<JobStatusResponse | null>(null);

  useEffect(() => {
    if (useSSE) {
      // Use Server-Sent Events for real-time updates
      const eventSource = new EventSource(`/api/qa/import/${jobId}/stream`);

      eventSource.onmessage = (event) => {
        const data = JSON.parse(event.data);
        setStatus(data);

        if (data.status === 'completed' || data.status === 'failed') {
          eventSource.close();
        }
      };

      return () => eventSource.close();
    } else {
      // Fallback to adaptive polling
      let interval = 2000;
      const poll = async () => {
        const data = await importApi.getStatus(jobId);
        setStatus(data);

        // Adaptive interval based on progress rate
        const progressRate = data.processedRows / (Date.now() - startTime);
        if (progressRate < 1) {
          interval = Math.min(interval * 1.5, 10000); // Slow down for slow imports
        }

        if (data.status !== 'completed' && data.status !== 'failed') {
          setTimeout(poll, interval);
        }
      };

      poll();
    }
  }, [jobId, useSSE]);

  return status;
}
```

Backend SSE endpoint (add to P63):
```python
@router.get("/qa/import/{job_id}/stream")
async def stream_import_status(job_id: UUID, session: Session = Depends(get_db)):
    """Stream import status updates via Server-Sent Events."""
    async def event_generator():
        while True:
            job = job_repository.get_by_id(job_id)
            if not job:
                yield {"event": "error", "data": json.dumps({"error": "Job not found"})}
                break

            yield {"event": "status", "data": json.dumps(JobStatusResponse.from_orm(job).dict())}

            if job.status in (ImportJobStatus.COMPLETED, ImportJobStatus.FAILED, ImportJobStatus.CANCELLED):
                break

            await asyncio.sleep(1)

    return EventSourceResponse(event_generator())
```

### 6. Add Responsive Design

```css
/* ImportDropzone.css */
.import-dropzone {
  min-height: 200px;
  padding: 2rem;
}

@media (max-width: 768px) {
  .import-dropzone {
    min-height: 150px;
    padding: 1rem;
  }

  .import-dropzone .icon {
    display: none;  /* Hide icon on mobile, show text */
  }
}

/* ImportProgress.css */
.import-progress-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
  gap: 1rem;
}
```

### 7. Add Confirmation for Large Imports

```typescript
// ImportPreview.tsx
const LARGE_IMPORT_THRESHOLD = 1000;

const handleConfirm = async () => {
  if (previewData.totalRows > LARGE_IMPORT_THRESHOLD) {
    const confirmed = await showConfirmDialog({
      title: 'Large Import',
      message: `You are about to import ${previewData.totalRows.toLocaleString()} rows. This may take several minutes. Continue?`,
      confirmText: 'Start Import',
      cancelText: 'Cancel',
    });

    if (!confirmed) return;
  }

  onConfirm();
};
```

### 8. Add Template Downloads

```typescript
// ImportPage.tsx
<div className="import-help">
  <h3>Download Templates</h3>
  <ul>
    <li>
      <a href="/api/qa/import/template/csv" download="qa-template.csv">
        CSV Template
      </a>
    </li>
    <li>
      <a href="/api/qa/import/template/json" download="qa-template.json">
        JSON Template
      </a>
    </li>
    <li>
      <a href="/api/qa/import/template/xlsx" download="qa-template.xlsx">
        Excel Template
      </a>
    </li>
  </ul>
</div>
```

Backend template endpoint (add to P63):
```python
@router.get("/qa/import/template/{format}")
async def download_template(format: str = Path(..., regex="^(csv|json|xlsx)$")):
    """Download import template file."""
    templates = {
        "csv": ("text/csv", "question,answer,category,tags\n\"What is X?\",\"X is...\",\"General\",\"faq,example\"\n"),
        "json": ("application/json", '[{"question":"What is X?","answer":"X is...","category":"General","tags":["faq","example"]}]'),
    }
    # ... generate and return template
```

### 9. Add Drag Visual Feedback

```typescript
// ImportDropzone.tsx
const [isDragging, setIsDragging] = useState(false);
const [isValidFile, setIsValidFile] = useState<boolean | null>(null);

const handleDragEnter = (e: DragEvent) => {
  e.preventDefault();
  setIsDragging(true);

  // Check if dragged file is valid type
  const items = Array.from(e.dataTransfer?.items || []);
  const hasValidFile = items.some(item =>
    item.kind === 'file' &&
    acceptedTypes.some(type => item.type.includes(type) || item.name?.endsWith(type))
  );
  setIsValidFile(hasValidFile);
};

return (
  <div
    className={classNames('dropzone', {
      'dropzone--dragging': isDragging,
      'dropzone--valid': isDragging && isValidFile,
      'dropzone--invalid': isDragging && isValidFile === false,
    })}
    // ...
  >
```

### 10. Define Explicit State Machine

```typescript
// frontend/src/machines/importMachine.ts
import { createMachine, assign } from 'xstate';

type ImportEvent =
  | { type: 'FILE_SELECTED'; file: File }
  | { type: 'PREVIEW_LOADED'; data: PreviewResponse }
  | { type: 'CONFIRM_IMPORT' }
  | { type: 'UPLOAD_SUCCESS'; jobId: string }
  | { type: 'PROGRESS_UPDATE'; progress: JobStatusResponse }
  | { type: 'IMPORT_COMPLETE' }
  | { type: 'ERROR'; error: string }
  | { type: 'RESET' }
  | { type: 'CANCEL' };

export const importMachine = createMachine({
  id: 'import',
  initial: 'idle',
  context: {
    file: null,
    preview: null,
    jobId: null,
    progress: null,
    error: null,
  },
  states: {
    idle: {
      on: { FILE_SELECTED: 'loading_preview' },
    },
    loading_preview: {
      invoke: {
        src: 'loadPreview',
        onDone: { target: 'previewing', actions: 'setPreview' },
        onError: { target: 'error', actions: 'setError' },
      },
    },
    previewing: {
      on: {
        CONFIRM_IMPORT: 'uploading',
        RESET: 'idle',
      },
    },
    uploading: {
      invoke: {
        src: 'uploadFile',
        onDone: { target: 'processing', actions: 'setJobId' },
        onError: { target: 'error', actions: 'setError' },
      },
    },
    processing: {
      on: {
        PROGRESS_UPDATE: { actions: 'setProgress' },
        IMPORT_COMPLETE: 'complete',
        ERROR: 'error',
        CANCEL: 'cancelled',
      },
    },
    complete: {
      on: { RESET: 'idle' },
    },
    error: {
      on: { RESET: 'idle' },
    },
    cancelled: {
      on: { RESET: 'idle' },
    },
  },
});
```

---

## Impact on Roadmap

| Affected Phase | Change |
|----------------|--------|
| P63 | Add `/qa/import/preview` endpoint |
| P63 | Add `/qa/import/{job_id}/stream` SSE endpoint |
| P63 | Add `/qa/import/template/{format}` endpoint |
| P65 | Add accessibility E2E tests |

---

## New Tasks for P64

- **Task 64.9**: Replace client-side preview with server-side preview endpoint
- **Task 64.10**: Add ARIA attributes and keyboard navigation to all components
- **Task 64.11**: Add loading states and skeleton screens
- **Task 64.12**: Implement error boundaries with recovery UI
- **Task 64.13**: Add SSE support with polling fallback
- **Task 64.14**: Add responsive CSS for mobile/tablet
- **Task 64.15**: Add large import confirmation dialog
- **Task 64.16**: Add template download links
- **Task 64.17**: Add drag-and-drop visual feedback
- **Task 64.18**: Implement XState state machine for import flow

---

## Dependency Changes

Add to `frontend/package.json`:
```json
{
  "dependencies": {
    "xstate": "^5.0.0",
    "@xstate/react": "^4.0.0"
  }
}
```
