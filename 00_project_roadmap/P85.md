# P85: Integration Wiring

## 1. Objective

- **What**: Wire all routers, middleware, and service dependencies into a cohesive application
- **Why**: Components built in P13-P84 exist in isolation; this phase connects them into a working system
- **Scope**:
  - Included: Router registration, middleware ordering, DI configuration, migrations
  - Excluded: New feature development, UI changes, performance optimization

## 2. Implementation Tasks

- [ ] Router registration (2 files, ~80 LOC)
  - Tests: tests/integration/test_router_registration.py
  - Files: api/main.py, api/routers/__init__.py
  - Register: /qa, /chat, /messenger, /widget, /observability, /prompts, /analytics
  - Depends on: None

- [ ] Middleware stack ordering (2 files, ~60 LOC)
  - Tests: tests/integration/test_middleware_order.py
  - Files: api/main.py, api/middleware/__init__.py
  - Order: CORS → Security headers → Rate limiting → Auth → Request size
  - Depends on: P85.1

- [ ] Service dependency injection (3 files, ~100 LOC)
  - Tests: tests/integration/test_service_injection.py
  - Files: core/dependencies.py, services/__init__.py, api/main.py
  - Wire: LLMService→ChatPipeline, QAService→RAGProcessor, PromptService→LLMGeneration
  - Depends on: P85.1

- [ ] Alembic migration generation (4 files, ~200 LOC)
  - Tests: tests/integration/test_migrations.py
  - Files: alembic/versions/*.py, alembic/env.py
  - Tables: QAPair, Embedding, Conversation, Message, CostRecord, ObservabilityEvent, ImportJob
  - Depends on: None

- [ ] Migration test suite (1 file, ~60 LOC)
  - Tests: tests/integration/test_migration_safety.py
  - Files: tests/conftest.py
  - Verify: upgrade, downgrade, idempotency
  - Depends on: P85.4

- [ ] pgvector extension setup (1 file, ~30 LOC)
  - Tests: tests/integration/test_pgvector_setup.py
  - Files: alembic/versions/001_enable_pgvector.py
  - Depends on: P85.4

## 3. Success Criteria

- [ ] All routers accessible via OpenAPI docs at /docs
- [ ] Middleware executes in documented order (verified by test)
- [ ] All services instantiate without circular dependency errors
- [ ] Migrations apply cleanly on fresh database
- [ ] Migrations roll back without data loss
- [ ] pgvector extension enabled and vector operations functional
- [ ] Integration tests pass with real database (testcontainers)
