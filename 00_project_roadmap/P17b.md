# P17b: Embedding Service - Advanced Features

## 1. Objective

**What**: Add advanced embedding features: batch processing, cost tracking, health monitoring, retry logic, and auto-generation.

**Why**: Production needs efficient batch processing, cost visibility for budgeting, health stats for monitoring, and automatic embedding generation on QA changes.

**Scope**:
- Included: Batch processing, cost tracking, health monitoring, failed embedding retry, auto-generation on QA create/update
- Excluded: Core service (P17a), similarity search (P18)

**Dependencies**: P17a (embedding service core)

---

## 2. Implementation Tasks

### Task 17b.1: Add Batch Processing

- [ ] Add batch embedding with partial failure handling (1 file, ~70 LOC)
  - **Tests**: `tests/unit/test_embedding_service.py`
    - `test_batch_generate()` - processes multiple QA pairs
    - `test_batch_generate_respects_limit()` - max 100 per batch
    - `test_batch_generate_partial_failure()` - continues on single failure
    - `test_batch_generate_returns_stats()` - success/failure counts
  - **Files**: `backend/services/embedding_service.py`
  - **Implementation**:
    ```python
    @dataclass
    class BatchResult:
        successful: int
        failed: int
        errors: List[str]

    async def batch_generate(self, qa_pair_ids: List[UUID]) -> BatchResult:
        """Generate embeddings for multiple QA pairs."""
    ```

### Task 17b.2: Add Cost Tracking

- [ ] Track embedding API costs (2 files, ~60 LOC)
  - **Tests**: `tests/unit/test_embedding_cost.py`
    - `test_tracks_tokens_used()` - records token count
    - `test_calculates_cost()` - applies rate per 1K tokens
    - `test_aggregates_daily_cost()` - sums for reporting
  - **Files**: `backend/services/embedding_service.py`, `backend/models/embedding_cost.py`
  - **Implementation**:
    ```python
    class EmbeddingCostRecord(BaseModel):
        __tablename__ = "embedding_cost"

        tokens: Mapped[int]
        model: Mapped[str]
        cost_usd: Mapped[float]  # $0.00002 per 1K tokens
        timestamp: Mapped[datetime]
    ```

### Task 17b.3: Add Health Monitoring

- [ ] Add embedding health stats (1 file, ~50 LOC)
  - **Tests**: `tests/unit/test_embedding_health.py`
    - `test_reports_pending_count()` - embeddings awaiting generation
    - `test_reports_failed_count()` - embeddings that failed
    - `test_reports_success_rate()` - percentage successful
    - `test_reports_oldest_pending()` - staleness detection
  - **Files**: `backend/services/embedding_service.py`
  - **Implementation**:
    ```python
    @dataclass
    class EmbeddingHealthStats:
        pending_count: int
        failed_count: int
        completed_count: int
        success_rate: float
        oldest_pending: Optional[datetime]

    async def get_health_stats(self) -> EmbeddingHealthStats
    ```

### Task 17b.4: Add Failed Embedding Retry

- [ ] Implement failed embedding recovery (1 file, ~50 LOC)
  - **Tests**: `tests/unit/test_embedding_retry.py`
    - `test_retry_failed_embeddings()` - reprocesses failed
    - `test_max_retry_count_enforced()` - stops after N failures
    - `test_backoff_between_retries()` - doesn't hammer API
  - **Files**: `backend/services/embedding_service.py`
  - **Method**:
    ```python
    async def retry_failed_embeddings(self, max_retries: int = 3) -> BatchResult:
        """Retry embeddings that failed but haven't exceeded max_retries."""
    ```

### Task 17b.5: Auto-Generation Integration

- [ ] Trigger embedding generation on QA pair create/update (2 files, ~50 LOC)
  - **Tests**: `tests/integration/test_qa_embedding_flow.py`
    - `test_create_qa_triggers_embedding()` - embedding generated after create
    - `test_update_qa_triggers_regeneration()` - embedding updated after edit
    - `test_embedding_failure_doesnt_block_qa()` - QA saved even if embedding fails
  - **Files**: `backend/services/qa_service.py`, `backend/services/embedding_service.py`
  - **Behavior**: Use FastAPI BackgroundTasks to generate asynchronously

---

## 3. Success Criteria

- [ ] Batch embedding processes up to 100 texts efficiently
- [ ] Partial failures don't block entire batch
- [ ] Cost tracked per API call (tokens, USD)
- [ ] Health stats available for monitoring dashboard
- [ ] Failed embeddings can be retried
- [ ] Auto-generation triggers on QA create/update
- [ ] Embedding failures don't block QA operations
- [ ] All tests pass: `pytest tests/unit/test_embedding_service.py tests/unit/test_embedding_cost.py tests/unit/test_embedding_health.py tests/unit/test_embedding_retry.py tests/integration/test_qa_embedding_flow.py -v`
