# P20: P13 Database Setup Improvements

## 1. Objective

**What**: Enhance P13 database setup with production-ready safeguards, better diagnostics, and graceful degradation.

**Why**: P13 establishes basic pgvector support. Production deployments need connection pooling awareness, detailed diagnostics for ops teams, and safer migration behavior.

**Scope**:
- Included: Connection pool health checks, detailed diagnostic logging, migration dry-run mode, extension version compatibility matrix
- Excluded: Performance tuning (later phase), monitoring dashboards

**Dependencies**: P13 (Database Setup)

---

## 2. Implementation Tasks

### Task 20.1: Enhanced Pre-flight Diagnostics

- [ ] Add detailed diagnostic output (1 file, ~40 LOC)
  - **Tests**: `tests/unit/test_db_preflight_enhanced.py`
    - `test_reports_postgresql_version()` - captures PG version
    - `test_reports_available_extensions()` - lists all extensions
    - `test_reports_connection_pool_size()` - shows pool config
    - `test_reports_max_connections()` - shows server limits
    - `test_diagnostic_output_json_serializable()` - can log as JSON
  - **Files**: `backend/db/preflight.py`
  - **Implementation**:
    ```python
    @dataclass
    class ExtendedPreflightReport(PreflightReport):
        postgresql_version: Optional[str]
        available_extensions: List[str]
        connection_pool_size: int
        server_max_connections: int
        current_connections: int

    def get_extended_diagnostics(engine) -> ExtendedPreflightReport:
        """Gather detailed database diagnostics for ops."""
    ```

### Task 20.2: Migration Dry-Run Mode

- [ ] Add migration preview without execution (1 file, ~30 LOC)
  - **Tests**: `tests/unit/test_migration_dryrun.py`
    - `test_dryrun_shows_sql_without_executing()` - no DB changes
    - `test_dryrun_detects_missing_extension()` - warns if pgvector not installed
    - `test_dryrun_estimates_downtime()` - reports expected lock time
  - **Files**: `backend/db/migration_utils.py`
  - **Implementation**:
    ```python
    def preview_migration(migration_script: str, engine) -> MigrationPreview:
        """Show what migration would do without executing."""

    @dataclass
    class MigrationPreview:
        sql_statements: List[str]
        requires_table_lock: bool
        estimated_duration: str
        warnings: List[str]
    ```

### Task 20.3: Extension Version Compatibility

- [ ] Define and check version compatibility matrix (1 file, ~40 LOC)
  - **Tests**: `tests/unit/test_version_compat.py`
    - `test_pgvector_0_5_compatible()` - minimum supported
    - `test_pgvector_0_7_compatible()` - latest tested
    - `test_warns_on_untested_version()` - logs warning for unknown versions
    - `test_blocks_incompatible_version()` - raises on known-bad versions
  - **Files**: `backend/db/version_compat.py`
  - **Implementation**:
    ```python
    PGVECTOR_COMPATIBILITY = {
        "0.5.0": "supported",
        "0.5.1": "supported",
        "0.6.0": "supported",
        "0.7.0": "supported",
        "0.4.x": "unsupported",  # Missing HNSW
    }

    def check_pgvector_compatibility(version: str) -> CompatibilityResult:
        """Check if pgvector version is compatible."""
    ```

### Task 20.4: Connection Pool Health Integration

- [ ] Add health check endpoint for database (1 file, ~30 LOC)
  - **Tests**: `tests/unit/test_db_health.py`
    - `test_health_check_returns_pool_stats()` - active/idle connections
    - `test_health_check_detects_exhausted_pool()` - warns when near limit
    - `test_health_check_measures_latency()` - query round-trip time
  - **Files**: `backend/db/health.py`
  - **Implementation**:
    ```python
    @dataclass
    class DatabaseHealth:
        status: str  # "healthy", "degraded", "unhealthy"
        pool_active: int
        pool_idle: int
        pool_max: int
        latency_ms: float
        pgvector_available: bool

    async def check_database_health(engine) -> DatabaseHealth:
        """Health check suitable for k8s probes."""
    ```

---

## 3. Success Criteria

- [ ] Extended diagnostics capture PostgreSQL version and connection info
- [ ] Migration dry-run shows SQL without executing
- [ ] Version compatibility matrix warns on untested pgvector versions
- [ ] Health check endpoint returns pool statistics
- [ ] All diagnostics are JSON-serializable for structured logging
- [ ] Health check latency < 100ms
- [ ] All tests pass: `pytest tests/unit/test_db_preflight_enhanced.py tests/unit/test_migration_dryrun.py tests/unit/test_version_compat.py tests/unit/test_db_health.py -v`
