# Improvement Plan for P49c.md

## What's Weak / Missing

- No offline/network resilience strategy - widget unusable without connection
- Missing message queue for pending messages - messages lost on network blip
- No retry strategy with exponential backoff - hammers server on transient errors
- Missing message deduplication - duplicate messages on retry
- No optimistic update rollback mechanism - failed messages stuck in UI
- Missing connection status indicator - users don't know they're offline
- No conversation session expiry handling - stale sessions cause errors
- Missing concurrent tab synchronization - conversation splits across tabs
- No request cancellation for abandoned messages - wasted resources
- Missing rate limit backoff - continues hitting 429 errors

## Why This Matters

Network failures are common on mobile. Without resilience, users lose messages, see duplicate responses, and have no feedback about connection state. Concurrent tab issues create confusing split conversations. Rate limit hammering gets client IP blocked.

## Proposed Improvements

### Task 56.1: Implement Message Queue with Retry

- [ ] Queue messages with exponential backoff retry (2 files, ~120 LOC)
  - **Tests**: `frontend/tests/widget/message-queue.test.ts`
    - `test_queues_message_when_offline()` - stores for later
    - `test_sends_queued_on_reconnect()` - automatic retry
    - `test_exponential_backoff_on_failure()` - 1s, 2s, 4s, 8s
    - `test_max_retries_before_fail()` - gives up after 3
    - `test_preserves_message_order()` - FIFO delivery
    - `test_deduplicates_by_client_id()` - no duplicates
  - **Files**:
    - `frontend/src/widget/services/MessageQueue.ts`
    - `frontend/src/widget/services/RetryStrategy.ts`

### Task 56.2: Add Connection Status Management

- [ ] Track and display network status (2 files, ~80 LOC)
  - **Tests**: `frontend/tests/widget/connection-status.test.ts`
    - `test_detects_offline_event()` - navigator.onLine
    - `test_detects_online_event()` - reconnection
    - `test_shows_offline_indicator()` - UI feedback
    - `test_shows_reconnecting_state()` - retry in progress
    - `test_pings_server_to_verify()` - actual connectivity check
  - **Files**:
    - `frontend/src/widget/services/ConnectionMonitor.ts`
    - `frontend/src/widget/components/ConnectionStatus.ts`

### Task 56.3: Implement Optimistic Update Rollback

- [ ] Handle failed message states properly (1 file, ~70 LOC)
  - **Tests**: `frontend/tests/widget/optimistic-rollback.test.ts`
    - `test_marks_message_pending_initially()` - visual indicator
    - `test_marks_message_sent_on_success()` - checkmark
    - `test_marks_message_failed_on_error()` - error indicator
    - `test_retry_button_on_failed_message()` - user retry
    - `test_delete_failed_message_option()` - remove option
  - **Files**:
    - `frontend/src/widget/state/MessageState.ts` (extend)
  - **Message States**: `pending` | `sent` | `delivered` | `failed`

### Task 56.4: Add Tab Synchronization

- [ ] Sync conversation state across browser tabs (1 file, ~90 LOC)
  - **Tests**: `frontend/tests/widget/tab-sync.test.ts`
    - `test_broadcasts_new_message_to_tabs()` - BroadcastChannel
    - `test_other_tabs_receive_message()` - sync works
    - `test_leader_election_for_api_calls()` - one tab fetches
    - `test_graceful_fallback_without_broadcast()` - old browsers
  - **Files**:
    - `frontend/src/widget/services/TabSync.ts`
  - **API**: BroadcastChannel or localStorage events fallback

### Task 56.5: Add Session Expiry Handling

- [ ] Handle expired conversation sessions (1 file, ~60 LOC)
  - **Tests**: `frontend/tests/widget/session-expiry.test.ts`
    - `test_detects_session_expired_response()` - 401/410 status
    - `test_clears_conversation_id_on_expiry()` - fresh start
    - `test_shows_session_expired_message()` - user feedback
    - `test_allows_continue_without_history()` - graceful recovery
  - **Files**:
    - `frontend/src/widget/services/SessionManager.ts`

### Task 56.6: Add Request Cancellation

- [ ] Cancel abandoned requests (1 file, ~40 LOC)
  - **Tests**: `frontend/tests/widget/request-cancellation.test.ts`
    - `test_cancels_request_on_widget_close()` - AbortController
    - `test_cancels_previous_on_new_request()` - latest wins
    - `test_cancelled_request_no_state_update()` - clean abort
  - **Files**:
    - `frontend/src/widget/services/ChatClient.ts` (extend)

---

## Impact on Roadmap

- P49d (Persistence) must integrate with MessageQueue for offline messages
- P49d (Persistence) must sync with TabSync for cross-tab consistency
- P49b (UI Components) must display connection status indicator
- P49b (Message Bubble) must show pending/failed states from Task 56.3
- P49e (E2E Tests) must test offline scenarios and tab sync
