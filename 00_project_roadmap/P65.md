# P65: Import System Integration Tests

## 1. Objective

**What**: Create comprehensive integration tests for the complete import system with real files, database operations, and end-to-end flows.

**Why**: Unit tests verify individual components; integration tests verify the system works together. Parser edge cases are numerous (encodings, malformed files, huge files). Testing with real files catches issues that mocks miss.

**Scope**:
- Included: Parser tests with sample files, validation integration, full import flow tests, performance tests
- Excluded: Unit tests (covered in P59-P64), Admin UI E2E (separate E2E suite)

**Dependencies**: P59-P64 (complete import system)

---

## 2. Implementation Tasks

### Task 65.1: Create Test Fixtures

- [ ] Sample import files for testing (5 files, ~100 LOC total)
  - **Files**:
    - `backend/tests/fixtures/import/valid_qa.csv` - 10 valid rows
    - `backend/tests/fixtures/import/valid_qa.json` - 10 valid objects
    - `backend/tests/fixtures/import/valid_qa.txt` - 10 Q:/A: pairs
    - `backend/tests/fixtures/import/malformed.csv` - missing columns
    - `backend/tests/fixtures/import/unicode.csv` - UTF-8 characters
  - **Content**:
    ```csv
    # valid_qa.csv
    question,answer,category,tags
    "What is the return policy?","You can return items within 30 days.","Returns","policy,refund"
    ...
    ```

### Task 65.2: Parser Integration Tests

- [ ] Test parsers with real files (1 file, ~120 LOC)
  - **Tests**: `tests/integration/test_parser_integration.py`
    - `test_csv_parser_with_real_file()` - parses fixture
    - `test_csv_parser_with_utf8_file()` - handles unicode
    - `test_csv_parser_with_malformed_file()` - appropriate error
    - `test_json_parser_with_real_file()` - parses fixture
    - `test_json_parser_with_invalid_json()` - parse error
    - `test_text_parser_with_real_file()` - parses fixture
    - `test_text_parser_with_mixed_patterns()` - Q:/Question:
    - `test_parser_factory_selects_correct_parser()` - by extension
  - **Files**: `backend/tests/integration/test_parser_integration.py`

### Task 65.3: Validation Integration Tests

- [ ] Test validation pipeline end-to-end (1 file, ~100 LOC)
  - **Tests**: `tests/integration/test_validation_integration.py`
    - `test_validates_parsed_csv()` - full pipeline
    - `test_detects_in_file_duplicates()` - duplicate rows in file
    - `test_detects_db_duplicates()` - matches existing pairs
    - `test_aggregates_all_errors()` - combined report
    - `test_returns_valid_items()` - filtered list
    - `test_handles_large_file()` - 500+ rows efficient
  - **Files**: `backend/tests/integration/test_validation_integration.py`

### Task 65.4: Import Service Integration Tests

- [ ] Test complete import flow (1 file, ~150 LOC)
  - **Tests**: `tests/integration/test_import_service_integration.py`
    - `test_import_csv_creates_qa_pairs()` - DB records created
    - `test_import_json_creates_qa_pairs()` - JSON flow
    - `test_import_text_creates_qa_pairs()` - text flow
    - `test_import_updates_job_progress()` - status transitions
    - `test_import_handles_validation_errors()` - partial success
    - `test_import_handles_parse_errors()` - graceful failure
    - `test_import_triggers_embeddings()` - embedding status
    - `test_import_job_completed_on_success()` - final state
    - `test_import_job_failed_on_fatal_error()` - error state
    - `test_import_records_all_errors()` - error details saved
  - **Files**: `backend/tests/integration/test_import_service_integration.py`

### Task 65.5: API Integration Tests

- [ ] Test import API endpoints end-to-end (1 file, ~120 LOC)
  - **Tests**: `tests/integration/test_import_api_integration.py`
    - `test_upload_csv_endpoint()` - multipart upload
    - `test_upload_json_endpoint()` - JSON file upload
    - `test_upload_text_endpoint()` - text file upload
    - `test_status_endpoint_during_processing()` - progress visible
    - `test_status_endpoint_after_completion()` - final state
    - `test_history_endpoint_lists_jobs()` - pagination works
    - `test_error_report_download()` - CSV response
    - `test_upload_rejects_oversized_file()` - 413 response
    - `test_upload_rejects_invalid_type()` - 400 response
  - **Files**: `backend/tests/integration/test_import_api_integration.py`

### Task 65.6: Performance Tests

- [ ] Test import system with large files (1 file, ~80 LOC)
  - **Tests**: `tests/integration/test_import_performance.py`
    - `test_import_1000_rows_under_60_seconds()` - without embeddings
    - `test_memory_stable_during_large_import()` - no memory leak
    - `test_progress_updates_regularly()` - UI responsiveness
    - `test_batch_commits_work()` - partial data visible
    - `test_concurrent_imports_isolated()` - multiple jobs
  - **Files**: `backend/tests/integration/test_import_performance.py`
  - **Note**: Use `@pytest.mark.slow` for CI configuration

### Task 65.7: Edge Case Tests

- [ ] Test parser and validation edge cases (1 file, ~100 LOC)
  - **Tests**: `tests/integration/test_import_edge_cases.py`
    - `test_empty_file()` - appropriate error
    - `test_file_with_only_headers()` - CSV with no data rows
    - `test_file_with_empty_rows()` - blank lines skipped
    - `test_extremely_long_question()` - truncation or error
    - `test_extremely_long_answer()` - truncation or error
    - `test_special_characters()` - quotes, newlines, unicode
    - `test_html_in_content()` - stripped or escaped
    - `test_duplicate_headers_csv()` - appropriate handling
  - **Files**: `backend/tests/integration/test_import_edge_cases.py`

---

## 3. Success Criteria

- [ ] All parsers tested with real fixture files
- [ ] Validation pipeline tested end-to-end
- [ ] Complete import flow verified with DB assertions
- [ ] API endpoints tested with actual file uploads
- [ ] 1000-row import completes in under 60 seconds
- [ ] Memory stable during large imports
- [ ] Edge cases handled gracefully
- [ ] All tests pass: `pytest tests/integration/test_import*.py -v`
- [ ] Integration test coverage contributes to â‰¥80% overall
