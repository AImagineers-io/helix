# P75: Event Emission

## 1. Objective

**What**: Emit ObservabilityEvents throughout the chat pipeline. Each processor step records timing and payload.

**Why**: Debugging production issues requires tracing message flow. Events enable real-time monitoring and post-mortem analysis.

**Scope**:
- Included: EventEmitter service, pipeline integration, event types
- Excluded: SSE streaming endpoint, dashboard UI

**Depends on**: P73 (ObservabilityEvent model)

## 2. Implementation Tasks

- [ ] EventEmitter service (2 files, ~80 LOC)
  - Tests: tests/unit/test_event_emitter.py
  - Files: services/event_emitter.py, services/__init__.py
  - Methods: emit(), emit_async(), get_events_by_conversation()
  - Event types: message_received, intent_classified, retrieval_complete, llm_started, llm_complete, response_sent, error_occurred

- [ ] Correlation ID middleware (2 files, ~40 LOC)
  - Tests: tests/unit/test_correlation_middleware.py
  - Files: core/middleware.py, core/context.py
  - Generate UUID per request, store in context var

- [ ] Pipeline event integration (3 files, ~100 LOC)
  - Tests: tests/integration/test_pipeline_events.py
  - Files: services/chat/orchestrator.py, services/chat/processors/base.py, services/event_emitter.py
  - Depends on: P75.1, P75.2
  - Emit events at pipeline entry, each processor, pipeline exit

- [ ] Error event emission (1 file, ~30 LOC)
  - Tests: tests/integration/test_error_events.py
  - Files: services/event_emitter.py
  - Depends on: P75.3
  - Emit error_occurred with stack trace (sanitized)

## 3. Success Criteria

- [ ] Every chat request creates message_received event
- [ ] Every processor step creates corresponding event
- [ ] Events include correlation_id linking full trace
- [ ] Events include duration_ms for performance analysis
- [ ] Error scenarios emit error_occurred event
- [ ] Event emission does not slow down response (async write)
- [ ] All integration tests pass
