# P74: Analytics Service - Real Data

## 1. Objective

**What**: Update AnalyticsService to query real CostRecord and Conversation data. Add provider cost breakdown.

**Why**: Current service returns placeholders for QA stats and provider breakdown. Dashboard needs real data.

**Scope**:
- Included: AnalyticsService updates, cost breakdown by provider, CostRecordRepository
- Excluded: Event streaming, aggregation jobs, dashboard frontend

**Depends on**: P73 (data models)

## 2. Implementation Tasks

- [ ] CostRecordRepository (2 files, ~100 LOC)
  - Tests: tests/unit/test_cost_record_repository.py
  - Files: repositories/cost_record_repository.py, repositories/__init__.py
  - Methods: create(), get_by_date_range(), sum_by_provider(), sum_by_model()

- [ ] Update AnalyticsService cost methods (1 file, ~60 LOC)
  - Tests: tests/integration/test_analytics_cost_breakdown.py
  - Files: services/analytics_service.py
  - Depends on: P74.1
  - Update _get_cost_summary() to query CostRecord by provider

- [ ] ConversationRepository (2 files, ~80 LOC)
  - Tests: tests/unit/test_conversation_repository.py
  - Files: repositories/conversation_repository.py, repositories/__init__.py
  - Methods: count_by_date_range(), count_today(), count_this_week()

- [ ] Update AnalyticsService conversation methods (1 file, ~40 LOC)
  - Tests: tests/integration/test_analytics_conversation_stats.py
  - Files: services/analytics_service.py
  - Depends on: P74.3
  - Update _get_conversation_stats() to use ConversationRepository as primary source

- [ ] Cost tracking integration (2 files, ~50 LOC)
  - Tests: tests/integration/test_cost_tracking_flow.py
  - Files: services/llm_service.py, services/cost_service.py
  - Depends on: P74.1
  - Record CostRecord after each LLM call

## 3. Success Criteria

- [ ] GET /analytics/summary returns real provider cost breakdown
- [ ] Cost breakdown matches sum of CostRecord entries
- [ ] Conversation stats match actual Conversation table counts
- [ ] All integration tests pass
- [ ] Unit test coverage >= 80% for new code
