# P84: Improvement Plan for P78.md

## What's Weak / Missing

### Error Handling Gaps
- No error boundary specification for API failures
- Missing retry behavior for failed requests
- No specification for partial data scenarios (some APIs fail, others succeed)
- No offline handling strategy

### Data Freshness Gaps
- No stale-while-revalidate strategy
- Missing data refresh interval specification
- No indication to user when data is stale
- No cache invalidation on user action

### UX Gaps
- No debouncing for date range filter changes
- Loading state granularity undefined (per-widget vs page-level)
- No skeleton loader specification
- No accessibility (a11y) considerations for loading/error states

### Testing Gaps
- Only component tests mentioned - no E2E tests
- Missing network error scenario tests
- No visual regression testing
- No performance budget specified

### Baseline Gaps
- "Existing dashboard components" not inventoried
- "Remove mock data" - unclear where mocks currently reside
- No feature flag for gradual rollout

## Why This Matters

Users staring at infinite spinners or cryptic errors lose trust in the dashboard. Without debouncing, rapid filter changes flood the API. Without stale-while-revalidate, every navigation triggers full reload delays. Missing E2E tests mean integration bugs ship to production. Accessibility gaps exclude users with disabilities.

## Proposed Improvements

### 1. Define Error Handling Strategy

Add new task:
- [ ] Dashboard error boundaries (2 files, ~60 LOC)
  - Tests: tests/components/ErrorBoundary.test.tsx
  - Files: src/components/common/ErrorBoundary.tsx, src/components/common/APIErrorFallback.tsx
  - Behavior:
    - API 4xx: Show "Invalid request" with retry button
    - API 5xx: Show "Server error, retrying..." with auto-retry
    - Network error: Show "Connection lost" with manual retry
    - Partial failure: Show available data + error indicator for failed widgets

Add success criteria:
- [ ] API failure in one widget doesn't crash entire dashboard
- [ ] Error messages are user-friendly (no technical jargon)
- [ ] All error states have retry mechanism

### 2. Add Data Freshness Strategy

Update Task 1 (Analytics API hooks):
```typescript
// Stale-while-revalidate configuration
const SWR_CONFIG = {
  revalidateOnFocus: true,
  revalidateOnReconnect: true,
  refreshInterval: 60_000,  // 1 minute for dashboard
  dedupingInterval: 5_000,  // Dedupe rapid requests
};

// Hook returns freshness indicator
interface AnalyticsResult<T> {
  data: T | undefined;
  error: Error | undefined;
  isLoading: boolean;
  isStale: boolean;      // True if showing cached data while fetching
  lastUpdated: Date;     // For "Updated 2 minutes ago" display
}
```

Add success criteria:
- [ ] Dashboard shows cached data immediately on navigation
- [ ] Fresh data replaces cached data without flash
- [ ] "Last updated" timestamp visible on dashboard

### 3. Add Debouncing

Update Task 4 (Date range filter):
```typescript
// Debounce filter changes
const DEBOUNCE_MS = 300;

// Only trigger API call after user stops changing filter
const debouncedDateRange = useDebouncedValue(dateRange, DEBOUNCE_MS);

useEffect(() => {
  fetchAnalytics(debouncedDateRange);
}, [debouncedDateRange]);
```

Add success criterion:
- [ ] Rapid date range changes result in single API call (after 300ms pause)

### 4. Define Loading State Granularity

Update Task 5 (Loading and empty states):
```markdown
Loading State Strategy:
- Initial page load: Full-page skeleton (all widgets)
- Filter change: Per-widget loading overlays (preserve previous data)
- Refresh: Subtle indicator only (data visible throughout)

Skeleton Specifications:
- StatsCard: Gray box with pulsing animation, matches card dimensions
- CostWidget: Bar chart skeleton with 5 animated bars
- EventStreamPanel: 3 line-item skeletons with avatar placeholders
```

Add success criteria:
- [ ] Page skeleton shows within 100ms of navigation
- [ ] Previous data remains visible during filter changes
- [ ] Skeleton dimensions match actual component dimensions (no layout shift)

### 5. Add Accessibility Requirements

Add to Task 5:
```markdown
Accessibility Requirements:
- Loading states: aria-busy="true" on loading containers
- Empty states: Role="status" with descriptive message
- Error states: Role="alert" with error message
- Focus management: Return focus to trigger after modal/error dismiss
- Screen reader: Announce data updates ("Dashboard updated")
```

Add success criteria:
- [ ] All loading/empty/error states pass WCAG 2.1 AA
- [ ] Screen reader announces significant state changes
- [ ] Keyboard navigation works for all interactive elements

### 6. Add E2E Tests

Add new task:
- [ ] Dashboard E2E tests (2 files, ~100 LOC)
  - Tests: tests/e2e/dashboard.spec.ts
  - Files: tests/e2e/fixtures/dashboard-fixtures.ts
  - Scenarios:
    - Load dashboard with data
    - Load dashboard with no data (empty state)
    - Change date filter and verify update
    - API error shows error state
    - Event stream connects and displays events

Add success criteria:
- [ ] E2E tests run in CI pipeline
- [ ] E2E tests cover happy path + error scenarios
- [ ] E2E tests complete in < 60 seconds

### 7. Document Component Baseline

Add to section 1 (Objective):
```markdown
**Existing Components Inventory**:
- src/components/dashboard/StatsCard.tsx - Shows hardcoded "1,234" values
- src/components/dashboard/CostWidget.tsx - Shows "$0.00" placeholder
- src/components/dashboard/ConversationChart.tsx - Empty chart
- src/pages/Dashboard.tsx - Renders above with mock data from src/mocks/

**Mock Data Location**:
- src/mocks/analytics.ts - Mock data factory
- src/mocks/handlers.ts - MSW handlers returning mocks

**Removal Strategy**:
- Keep MSW handlers for testing (component tests use mocks)
- Remove hardcoded values from components
- Delete src/mocks/analytics.ts after E2E tests pass with real data
```

### 8. Add Feature Flag for Rollout

Add new task:
- [ ] Dashboard feature flag (2 files, ~40 LOC)
  - Tests: tests/components/FeatureFlag.test.tsx
  - Files: src/hooks/useFeatureFlag.ts, src/config/features.ts
  - Flag: `DASHBOARD_REAL_DATA` (default: false in dev, true in staging)
  - Behavior: When false, use mock data; when true, use real API

Add success criteria:
- [ ] Feature flag toggleable without code deployment
- [ ] Dashboard works with both mock and real data
- [ ] Flag can be set per-environment

### 9. Add Performance Budget

Add success criteria:
- [ ] Dashboard initial load: < 2 seconds (First Contentful Paint)
- [ ] Dashboard interactive: < 3 seconds (Time to Interactive)
- [ ] Filter change to data update: < 1 second
- [ ] Event stream first event: < 500ms after page load
- [ ] Bundle size impact: < 50KB added to dashboard route

### 10. Add Event Stream Reconnection

Update Task 6 (Event stream panel):
```typescript
// Reconnection strategy
const useEventStream = () => {
  const reconnectAttempts = useRef(0);
  const MAX_RECONNECT_ATTEMPTS = 5;
  const RECONNECT_DELAY_MS = [1000, 2000, 4000, 8000, 16000]; // Exponential backoff

  const connect = () => {
    const eventSource = new EventSource('/observability/events/stream', {
      headers: { 'X-API-Key': apiKey }
    });

    eventSource.onerror = () => {
      if (reconnectAttempts.current < MAX_RECONNECT_ATTEMPTS) {
        setTimeout(connect, RECONNECT_DELAY_MS[reconnectAttempts.current]);
        reconnectAttempts.current++;
      } else {
        setError('Connection lost. Please refresh the page.');
      }
    };
  };
};
```

Add success criterion:
- [ ] Event stream reconnects automatically on disconnect (up to 5 times)
- [ ] User sees "Reconnecting..." indicator during reconnection attempts
- [ ] After max attempts, user sees error with manual refresh option

## Impact on Roadmap

- **P76** SSE endpoint must support reconnection protocol for Task 10
- **P74** analytics API must support conditional requests (ETag/If-None-Match) for efficient revalidation
- Add P90: "Dashboard Visual Regression Tests" - Chromatic or Percy integration
- Add P91: "Dashboard Performance Monitoring" - RUM integration (Sentry, DataDog)
