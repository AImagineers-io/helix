# Improvement Plan for P49e.md

## What's Weak / Missing

- No configuration versioning strategy - config changes break old widgets
- Missing cache invalidation mechanism - stale config persists
- No A/B testing or gradual rollout support - all-or-nothing deployments
- Missing analytics integration - no visibility into widget usage
- No load testing specifications - unknown capacity limits
- Missing security testing (XSS, injection) - vulnerability risks
- No browser compatibility matrix defined - unclear support scope
- Missing performance benchmarking baseline - can't detect regressions
- No widget error reporting to backend - silent client failures
- Missing rate limit handling in tests - incomplete coverage

## Why This Matters

Without config versioning, widget updates require coordinated client updates. Missing analytics means no data on actual usage patterns. No security testing leaves XSS vulnerabilities undiscovered. Without performance baselines, regressions go unnoticed until users complain.

## Proposed Improvements

### Task 58.1: Add Configuration Versioning

- [ ] Version config schema with backward compatibility (2 files, ~70 LOC)
  - **Tests**: `backend/tests/integration/test_widget_config_versioning.py`
    - `test_config_includes_version()` - version field present
    - `test_old_widget_gets_compatible_config()` - ?v=1 param
    - `test_new_fields_absent_for_old_versions()` - no breaks
    - `test_deprecation_warning_for_old_versions()` - upgrade nudge
  - **Files**:
    - `backend/api/routers/widget.py` (extend)
    - `backend/schemas/widget.py` (extend)
  - **API**: `GET /widget/config?v=2`

### Task 58.2: Add Cache Control Headers

- [ ] Proper HTTP caching with invalidation (1 file, ~40 LOC)
  - **Tests**: `backend/tests/integration/test_widget_caching.py`
    - `test_config_has_etag()` - ETag header present
    - `test_304_on_unchanged()` - If-None-Match works
    - `test_cache_control_1_hour()` - max-age=3600
    - `test_stale_while_revalidate()` - background refresh
  - **Files**:
    - `backend/api/routers/widget.py` (extend)
  - **Headers**:
    - `Cache-Control: public, max-age=3600, stale-while-revalidate=86400`
    - `ETag: "config-hash"`

### Task 58.3: Add Widget Analytics Events

- [ ] Track widget usage metrics (3 files, ~120 LOC)
  - **Tests**: `backend/tests/integration/test_widget_analytics.py`
    - `test_tracks_widget_load()` - init event recorded
    - `test_tracks_conversation_start()` - first message event
    - `test_tracks_message_sent()` - message count
    - `test_tracks_widget_dismissed()` - close event
    - `test_respects_do_not_track()` - DNT header honored
  - **Files**:
    - `backend/api/routers/widget_analytics.py`
    - `backend/services/widget_analytics.py`
    - `frontend/src/widget/services/AnalyticsService.ts`
  - **Endpoint**: `POST /widget/analytics`
  - **Events**: `widget_loaded`, `chat_started`, `message_sent`, `widget_closed`

### Task 58.4: Add Security Test Suite

- [ ] Automated security testing for widget (1 file, ~100 LOC)
  - **Tests**: `frontend/tests/widget/security.test.ts`
    - `test_escapes_html_in_messages()` - XSS prevention
    - `test_escapes_html_in_branding()` - injection prevention
    - `test_validates_api_url_strictly()` - no javascript: urls
    - `test_csp_nonce_propagates()` - style nonce works
    - `test_no_eval_in_bundle()` - CSP compliant
    - `test_sanitizes_user_input()` - script tags stripped
  - **Files**:
    - `frontend/tests/widget/security.test.ts`
  - **Tools**: OWASP ZAP integration for CI (optional)

### Task 58.5: Define Browser Compatibility Matrix

- [ ] Document and test browser support (2 files, ~60 LOC)
  - **Tests**: `frontend/tests/widget/compatibility.test.ts`
    - `test_works_in_chrome_latest()` - primary target
    - `test_works_in_firefox_latest()` - secondary target
    - `test_works_in_safari_latest()` - Apple devices
    - `test_works_in_edge_latest()` - Windows default
    - `test_graceful_degradation_ie11()` - shows fallback
  - **Files**:
    - `frontend/tests/widget/compatibility.test.ts`
    - `docs/widget-browser-support.md`
  - **Matrix**:
    | Browser | Minimum Version | Status |
    |---------|-----------------|--------|
    | Chrome | 80+ | Full support |
    | Firefox | 78+ | Full support |
    | Safari | 14+ | Full support |
    | Edge | 80+ | Full support |
    | IE 11 | - | Fallback message |

### Task 58.6: Add Performance Benchmarks

- [ ] Establish and enforce performance baselines (2 files, ~80 LOC)
  - **Tests**: `frontend/tests/widget/performance.test.ts`
    - `test_init_time_under_100ms()` - fast initialization
    - `test_first_render_under_50ms()` - quick paint
    - `test_memory_under_5mb()` - heap limit
    - `test_no_memory_leak_on_reinit()` - stable memory
  - **Files**:
    - `frontend/tests/widget/performance.test.ts`
    - `.github/workflows/widget-perf.yml` (CI job)
  - **Baselines**:
    - Bundle parse: < 50ms
    - Init to render: < 100ms
    - Memory footprint: < 5MB
    - Message render: < 16ms (60fps)

### Task 58.7: Add Widget Error Reporting

- [ ] Report client-side errors to backend (2 files, ~70 LOC)
  - **Tests**: `frontend/tests/widget/error-reporting.test.ts`
    - `test_reports_js_errors()` - window.onerror
    - `test_reports_promise_rejections()` - unhandledrejection
    - `test_batches_error_reports()` - doesn't spam server
    - `test_includes_widget_version()` - debugging context
    - `test_respects_rate_limit()` - max 10/minute
  - **Files**:
    - `frontend/src/widget/services/ErrorReporter.ts`
    - `backend/api/routers/widget_errors.py`
  - **Endpoint**: `POST /widget/errors`

### Task 58.8: Add Load Testing Specifications

- [ ] Define capacity requirements and test approach (1 file, ~50 LOC)
  - **Tests**: `backend/tests/load/test_widget_load.py`
    - `test_100_concurrent_configs()` - config endpoint
    - `test_50_concurrent_chats()` - chat endpoint
    - `test_latency_p95_under_200ms()` - response time
  - **Files**:
    - `backend/tests/load/test_widget_load.py`
  - **Tools**: Locust or k6 for load testing
  - **Targets**:
    - /widget/config: 1000 req/s
    - /chat: 100 req/s
    - P95 latency: < 200ms

---

## Impact on Roadmap

- P49a (Bundle) must expose version for Task 58.1 compatibility
- P49c (Services) must send analytics events from Task 58.3
- P49c (Error Boundary) must use ErrorReporter from Task 58.7
- All phases must pass security tests from Task 58.4
- CI/CD pipeline must include performance benchmarks from Task 58.6
- Deployment documentation must include load capacity limits
