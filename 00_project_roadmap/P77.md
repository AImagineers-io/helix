# P77: Aggregation Jobs

## 1. Objective

**What**: Create scheduled jobs to compute DailyAggregate from raw CostRecord, Conversation, and Message data.

**Why**: Pre-aggregated data makes dashboard queries fast. Scanning raw tables for every request doesn't scale.

**Scope**:
- Included: Daily aggregation job, backfill logic, job scheduler
- Excluded: Cost alerting, weekly/monthly rollups

**Depends on**: P73 (data models), P74 (repositories)

## 2. Implementation Tasks

- [ ] AggregationService (2 files, ~120 LOC)
  - Tests: tests/unit/test_aggregation_service.py
  - Files: services/aggregation_service.py, services/__init__.py
  - Methods: compute_daily_aggregate(), backfill_missing_days()
  - Aggregates: conversation_count, message_count, avg_response_time_ms, cost_total

- [ ] Job scheduler setup (2 files, ~60 LOC)
  - Tests: tests/unit/test_job_scheduler.py
  - Files: jobs/scheduler.py, jobs/__init__.py
  - Use APScheduler for cron-like scheduling
  - Run aggregation at midnight UTC

- [ ] Aggregation job registration (1 file, ~40 LOC)
  - Tests: tests/integration/test_aggregation_job.py
  - Files: jobs/aggregation_job.py
  - Depends on: P77.1, P77.2
  - Register daily aggregation with scheduler

- [ ] Backfill command (1 file, ~50 LOC)
  - Tests: tests/integration/test_aggregation_backfill.py
  - Files: commands/backfill_aggregates.py
  - Depends on: P77.1
  - CLI: python -m commands.backfill_aggregates --from 2024-01-01 --to 2024-01-31

- [ ] Startup scheduler integration (1 file, ~20 LOC)
  - Tests: tests/integration/test_scheduler_startup.py
  - Files: api/main.py
  - Depends on: P77.2, P77.3
  - Start scheduler on application startup

## 3. Success Criteria

- [ ] DailyAggregate populated automatically at midnight
- [ ] Backfill command fills gaps correctly
- [ ] Aggregate values match raw data sums
- [ ] Job handles missing data gracefully (no errors on empty days)
- [ ] Scheduler survives app restart
- [ ] All integration tests pass
