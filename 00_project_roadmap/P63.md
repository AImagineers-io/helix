# P63: Import API Endpoints

## 1. Objective

**What**: Create REST API endpoints for uploading files, checking import status, and retrieving import history.

**Why**: The admin UI needs endpoints to initiate imports and track progress. RESTful design enables integration with other tools. Immediate job ID return enables async progress polling.

**Scope**:
- Included: Upload endpoints (CSV, JSON, text), status endpoint, history endpoint, error report download
- Excluded: Import service internals (P62), Admin UI components (P64)

**Dependencies**: P59 (ImportJob model), P62 (ImportService, background tasks)

---

## 2. Implementation Tasks

### Task 63.1: Create Import Request/Response Schemas

- [ ] Define API schemas for import endpoints (1 file, ~60 LOC)
  - **Tests**: `tests/unit/test_import_schemas.py`
    - `test_import_response_has_job_id()` - UUID returned
    - `test_import_response_has_status()` - initial status
    - `test_job_status_response_has_progress()` - processed/total
    - `test_job_status_response_has_errors()` - error list
    - `test_import_history_has_pagination()` - page/total
  - **Files**: `backend/schemas/import_schemas.py` (extend)
  - **Implementation**:
    ```python
    class ImportResponse(BaseModel):
        job_id: UUID
        status: str
        message: str

    class JobStatusResponse(BaseModel):
        job_id: UUID
        status: str
        filename: str
        source_type: str
        total_rows: int
        processed_rows: int
        success_count: int
        error_count: int
        errors: List[dict]
        started_at: Optional[datetime]
        completed_at: Optional[datetime]

    class ImportHistoryResponse(BaseModel):
        items: List[JobStatusResponse]
        total: int
        page: int
        page_size: int
    ```

### Task 63.2: Create CSV Import Endpoint

- [ ] POST endpoint for CSV file upload (2 files, ~60 LOC)
  - **Tests**: `tests/integration/test_import_api.py`
    - `test_csv_import_returns_job_id()` - 202 with job_id
    - `test_csv_import_accepts_multipart()` - file upload
    - `test_csv_import_validates_file_size()` - rejects > 10MB
    - `test_csv_import_validates_extension()` - rejects non-csv
    - `test_csv_import_starts_background_job()` - job created
  - **Files**: `backend/api/routers/import_routes.py`, `backend/api/__init__.py`
  - **Implementation**:
    ```python
    @router.post("/qa/import/csv", response_model=ImportResponse, status_code=202)
    async def import_csv(
        file: UploadFile = File(...),
        background_tasks: BackgroundTasks,
        session: Session = Depends(get_db),
    ):
        """Upload CSV file for QA import."""
        validate_file(file, max_size=10*1024*1024, extensions=[".csv"])
        content = await file.read()
        job_id = import_service.start_import(file.filename, content, "csv")
        schedule_import(background_tasks, job_id)
        return ImportResponse(job_id=job_id, status="pending", message="Import started")
    ```

### Task 63.3: Create JSON and Text Import Endpoints

- [ ] POST endpoints for JSON and text uploads (1 file, ~50 LOC)
  - **Tests**: `tests/integration/test_import_api.py`
    - `test_json_import_returns_job_id()` - 202 with job_id
    - `test_json_import_accepts_json_file()` - .json extension
    - `test_text_import_returns_job_id()` - 202 with job_id
    - `test_text_import_accepts_txt_file()` - .txt extension
  - **Files**: `backend/api/routers/import_routes.py`
  - **Implementation**:
    ```python
    @router.post("/qa/import/json", response_model=ImportResponse, status_code=202)
    async def import_json(file: UploadFile, ...):
        validate_file(file, extensions=[".json"])
        ...

    @router.post("/qa/import/text", response_model=ImportResponse, status_code=202)
    async def import_text(file: UploadFile, ...):
        validate_file(file, extensions=[".txt", ".text"])
        ...
    ```

### Task 63.4: Create Import Status Endpoint

- [ ] GET endpoint for job status polling (1 file, ~40 LOC)
  - **Tests**: `tests/integration/test_import_api.py`
    - `test_status_returns_job_details()` - full JobStatusResponse
    - `test_status_returns_404_for_unknown()` - job not found
    - `test_status_includes_progress()` - processed_rows/total_rows
    - `test_status_includes_errors()` - error details
    - `test_status_updates_during_processing()` - reflects progress
  - **Files**: `backend/api/routers/import_routes.py`
  - **Implementation**:
    ```python
    @router.get("/qa/import/{job_id}/status", response_model=JobStatusResponse)
    async def get_import_status(
        job_id: UUID,
        session: Session = Depends(get_db),
    ):
        """Get import job status and progress."""
        job = job_repository.get_by_id(job_id)
        if not job:
            raise HTTPException(404, "Import job not found")
        return JobStatusResponse.from_orm(job)
    ```

### Task 63.5: Create Import History Endpoint

- [ ] GET endpoint for listing past imports (1 file, ~50 LOC)
  - **Tests**: `tests/integration/test_import_api.py`
    - `test_history_returns_paginated_list()` - items/total/page
    - `test_history_filters_by_status()` - ?status=completed
    - `test_history_sorts_by_created_at()` - newest first
    - `test_history_respects_pagination()` - page/page_size
  - **Files**: `backend/api/routers/import_routes.py`
  - **Implementation**:
    ```python
    @router.get("/qa/import/history", response_model=ImportHistoryResponse)
    async def get_import_history(
        status: Optional[str] = None,
        page: int = 1,
        page_size: int = 20,
        session: Session = Depends(get_db),
    ):
        """List import jobs with pagination."""
    ```

### Task 63.6: Create Error Report Download

- [ ] GET endpoint for downloading error details (1 file, ~40 LOC)
  - **Tests**: `tests/integration/test_import_api.py`
    - `test_error_report_returns_csv()` - Content-Type: text/csv
    - `test_error_report_has_headers()` - row,field,message
    - `test_error_report_includes_all_errors()` - complete list
    - `test_error_report_404_for_unknown_job()` - job not found
  - **Files**: `backend/api/routers/import_routes.py`
  - **Implementation**:
    ```python
    @router.get("/qa/import/{job_id}/errors")
    async def download_error_report(
        job_id: UUID,
        session: Session = Depends(get_db),
    ):
        """Download error report as CSV."""
        job = job_repository.get_by_id(job_id)
        if not job:
            raise HTTPException(404, "Import job not found")
        csv_content = generate_error_csv(job.errors)
        return StreamingResponse(
            io.StringIO(csv_content),
            media_type="text/csv",
            headers={"Content-Disposition": f"attachment; filename=errors-{job_id}.csv"}
        )
    ```

---

## 3. Success Criteria

- [ ] CSV/JSON/text upload endpoints accept file uploads
- [ ] File validation enforces size and extension limits
- [ ] Upload returns 202 with job_id immediately
- [ ] Status endpoint returns accurate progress
- [ ] History endpoint supports filtering and pagination
- [ ] Error report downloadable as CSV
- [ ] All endpoints follow REST conventions
- [ ] All tests pass: `pytest tests/integration/test_import_api.py -v`
- [ ] Coverage â‰¥80% for import routes
