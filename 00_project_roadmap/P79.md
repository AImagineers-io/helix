# P79: Improvement Plan for P73.md

## What's Weak / Missing

### Index Strategy Gaps
- No indexes defined for Message model (conversation_id lookups will be frequent)
- No composite indexes for common query patterns (timestamp + provider, conversation_id + event_type)
- Missing partial indexes for active records only

### Data Integrity Gaps
- No ON DELETE behavior specified for FK relationships (Conversation -> Message, Conversation -> CostRecord)
- Missing cascade delete vs. SET NULL decision
- No decimal precision specification for `cost` field (financial data requires fixed precision)
- No check constraints for non-negative values (tokens, cost)

### Schema Design Gaps
- No decision on JSON vs JSONB for `payload` field (JSONB enables indexing)
- Missing specification for timestamp timezone handling
- No retention policy for high-volume tables (CostRecord, ObservabilityEvent will grow unbounded)
- No partitioning strategy mentioned for time-series data

### Model Clarity
- "Stub" terminology for Conversation/Message is unclear - creates ambiguity about future expansion
- No explicit list of which fields are optional vs required
- Missing default values specification

### Migration Safety
- No rollback testing scenario specified
- No consideration of migration performance on production data
- No disk space impact assessment for new tables

## Why This Matters

Financial data without decimal precision causes rounding errors that compound over time. Missing cascade behaviors lead to orphaned records. Unbounded growth without retention policies causes database bloat and performance degradation. Index gaps mean analytics queries will slow down as data grows. These are not future problems - they manifest within weeks of production use.

## Proposed Improvements

### 1. Add Comprehensive Index Definitions

```python
# CostRecord indexes
Index('ix_cost_record_timestamp', CostRecord.timestamp)
Index('ix_cost_record_provider_timestamp', CostRecord.provider, CostRecord.timestamp)
Index('ix_cost_record_conversation', CostRecord.conversation_id)

# ObservabilityEvent indexes
Index('ix_obs_event_conv_type', ObservabilityEvent.conversation_id, ObservabilityEvent.event_type)
Index('ix_obs_event_correlation', ObservabilityEvent.correlation_id)
Index('ix_obs_event_timestamp', ObservabilityEvent.timestamp)

# Message indexes
Index('ix_message_conversation', Message.conversation_id)
Index('ix_message_conv_created', Message.conversation_id, Message.created_at)
```

### 2. Specify FK Cascade Behaviors

- Conversation -> CostRecord: ON DELETE SET NULL (preserve cost data for billing reconciliation)
- Conversation -> ObservabilityEvent: ON DELETE CASCADE (events meaningless without conversation)
- Conversation -> Message: ON DELETE CASCADE (messages belong to conversation lifecycle)

### 3. Define Data Types with Precision

```python
# CostRecord.cost must use fixed precision
cost = Column(Numeric(10, 6), nullable=False)  # Up to 9999.999999

# token counts must be non-negative
input_tokens = Column(Integer, CheckConstraint('input_tokens >= 0'), nullable=False)
output_tokens = Column(Integer, CheckConstraint('output_tokens >= 0'), nullable=False)
```

### 4. Use JSONB for Payload

```python
# PostgreSQL JSONB enables indexing and efficient querying
payload = Column(JSONB, nullable=True)
```

### 5. Add Retention Policy Infrastructure

Add success criterion:
- [ ] `retention_days` column on each model OR global config for retention
- [ ] Index on timestamp for efficient retention job queries

### 6. Replace "Stub" with "Core"

Rename tasks:
- "Conversation model stub" -> "Conversation core model"
- "Message model stub" -> "Message core model"

Add explicit expansion note:
> These models contain required fields only. Future phases may add: metadata, tags, status fields.

### 7. Add Migration Safety Tasks

Add to Implementation Tasks:
- [ ] Migration dry-run test (apply to copy of production schema)
- [ ] Migration rollback test (verify clean down migration)
- [ ] Add migration performance estimate (< 1 second for empty tables, document for existing data)

### 8. Add Explicit Timestamp Handling

Add success criterion:
- [ ] All timestamp columns use `DateTime(timezone=True)` with UTC default
- [ ] Application code enforces UTC on all writes

## Impact on Roadmap

- **P74** must account for Numeric cost type in repository queries (SUM returns Decimal, not float)
- **P77** aggregation job must respect retention policy
- **P75** event emission must use JSONB-compatible serialization for payload
- Add new success criteria to P73: index effectiveness test (EXPLAIN ANALYZE on sample queries)
